<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"/>
<title>XPNDâ„¢ by EXPANSIVEâ„¢</title>
<style>
:root{
  --bg:#0a0a0f;--panel:#12121a;--card:#1a1a26;--border:#2a2a3e;
  --accent:#0066ff;--accent2:#00c8ff;--gold:#ffd700;
  --text:#e0e0f0;--sub:#888;--red:#ff3355;--green:#00e676;
  --meter-bg:#0d0d18;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
body{background:var(--bg);color:var(--text);font-family:'Segoe UI',system-ui,sans-serif;font-size:13px;overflow-x:hidden;}
#app{display:flex;flex-direction:column;height:100vh;max-width:480px;margin:0 auto;}
#topbar{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--panel);border-bottom:1px solid var(--border);}
#topbar .logo{font-size:16px;font-weight:900;letter-spacing:2px;background:linear-gradient(90deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
#topbar .tagline{font-size:9px;color:var(--sub);letter-spacing:1px;}
#topbar-right{display:flex;align-items:center;gap:6px;}
#sr-toggle-wrap{display:flex;align-items:center;gap:6px;}
#sr-toggle-wrap span{font-size:10px;color:var(--sub);}
#sr-switch{display:flex;border-radius:6px;overflow:hidden;border:1px solid var(--border);}
.sr-sw-btn{padding:4px 9px;font-size:10px;cursor:pointer;background:var(--panel);color:var(--sub);border:none;transition:.2s;font-weight:700;}
.sr-sw-btn.active{background:var(--accent);color:#fff;}
#sr-badge{font-size:10px;background:#ffd70020;color:var(--gold);border-radius:4px;padding:2px 6px;border:1px solid #ffd70040;}
#tabs{display:flex;background:var(--panel);border-bottom:1px solid var(--border);overflow-x:auto;}
#tabs::-webkit-scrollbar{display:none;}
.tab{flex-shrink:0;padding:9px 10px;text-align:center;font-size:11px;cursor:pointer;color:var(--sub);border-bottom:2px solid transparent;transition:.2s;}
.tab.active{color:var(--accent2);border-bottom-color:var(--accent2);}
#content{flex:1;overflow-y:auto;padding:12px;}
.tab-content{display:none;flex-direction:column;gap:10px;}
.tab-content.active{display:flex;}

/* SR SWITCHING TOAST */
#sr-toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:var(--accent);color:#fff;border-radius:20px;padding:8px 18px;font-size:12px;font-weight:700;z-index:200;opacity:0;transition:opacity .3s;pointer-events:none;}
#sr-toast.show{opacity:1;}

/* PERMISSION MODAL */
.modal{position:fixed;inset:0;background:#000000cc;z-index:100;display:none;align-items:center;justify-content:center;}
.modal.open{display:flex;}
.modal-box{background:var(--card);border-radius:14px;padding:22px;width:300px;border:1px solid var(--border);}
.modal-box h3{font-size:15px;margin-bottom:10px;text-align:center;}
.modal-box p{font-size:12px;color:var(--sub);line-height:1.6;margin-bottom:14px;text-align:center;}
.modal-btn{width:100%;border:none;border-radius:8px;padding:12px;cursor:pointer;font-size:13px;font-weight:700;margin-bottom:8px;}
.modal-btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;}
.modal-btn.secondary{background:var(--border);color:var(--text);}

/* PLAYER */
#track-art{width:100%;aspect-ratio:1;background:var(--card);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:60px;position:relative;overflow:hidden;}
#track-art canvas#viz{position:absolute;bottom:0;left:0;width:100%;height:60px;}
#track-info{text-align:center;}
#track-title{font-size:16px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
#track-artist{font-size:12px;color:var(--sub);margin-top:3px;}
#track-source{font-size:10px;color:var(--accent);margin-top:2px;}
#seek-bar input{width:100%;-webkit-appearance:none;height:4px;border-radius:2px;background:var(--border);outline:none;}
#seek-bar input::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:var(--accent2);cursor:pointer;}
#time-row{display:flex;justify-content:space-between;font-size:10px;color:var(--sub);margin-top:2px;}
#controls{display:flex;align-items:center;justify-content:center;gap:16px;}
.ctrl-btn{background:none;border:none;color:var(--text);font-size:22px;cursor:pointer;padding:6px;}
.ctrl-btn.primary{width:52px;height:52px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));font-size:26px;display:flex;align-items:center;justify-content:center;}
.ctrl-btn.active{color:var(--accent2);}
#vol-row{display:flex;align-items:center;gap:8px;}
#vol-row span{font-size:14px;color:var(--sub);}
#vol-row input{flex:1;-webkit-appearance:none;height:4px;border-radius:2px;background:var(--border);}
#vol-row input::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:var(--accent);}

/* STREAMING */
.stream-service{background:var(--card);border-radius:10px;padding:14px;display:flex;align-items:center;gap:12px;cursor:pointer;border:1px solid var(--border);transition:.2s;}
.stream-service:active{opacity:.7;}
.stream-icon{width:42px;height:42px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;}
.stream-info{flex:1;}
.stream-name{font-weight:700;font-size:14px;}
.stream-desc{font-size:11px;color:var(--sub);margin-top:2px;}
.stream-status{font-size:11px;padding:3px 8px;border-radius:10px;}
.stream-status.connected{background:#00e67620;color:var(--green);}
.stream-status.disconnected{background:#ff335520;color:var(--red);}
#stream-warning{background:#ff335510;border:1px solid #ff335540;border-radius:8px;padding:10px;font-size:11px;color:#ff8888;line-height:1.5;}

/* DOLBY TOOLS */
.tool-card{background:var(--card);border-radius:10px;padding:12px;border:1px solid var(--border);}
.tool-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
.tool-title{font-weight:700;font-size:13px;}
.toggle{width:40px;height:22px;border-radius:11px;background:var(--border);position:relative;cursor:pointer;transition:.2s;flex-shrink:0;}
.toggle.on{background:var(--accent);}
.toggle::after{content:'';position:absolute;width:18px;height:18px;border-radius:50%;background:#fff;top:2px;left:2px;transition:.2s;}
.toggle.on::after{left:20px;}
.slider-row{display:flex;align-items:center;gap:8px;margin-top:6px;}
.slider-label{font-size:11px;color:var(--sub);width:60px;flex-shrink:0;}
.slider-val{font-size:11px;color:var(--accent2);width:28px;text-align:right;flex-shrink:0;}
input[type=range].tool-slider{flex:1;-webkit-appearance:none;height:4px;border-radius:2px;background:var(--border);}
input[type=range].tool-slider::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:var(--accent2);cursor:pointer;}
.style-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-top:8px;}
.style-btn{background:var(--panel);border:1px solid var(--border);border-radius:6px;padding:7px 4px;text-align:center;font-size:11px;cursor:pointer;color:var(--sub);transition:.2s;}
.style-btn.active{background:var(--accent);border-color:var(--accent);color:#fff;}

/* ATMOS */
.atmos-modes{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;}
.atmos-btn{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:10px 4px;text-align:center;font-size:11px;cursor:pointer;color:var(--sub);transition:.2s;}
.atmos-btn.active{background:linear-gradient(135deg,#0033aa,#0066ff);border-color:var(--accent);color:#fff;}
#spatial-mode-row{display:flex;align-items:center;justify-content:space-between;background:var(--panel);border-radius:8px;padding:10px 12px;border:1px solid var(--border);}
#spatial-mode-label{font-size:12px;}
#spatial-mode-label span{display:block;font-size:10px;color:var(--sub);margin-top:2px;}
#spatial-mode-switch{display:flex;border-radius:8px;overflow:hidden;border:1px solid var(--border);}
.spatial-sw-btn{padding:6px 12px;font-size:11px;cursor:pointer;background:var(--panel);color:var(--sub);border:none;}
.spatial-sw-btn.active{background:var(--accent);color:#fff;}
#ch-meters{display:grid;grid-template-columns:repeat(5,1fr);gap:4px;background:var(--meter-bg);border-radius:10px;padding:10px;}
.ch-meter{display:flex;flex-direction:column;align-items:center;gap:3px;}
.ch-meter-bar-wrap{width:12px;height:60px;background:var(--border);border-radius:3px;overflow:hidden;display:flex;flex-direction:column;justify-content:flex-end;}
.ch-meter-bar{width:100%;background:linear-gradient(0deg,var(--green),#ffeb3b,var(--red));border-radius:3px;transition:height .05s;}
.ch-meter-label{font-size:9px;color:var(--sub);}
.ch-meter-db{font-size:9px;color:var(--text);}
#spatial-info{font-size:11px;color:var(--sub);text-align:center;padding:6px;background:var(--panel);border-radius:8px;}

/* PEQ */
#peq-canvas{width:100%;height:160px;background:var(--card);border-radius:10px;border:1px solid var(--border);cursor:crosshair;touch-action:none;}
#peq-bands{display:flex;flex-direction:column;gap:6px;}
.peq-band{background:var(--card);border-radius:8px;padding:10px;border:1px solid var(--border);}
.peq-band-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;}
.peq-band-num{font-size:11px;color:var(--accent2);font-weight:700;}
.peq-type-sel{background:var(--panel);border:1px solid var(--border);color:var(--text);border-radius:4px;font-size:11px;padding:2px 4px;}
.rm-band{background:none;border:none;color:var(--red);font-size:16px;cursor:pointer;padding:0 4px;}
#add-band-btn{background:var(--accent);border:none;color:#fff;border-radius:8px;padding:10px;width:100%;cursor:pointer;font-size:13px;font-weight:700;}

/* LIBRARY */
#search-bar{width:100%;background:var(--card);border:1px solid var(--border);border-radius:8px;padding:10px 12px;color:var(--text);font-size:13px;outline:none;}
#search-bar::placeholder{color:var(--sub);}
#lib-stats{font-size:11px;color:var(--sub);text-align:center;}
.lib-action-row{display:flex;gap:8px;}
.lib-action-btn{flex:1;background:var(--card);border:1px solid var(--border);color:var(--text);border-radius:8px;padding:10px;cursor:pointer;font-size:12px;text-align:center;}
.lib-action-btn:active{opacity:.7;}
#drop-zone{border:2px dashed var(--border);border-radius:12px;padding:20px;text-align:center;color:var(--sub);cursor:pointer;transition:.2s;}
#drop-zone.drag-over{border-color:var(--accent);background:#0066ff10;}
#drop-zone p{margin-top:6px;font-size:12px;}
#lib-list{display:flex;flex-direction:column;gap:6px;}
.lib-folder{background:var(--card);border-radius:8px;overflow:hidden;border:1px solid var(--border);}
.lib-folder-header{padding:10px 12px;font-weight:700;font-size:13px;display:flex;justify-content:space-between;cursor:pointer;align-items:center;}
.lib-folder-count{font-size:11px;color:var(--sub);}
.lib-track{padding:8px 14px;border-top:1px solid var(--border);cursor:pointer;display:flex;align-items:center;gap:8px;}
.lib-track:active{background:#ffffff08;}
.lib-track.playing{color:var(--accent2);}
.lib-track-num{font-size:11px;color:var(--sub);width:22px;flex-shrink:0;text-align:right;}
.lib-track-name{font-size:12px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;}
.lib-track-play{background:none;border:none;color:var(--sub);font-size:14px;cursor:pointer;padding:0 4px;flex-shrink:0;}
.lib-track.playing .lib-track-play{color:var(--accent2);}

/* EXPORT */
.export-info{background:var(--card);border-radius:10px;padding:14px;border:1px solid var(--border);}
.export-row{display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid var(--border);font-size:12px;}
.export-row:last-child{border-bottom:none;}
.export-val{color:var(--accent2);font-weight:700;}
#export-btn{background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;color:#fff;border-radius:10px;padding:16px;width:100%;cursor:pointer;font-size:15px;font-weight:700;}
#export-btn:disabled{opacity:.4;cursor:not-allowed;}
#export-progress{background:var(--card);border-radius:10px;padding:14px;display:none;}
#export-progress-bar-wrap{background:var(--border);border-radius:4px;height:8px;overflow:hidden;margin-top:8px;}
#export-progress-bar{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));width:0%;transition:width .3s;}
</style>
</head>
<body>
<div id="app">
  <div id="topbar">
    <div>
      <div class="logo">XPNDâ„¢</div>
      <div class="tagline">BY EXPANSIVEâ„¢</div>
    </div>
    <div id="topbar-right">
      <div id="sr-toggle-wrap">
        <div id="sr-switch">
          <button class="sr-sw-btn active" data-sr="384000">384k</button>
          <button class="sr-sw-btn" data-sr="192000">192k</button>
        </div>
      </div>
      <div id="sr-badge">384kHz</div>
    </div>
  </div>
  <div id="tabs">
    <div class="tab active" data-tab="player">â–¶ Player</div>
    <div class="tab" data-tab="streaming">â˜ Stream</div>
    <div class="tab" data-tab="dolby">ğŸ› Dolby</div>
    <div class="tab" data-tab="atmos">ğŸ”Š Atmos</div>
    <div class="tab" data-tab="peq">ã€° EQ</div>
    <div class="tab" data-tab="library">ğŸ“ Library</div>
    <div class="tab" data-tab="export">â¬‡ Export</div>
  </div>
  <div id="content">

    <!-- PLAYER -->
    <div id="player-panel" class="tab-content active">
      <div id="track-art">ğŸµ<canvas id="viz"></canvas></div>
      <div id="track-info">
        <div id="track-title">No Track Loaded</div>
        <div id="track-artist">â€”</div>
        <div id="track-source"></div>
      </div>
      <div id="seek-bar">
        <input type="range" id="seek" min="0" max="100" value="0" step="0.1"/>
        <div id="time-row"><span id="t-cur">0:00</span><span id="t-dur">0:00</span></div>
      </div>
      <div id="controls">
        <button class="ctrl-btn" id="shuffle-btn">â‡„</button>
        <button class="ctrl-btn" id="prev-btn">â®</button>
        <button class="ctrl-btn primary" id="play-btn">â–¶</button>
        <button class="ctrl-btn" id="next-btn">â­</button>
        <button class="ctrl-btn" id="repeat-btn">â†»</button>
      </div>
      <div id="vol-row">
        <span>ğŸ”ˆ</span>
        <input type="range" id="vol" min="0" max="1" step="0.01" value="0.8"/>
        <span>ğŸ”Š</span>
      </div>
    </div>

    <!-- STREAMING -->
    <div id="streaming-panel" class="tab-content">
      <div id="stream-warning">âš ï¸ Streaming requires OAuth tokens from each platform. Connect below â€” the app opens the platform auth page and routes playback through the Dolby DSP chain. Premium accounts required for Spotify, Tidal, and Apple Music.</div>
      <div class="stream-service" data-svc="spotify"><div class="stream-icon" style="background:#1DB95420;">ğŸµ</div><div class="stream-info"><div class="stream-name">Spotify</div><div class="stream-desc">Spotify Web Playback SDK</div></div><span class="stream-status disconnected" id="status-spotify">Connect</span></div>
      <div class="stream-service" data-svc="tidal"><div class="stream-icon" style="background:#00000060;border:1px solid #333;">ğŸŒŠ</div><div class="stream-info"><div class="stream-name">Tidal</div><div class="stream-desc">HiFi / MQA streaming</div></div><span class="stream-status disconnected" id="status-tidal">Connect</span></div>
      <div class="stream-service" data-svc="deezer"><div class="stream-icon" style="background:#a238ff20;">ğŸ¶</div><div class="stream-info"><div class="stream-name">Deezer</div><div class="stream-desc">Deezer JavaScript SDK</div></div><span class="stream-status disconnected" id="status-deezer">Connect</span></div>
      <div class="stream-service" data-svc="apple"><div class="stream-icon" style="background:#fc3c4420;">ğŸ</div><div class="stream-info"><div class="stream-name">Apple Music</div><div class="stream-desc">MusicKit JS</div></div><span class="stream-status disconnected" id="status-apple">Connect</span></div>
      <div class="stream-service" data-svc="youtube"><div class="stream-icon" style="background:#ff000020;">â–¶</div><div class="stream-info"><div class="stream-name">YouTube Music</div><div class="stream-desc">YouTube IFrame API</div></div><span class="stream-status disconnected" id="status-youtube">Connect</span></div>
    </div>

    <!-- DOLBY -->
    <div id="dolby-panel" class="tab-content">
      <div class="tool-card">
        <div class="tool-header"><span class="tool-title">ğŸ¨ Style</span></div>
        <div class="style-grid">
          <div class="style-btn active" data-style="Standard">Standard</div>
          <div class="style-btn" data-style="Amped">Amped</div>
          <div class="style-btn" data-style="Lyric">Lyric</div>
          <div class="style-btn" data-style="Deep">Deep</div>
          <div class="style-btn" data-style="Natural">Natural</div>
          <div class="style-btn" data-style="Thump">Thump</div>
          <div class="style-btn" data-style="Off">Off</div>
        </div>
        <div class="slider-row"><span class="slider-label">Intensity</span><input type="range" class="tool-slider" id="style-intensity" min="0" max="20" value="10"/><span class="slider-val" id="style-intensity-val">10</span></div>
      </div>
      <div class="tool-card">
        <div class="tool-header"><span class="tool-title">ğŸ”‡ Noise Reduction</span><div class="toggle on" id="nr-toggle"></div></div>
        <div class="slider-row"><span class="slider-label">Amount</span><input type="range" class="tool-slider" id="nr-amount" min="0" max="20" value="5"/><span class="slider-val" id="nr-amount-val">5</span></div>
      </div>
      <div class="tool-card">
        <div class="tool-header"><span class="tool-title">ğŸµ Tone</span></div>
        <div class="slider-row"><span class="slider-label">Bass</span><input type="range" class="tool-slider" id="tone-bass" min="-20" max="20" value="0"/><span class="slider-val" id="tone-bass-val">0</span></div>
        <div class="slider-row"><span class="slider-label">Mids</span><input type="range" class="tool-slider" id="tone-mids" min="-20" max="20" value="0"/><span class="slider-val" id="tone-mids-val">0</span></div>
        <div class="slider-row"><span class="slider-label">Treble</span><input type="range" class="tool-slider" id="tone-treble" min="-20" max="20" value="0"/><span class="slider-val" id="tone-treble-val">0</span></div>
      </div>
      <div class="tool-card">
        <div class="tool-header"><span class="tool-title">âš¡ Boost</span></div>
        <div class="slider-row"><span class="slider-label">Boost</span><input type="range" class="tool-slider" id="boost-val" min="0" max="20" value="0"/><span class="slider-val" id="boost-display">0</span></div>
      </div>
      <div class="tool-card">
        <div class="tool-header"><span class="tool-title">âœ¨ Brightness</span></div>
        <div class="slider-row"><span class="slider-label">Amount</span><input type="range" class="tool-slider" id="brightness-val" min="0" max="20" value="10"/><span class="slider-val" id="brightness-display">10</span></div>
        <div style="font-size:10px;color:var(--sub);margin-top:6px;">0 = dark / warm &nbsp;Â·&nbsp; 10 = neutral &nbsp;Â·&nbsp; 20 = bright / airy</div>
      </div>
    </div>

    <!-- ATMOS -->
    <div id="atmos-panel" class="tab-content">
      <div id="spatial-mode-row">
        <div id="spatial-mode-label">Spatial Output Mode<span id="spatial-mode-desc">HRTF binaural fold-down to stereo</span></div>
        <div id="spatial-mode-switch">
          <button class="spatial-sw-btn active" data-sm="emulation">Emulation</button>
          <button class="spatial-sw-btn" data-sm="real">Real 9.2.4</button>
        </div>
      </div>
      <div id="spatial-info">Stereo Emulation: all 15 channels processed through HRTF and folded down to 2-channel stereo â€” works on any headphones or speakers.</div>
      <div class="tool-card">
        <div class="tool-header"><span class="tool-title">ğŸ”Š Dolby Atmos Mode</span></div>
        <div class="atmos-modes">
          <div class="atmos-btn active" data-mode="Off">Off</div>
          <div class="atmos-btn" data-mode="Music">Music</div>
          <div class="atmos-btn" data-mode="Movie">Movie</div>
          <div class="atmos-btn" data-mode="Game">Game</div>
          <div class="atmos-btn" data-mode="Voice">Voice</div>
          <div class="atmos-btn" data-mode="FullSpatial">Full Spatial</div>
          <div class="atmos-btn" data-mode="ConcertHall">Concert Hall</div>
        </div>
      </div>
      <div class="tool-card">
        <div class="tool-header"><span class="tool-title">ğŸ“¡ 9.2.4 Channel Meters</span></div>
        <div id="ch-meters"></div>
      </div>
    </div>

    <!-- PEQ -->
    <div id="peq-panel" class="tab-content">
      <canvas id="peq-canvas" width="452" height="160"></canvas>
      <div id="peq-bands"></div>
      <button id="add-band-btn">+ Add Band</button>
    </div>

    <!-- LIBRARY -->
    <div id="library-panel" class="tab-content">
      <input type="text" id="search-bar" placeholder="ğŸ” Search tracks, folders..."/>
      <div id="lib-stats">No tracks loaded</div>
      <div class="lib-action-row">
        <button class="lib-action-btn" id="scan-device-btn">ğŸ“± Scan Device Audio</button>
        <button class="lib-action-btn" id="folder-btn">ğŸ“ Browse Folder</button>
      </div>
      <input type="file" id="folder-input" style="display:none;" multiple accept="audio/*" webkitdirectory/>
      <input type="file" id="file-input" style="display:none;" multiple accept="audio/*"/>
      <div id="drop-zone">
        <div style="font-size:32px;">ğŸ“‚</div>
        <p>Drop audio files or folders here</p>
        <p style="margin-top:4px;font-size:11px;color:var(--sub);">or use the buttons above</p>
      </div>
      <div id="lib-list"></div>
    </div>

    <!-- EXPORT -->
    <div id="export-panel" class="tab-content">
      <div class="export-info">
        <div class="export-row"><span>Format</span><span class="export-val">WAV (RIFF IEEE Float)</span></div>
        <div class="export-row"><span>Bit Depth</span><span class="export-val">32-bit Float</span></div>
        <div class="export-row"><span>Sample Rate</span><span class="export-val" id="export-sr-display">384,000 Hz</span></div>
        <div class="export-row"><span>Channels</span><span class="export-val">2 (Stereo Mixdown)</span></div>
        <div class="export-row"><span>DSP Chain</span><span class="export-val">Full (NR+Style+Tone+PEQ+Boost+Brightness)</span></div>
        <div class="export-row"><span>Track</span><span class="export-val" id="export-track-name">No Track</span></div>
      </div>
      <button id="export-btn" disabled>â¬‡ Export 32-bit WAV</button>
      <div id="export-progress">
        <div id="export-status-text">Rendering...</div>
        <div id="export-progress-bar-wrap"><div id="export-progress-bar"></div></div>
      </div>
    </div>
  </div>
</div>

<!-- PERMISSION MODAL -->
<div id="perm-modal" class="modal open">
  <div class="modal-box">
    <h3>ğŸ“± XPNDâ„¢ needs access</h3>
    <p>To display your full audio library, XPNDâ„¢ needs permission to read audio files and storage on your device.</p>
    <button class="modal-btn primary" id="perm-grant-btn">Grant Access</button>
    <button class="modal-btn secondary" id="perm-skip-btn">Skip for now</button>
  </div>
</div>

<!-- SR TOAST -->
<div id="sr-toast"></div>

<audio id="audio-el" crossorigin="anonymous"></audio>

<script>
'use strict';

const S={
  ctx:null, src:null, nrNode:null, styleNodes:[], toneNodes:{}, compNode:null,
  brightnessNode:null, masterGain:null,
  analyser:null, convolver:null, dryGain:null, wetGain:null, panners:[], mergerNode:null,
  peqNodes:[],
  srTarget:384000, srActual:384000, srSwitching:false,
  playing:false, repeat:false, shuffle:false,
  currentStyle:'Standard', styleIntensity:10,
  nrEnabled:true, nrAmount:5,
  toneVals:{bass:0,mids:0,treble:0}, boost:0, brightness:10, atmosMode:'Off',
  spatialMode:'emulation',
  peqBands:[{id:0,type:'peaking',freq:1000,gain:0,q:1}], peqIdCtr:1,
  library:{}, queue:[], queueIdx:-1, streamConnected:{},
  permissionGranted:false,
};

const AUDIO=document.getElementById('audio-el');

// â”€â”€ PERMISSIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function requestStoragePermission(){
  // Capacitor Filesystem / Android permission request
  if(typeof window.Capacitor!=='undefined'){
    const {Permissions}=window.Capacitor.Plugins;
    if(Permissions){
      Permissions.requestPermissions({permissions:['storage','photos','media']})
        .then(()=>{S.permissionGranted=true;})
        .catch(()=>{});
    }
  }
  // Web fallback â€” permissions are granted implicitly by file picker interaction
  S.permissionGranted=true;
}

document.getElementById('perm-grant-btn').onclick=()=>{
  document.getElementById('perm-modal').classList.remove('open');
  requestStoragePermission();
  // Immediately trigger device scan after granting
  setTimeout(()=>document.getElementById('file-input').click(), 300);
};
document.getElementById('perm-skip-btn').onclick=()=>{
  document.getElementById('perm-modal').classList.remove('open');
};

// â”€â”€ REAL-TIME SAMPLE RATE SWITCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(msg){
  const t=document.getElementById('sr-toast');
  t.textContent=msg;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2000);
}

async function switchSampleRate(newSr){
  if(S.srSwitching||newSr===S.srTarget)return;
  S.srSwitching=true;
  S.srTarget=newSr;

  // Update switch UI immediately
  document.querySelectorAll('.sr-sw-btn').forEach(b=>b.classList.toggle('active',parseInt(b.dataset.sr)===newSr));
  showToast(`Switching to ${newSr/1000}kHz...`);

  const wasPlaying=S.playing;
  const currentSrc=AUDIO.src;
  const currentTime=AUDIO.currentTime;

  // Pause gracefully
  if(wasPlaying){AUDIO.pause();S.playing=false;document.getElementById('play-btn').textContent='â–¶';}

  // Close old context
  if(S.ctx){
    try{await S.ctx.close();}catch(e){}
    S.ctx=null;S.src=null;
  }

  // Init new context at requested rate
  initCtx();

  // Resume playback from same position
  if(currentSrc){
    AUDIO.src=currentSrc;
    AUDIO.currentTime=currentTime;
    if(wasPlaying){
      try{
        await AUDIO.play();
        S.playing=true;
        document.getElementById('play-btn').textContent='â¸';
      }catch(e){}
    }
  }

  showToast(`Now running at ${S.srActual/1000}kHz`);
  S.srSwitching=false;
}

document.querySelectorAll('.sr-sw-btn').forEach(btn=>{
  btn.onclick=()=>switchSampleRate(parseInt(btn.dataset.sr));
});

// â”€â”€ AUDIO CONTEXT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initCtx(){
  if(S.ctx)return;
  const rates=[S.srTarget, S.srTarget===384000?192000:384000, 96000, 48000];
  for(const rate of rates){
    try{
      S.ctx=new(window.AudioContext||window.webkitAudioContext)({sampleRate:rate,latencyHint:'playback'});
      S.srActual=S.ctx.sampleRate;
      break;
    }catch(e){S.ctx=null;}
  }
  if(!S.ctx){S.ctx=new(window.AudioContext||window.webkitAudioContext)();S.srActual=S.ctx.sampleRate;}
  const label=`${(S.srActual/1000).toFixed(0)}kHz`;
  document.getElementById('sr-badge').textContent=label;
  document.getElementById('export-sr-display').textContent=`${S.srActual.toLocaleString()} Hz`;
  // Sync switch buttons to actual achieved rate
  document.querySelectorAll('.sr-sw-btn').forEach(b=>b.classList.toggle('active',parseInt(b.dataset.sr)===S.srActual));
  buildChain();startViz();startMeters();
}

// â”€â”€ DSP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STYLE_PRESETS={
  Standard:[{type:'lowshelf',freq:80,gain:2,q:1},{type:'highshelf',freq:12000,gain:1.5,q:1}],
  Amped:[{type:'lowshelf',freq:55,gain:6,q:1},{type:'peaking',freq:450,gain:-3,q:1.2},{type:'highshelf',freq:8000,gain:3,q:1}],
  Lyric:[{type:'lowshelf',freq:200,gain:-2,q:1},{type:'peaking',freq:2400,gain:4,q:1},{type:'peaking',freq:5000,gain:2.5,q:1.5}],
  Deep:[{type:'lowshelf',freq:38,gain:8,q:0.8},{type:'peaking',freq:120,gain:3,q:1},{type:'highshelf',freq:8000,gain:-2,q:1}],
  Natural:[{type:'peaking',freq:200,gain:1,q:1},{type:'peaking',freq:3000,gain:0.5,q:1}],
  Thump:[{type:'lowshelf',freq:38,gain:6,q:0.9},{type:'peaking',freq:60,gain:3,q:1.5},{type:'peaking',freq:600,gain:-2,q:1},{type:'peaking',freq:4000,gain:1.5,q:1.5}],
  Off:[],
};
const ATMOS_IR={
  Music:{dur:0.8,decay:2.8,wet:0.08},Movie:{dur:2.5,decay:2.0,wet:0.35},
  Game:{dur:0.5,decay:4.0,wet:0.12},Voice:{dur:0.25,decay:5.0,wet:0.04},
  FullSpatial:{dur:3.5,decay:1.8,wet:0.45},ConcertHall:{dur:4.0,decay:1.5,wet:0.50},
};
const CH_LAYOUT=[
  {lbl:'L',  az:-30,  el:0,  foldL:1.00,foldR:0.00},
  {lbl:'C',  az:0,    el:0,  foldL:0.50,foldR:0.50},
  {lbl:'R',  az:30,   el:0,  foldL:0.00,foldR:1.00},
  {lbl:'Ls', az:-110, el:0,  foldL:0.70,foldR:0.00},
  {lbl:'Rs', az:110,  el:0,  foldL:0.00,foldR:0.70},
  {lbl:'Lrs',az:-145, el:0,  foldL:0.50,foldR:0.00},
  {lbl:'Rrs',az:145,  el:0,  foldL:0.00,foldR:0.50},
  {lbl:'Lw', az:-60,  el:0,  foldL:0.80,foldR:0.10},
  {lbl:'Rw', az:60,   el:0,  foldL:0.10,foldR:0.80},
  {lbl:'LFE1',az:0,   el:-30,foldL:0.50,foldR:0.50},
  {lbl:'LFE2',az:0,   el:-30,foldL:0.50,foldR:0.50},
  {lbl:'LTF',az:-45,  el:45, foldL:0.70,foldR:0.10},
  {lbl:'RTF',az:45,   el:45, foldL:0.10,foldR:0.70},
  {lbl:'LTR',az:-135, el:45, foldL:0.55,foldR:0.05},
  {lbl:'RTR',az:135,  el:45, foldL:0.05,foldR:0.55},
];
function deg(d){return d*Math.PI/180;}
function buildImpulse(mode){
  const cfg=ATMOS_IR[mode];if(!cfg)return null;
  const sr=S.ctx.sampleRate,len=Math.floor(sr*cfg.dur),buf=S.ctx.createBuffer(2,len,sr);
  for(let ch=0;ch<2;ch++){const d=buf.getChannelData(ch);for(let i=0;i<len;i++)d[i]=(Math.random()*2-1)*Math.pow(1-i/len,cfg.decay);}
  return buf;
}
function buildChain(){
  const c=S.ctx;
  try{S.src=c.createMediaElementSource(AUDIO);}catch(e){}
  S.nrNode=c.createBiquadFilter();S.nrNode.type='highpass';applyNR();
  S.styleNodes=buildStyleNodes();
  S.toneNodes.bass=c.createBiquadFilter();S.toneNodes.bass.type='lowshelf';S.toneNodes.bass.frequency.value=200;
  S.toneNodes.mids=c.createBiquadFilter();S.toneNodes.mids.type='peaking';S.toneNodes.mids.frequency.value=1000;S.toneNodes.mids.Q.value=0.8;
  S.toneNodes.treble=c.createBiquadFilter();S.toneNodes.treble.type='highshelf';S.toneNodes.treble.frequency.value=5000;
  applyTone();
  S.peqNodes=buildPeqNodes();
  S.compNode=c.createDynamicsCompressor();applyBoost();
  S.brightnessNode=c.createBiquadFilter();S.brightnessNode.type='highshelf';S.brightnessNode.frequency.value=8000;applyBrightness();
  S.dryGain=c.createGain();S.wetGain=c.createGain();S.convolver=c.createConvolver();
  S.analyser=c.createAnalyser();S.analyser.fftSize=2048;S.analyser.smoothingTimeConstant=0.8;
  S.masterGain=c.createGain();S.masterGain.gain.value=parseFloat(document.getElementById('vol').value);
  wireChain();
}
function buildStyleNodes(){
  const c=S.ctx,preset=STYLE_PRESETS[S.currentStyle]||[],mult=S.styleIntensity/10;
  return preset.map(f=>{const n=c.createBiquadFilter();n.type=f.type;n.frequency.value=f.freq;n.gain.value=f.gain*mult;n.Q.value=f.q;return n;});
}
function buildPeqNodes(){
  return S.peqBands.map(b=>{const n=S.ctx.createBiquadFilter();n.type=b.type;n.frequency.value=Math.max(3,Math.min(b.freq,45000));n.gain.value=b.gain;n.Q.value=b.q;return n;});
}
function wireChain(){
  const c=S.ctx,cn=(a,b)=>{try{a.connect(b);}catch(e){}};
  let node=S.src;
  cn(node,S.nrNode);node=S.nrNode;
  for(const s of S.styleNodes){cn(node,s);node=s;}
  cn(node,S.toneNodes.bass);cn(S.toneNodes.bass,S.toneNodes.mids);cn(S.toneNodes.mids,S.toneNodes.treble);node=S.toneNodes.treble;
  for(const p of S.peqNodes){cn(node,p);node=p;}
  cn(node,S.compNode);node=S.compNode;
  cn(node,S.brightnessNode);node=S.brightnessNode;
  if(S.atmosMode!=='Off'){
    const cfg=ATMOS_IR[S.atmosMode];
    S.dryGain.gain.value=1-cfg.wet;S.wetGain.gain.value=cfg.wet;
    const ir=buildImpulse(S.atmosMode);if(ir)S.convolver.buffer=ir;
    cn(node,S.dryGain);cn(node,S.convolver);cn(S.convolver,S.wetGain);
    const mix=c.createGain();cn(S.dryGain,mix);cn(S.wetGain,mix);
    if(S.spatialMode==='emulation'){
      const merger=c.createChannelMerger(2);S.mergerNode=merger;
      S.panners=CH_LAYOUT.map(ch=>{
        const p=c.createPanner();p.panningModel='HRTF';p.distanceModel='inverse';p.rolloffFactor=1;
        p.coneInnerAngle=360;p.coneOuterAngle=360;p.coneOuterGain=0;
        const az=deg(ch.az),el=deg(ch.el);
        p.setPosition(Math.cos(el)*Math.sin(az),Math.sin(el),-Math.cos(el)*Math.cos(az));
        const gL=c.createGain();gL.gain.value=ch.foldL;
        const gR=c.createGain();gR.gain.value=ch.foldR;
        cn(mix,p);cn(p,gL);cn(p,gR);cn(gL,merger,0,0);cn(gR,merger,0,1);
        return p;
      });
      cn(merger,S.analyser);
    }else{
      S.mergerNode=null;
      S.panners=CH_LAYOUT.map(ch=>{
        const p=c.createPanner();p.panningModel='HRTF';p.distanceModel='inverse';p.rolloffFactor=1;
        p.coneInnerAngle=360;p.coneOuterAngle=360;p.coneOuterGain=0;
        const az=deg(ch.az),el=deg(ch.el);
        p.setPosition(Math.cos(el)*Math.sin(az),Math.sin(el),-Math.cos(el)*Math.cos(az));
        cn(mix,p);cn(p,S.analyser);return p;
      });
    }
  }else{cn(node,S.analyser);}
  cn(S.analyser,S.masterGain);cn(S.masterGain,c.destination);
}
function rewire(){
  [S.src,S.nrNode,...S.styleNodes,...Object.values(S.toneNodes),...S.peqNodes,
   S.compNode,S.brightnessNode,S.dryGain,S.wetGain,S.convolver,S.mergerNode,...S.panners,S.analyser,S.masterGain]
    .forEach(n=>{try{if(n)n.disconnect();}catch(e){}});
  wireChain();
}
function rebuildStyleNodes(){S.styleNodes=buildStyleNodes();rewire();}
function rebuildPeqNodes(){S.peqNodes=buildPeqNodes();rewire();}
function applyNR(){if(!S.nrNode)return;S.nrNode.frequency.value=S.nrEnabled?(20+180*S.nrAmount/20):3;S.nrNode.Q.value=S.nrEnabled?(0.6+1.8*S.nrAmount/20):0.6;}
function applyTone(){if(!S.toneNodes.bass)return;S.toneNodes.bass.gain.value=S.toneVals.bass*0.75;S.toneNodes.mids.gain.value=S.toneVals.mids*0.75;S.toneNodes.treble.gain.value=S.toneVals.treble*0.75;}
function applyBrightness(){if(!S.brightnessNode)return;S.brightnessNode.gain.value=(S.brightness-10)*0.9;}
function applyBoost(){
  if(!S.compNode)return;
  const b=S.boost;
  S.compNode.threshold.value=-44+(24*b/20);S.compNode.ratio.value=3+(17*b/20);
  S.compNode.knee.value=30-(22*b/20);S.compNode.release.value=(300-180*b/20)/1000;
  if(S.masterGain)S.masterGain.gain.value=(0.55+0.85*b/20)*parseFloat(document.getElementById('vol').value);
}

// â”€â”€ SPATIAL MODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.spatial-sw-btn').forEach(btn=>{
  btn.onclick=()=>{
    S.spatialMode=btn.dataset.sm;
    document.querySelectorAll('.spatial-sw-btn').forEach(b=>b.classList.toggle('active',b.dataset.sm===S.spatialMode));
    const info=document.getElementById('spatial-info');
    if(S.spatialMode==='emulation'){
      info.textContent='Stereo Emulation: all 15 channels processed through HRTF and folded down to 2-channel stereo â€” works on any headphones or speakers.';
      document.getElementById('spatial-mode-desc').textContent='HRTF binaural fold-down to stereo';
    }else{
      info.textContent='Real 9.2.4: full 15-channel distribution â€” requires a physical 9.2.4 surround sound system connected to your device.';
      document.getElementById('spatial-mode-desc').textContent='Full 15-channel hardware distribution';
    }
    if(S.ctx&&S.atmosMode!=='Off')rewire();
  };
});

// â”€â”€ VISUALIZER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const vizCanvas=document.getElementById('viz');
const vizCtx=vizCanvas.getContext('2d');
function startViz(){
  function draw(){
    requestAnimationFrame(draw);if(!S.analyser)return;
    const W=vizCanvas.offsetWidth,H=60;vizCanvas.width=W;vizCanvas.height=H;
    const buf=new Uint8Array(S.analyser.frequencyBinCount);S.analyser.getByteFrequencyData(buf);
    vizCtx.clearRect(0,0,W,H);
    const bw=W/(buf.length*0.6);
    const grad=vizCtx.createLinearGradient(0,0,0,H);
    grad.addColorStop(0,'#00c8ff88');grad.addColorStop(1,'#0066ff22');
    vizCtx.fillStyle=grad;
    for(let i=0;i<buf.length*0.6;i++){const h=(buf[i]/255)*H;vizCtx.fillRect(i*bw,H-h,bw-1,h);}
  }
  draw();
}

// â”€â”€ CHANNEL METERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const meterBars=[];
function buildMeterUI(){
  const cont=document.getElementById('ch-meters');cont.innerHTML='';
  CH_LAYOUT.forEach(ch=>{
    const wrap=document.createElement('div');wrap.className='ch-meter';
    wrap.innerHTML=`<div class="ch-meter-bar-wrap"><div class="ch-meter-bar" style="height:0%"></div></div><div class="ch-meter-label">${ch.lbl}</div><div class="ch-meter-db">-âˆ</div>`;
    cont.appendChild(wrap);
    meterBars.push({bar:wrap.querySelector('.ch-meter-bar'),db:wrap.querySelector('.ch-meter-db')});
  });
}
function startMeters(){
  const BIN_RANGES=CH_LAYOUT.map(ch=>{
    if(ch.lbl.startsWith('LFE'))return[0,4];
    if(ch.el>0)return[40,120];
    const az=Math.abs(ch.az),lo=Math.floor(4+az/180*100);return[lo,lo+30];
  });
  function update(){
    requestAnimationFrame(update);if(!S.analyser||!S.playing)return;
    const buf=new Uint8Array(S.analyser.frequencyBinCount);S.analyser.getByteFrequencyData(buf);
    meterBars.forEach((m,i)=>{
      const[lo,hi]=BIN_RANGES[i];let sum=0;
      for(let j=lo;j<hi&&j<buf.length;j++)sum+=buf[j];
      const avg=sum/(hi-lo),pct=avg/255*100;
      m.bar.style.height=pct+'%';
      m.db.textContent=pct>0.5?(20*Math.log10(avg/255)).toFixed(1):'-âˆ';
    });
  }
  update();
}

// â”€â”€ PEQ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const peqCanvas=document.getElementById('peq-canvas');
const pCtx=peqCanvas.getContext('2d');
let selBand=0;
function drawPEQ(){
  const W=peqCanvas.width,H=peqCanvas.height;
  pCtx.fillStyle='#12121a';pCtx.fillRect(0,0,W,H);
  pCtx.strokeStyle='#2a2a3e';pCtx.lineWidth=1;
  for(let db=-24;db<=24;db+=6){const y=H/2-(db/24)*(H/2-10);pCtx.beginPath();pCtx.moveTo(0,y);pCtx.lineTo(W,y);pCtx.stroke();}
  pCtx.beginPath();pCtx.strokeStyle='#00c8ff';pCtx.lineWidth=2;
  for(let px=0;px<W;px++){
    const f=3*Math.pow(45000/3,px/W);let totalDb=0;
    S.peqBands.forEach((b,bi)=>{
      if(!S.peqNodes[bi])return;
      try{
        const sr=S.srActual||48000,k=Math.tan(Math.PI*b.freq/sr);
        const A=Math.pow(10,b.gain/40),norm=1+k/b.q+k*k;
        const b0=(1+k*A/b.q+k*k)/norm,b1=2*(k*k-1)/norm,b2=(1-k*A/b.q+k*k)/norm;
        const a1=b1,a2=(1-k/b.q+k*k)/norm;
        const w=2*Math.PI*f/sr,cosw=Math.cos(w),sinw=Math.sin(w),cos2w=Math.cos(2*w);
        const nR=b0+b1*cosw+b2*cos2w,nI=-b1*sinw-b2*Math.sin(2*w);
        const dR=1+a1*cosw+a2*cos2w,dI=-a1*sinw-a2*Math.sin(2*w);
        totalDb+=10*Math.log10(Math.max(1e-10,(nR*nR+nI*nI)/(dR*dR+dI*dI)));
      }catch(e){}
    });
    const y=H/2-(totalDb/24)*(H/2-10);
    if(px===0)pCtx.moveTo(px,y);else pCtx.lineTo(px,y);
  }
  pCtx.stroke();
  S.peqBands.forEach((b,i)=>{
    const px=Math.log(b.freq/3)/Math.log(45000/3)*W,py=H/2-(b.gain/24)*(H/2-10);
    pCtx.beginPath();pCtx.arc(px,py,i===selBand?7:5,0,Math.PI*2);
    pCtx.fillStyle=i===selBand?'#ffd700':'#0066ff';pCtx.fill();
  });
}
peqCanvas.addEventListener('touchstart',e=>{
  e.preventDefault();
  const rect=peqCanvas.getBoundingClientRect();
  const px=(e.touches[0].clientX-rect.left)*(peqCanvas.width/rect.width);
  const py=(e.touches[0].clientY-rect.top)*(peqCanvas.height/rect.height);
  if(selBand<S.peqBands.length){
    S.peqBands[selBand].freq=Math.max(3,Math.min(45000,3*Math.pow(45000/3,px/peqCanvas.width)));
    S.peqBands[selBand].gain=Math.max(-24,Math.min(24,(peqCanvas.height/2-py)/(peqCanvas.height/2-10)*24));
    rebuildPeqNodes();renderPeqBands();drawPEQ();
  }
},{passive:false});
function renderPeqBands(){
  const cont=document.getElementById('peq-bands');cont.innerHTML='';
  S.peqBands.forEach((b,i)=>{
    const div=document.createElement('div');div.className='peq-band';
    div.innerHTML=`<div class="peq-band-header"><span class="peq-band-num">Band ${i+1}</span>
      <select class="peq-type-sel" data-bi="${i}">${['peaking','lowshelf','highshelf','lowpass','highpass','notch','bandpass','allpass'].map(t=>`<option value="${t}"${b.type===t?' selected':''}>${t}</option>`).join('')}</select>
      <button class="rm-band" data-bi="${i}">âœ•</button></div>
      <div class="slider-row"><span class="slider-label">Freq (Hz)</span><input type="range" class="tool-slider" data-bi="${i}" data-p="freq" min="3" max="45000" step="1" value="${Math.round(b.freq)}"/><span class="slider-val">${Math.round(b.freq)}</span></div>
      <div class="slider-row"><span class="slider-label">Gain (dB)</span><input type="range" class="tool-slider" data-bi="${i}" data-p="gain" min="-24" max="24" step="0.5" value="${b.gain}"/><span class="slider-val">${b.gain}</span></div>
      <div class="slider-row"><span class="slider-label">Q</span><input type="range" class="tool-slider" data-bi="${i}" data-p="q" min="0.1" max="20" step="0.1" value="${b.q}"/><span class="slider-val">${b.q}</span></div>`;
    cont.appendChild(div);
    div.querySelector('.rm-band').onclick=()=>{if(S.peqBands.length<=1)return;S.peqBands.splice(i,1);selBand=Math.min(selBand,S.peqBands.length-1);rebuildPeqNodes();renderPeqBands();drawPEQ();};
    div.querySelectorAll('.tool-slider').forEach(sl=>{sl.addEventListener('input',()=>{S.peqBands[+sl.dataset.bi][sl.dataset.p]=parseFloat(sl.value);sl.nextElementSibling.textContent=sl.value;rebuildPeqNodes();drawPEQ();});});
    div.querySelector('.peq-type-sel').onchange=e2=>{S.peqBands[+e2.target.dataset.bi].type=e2.target.value;rebuildPeqNodes();drawPEQ();};
    div.addEventListener('click',()=>{selBand=i;drawPEQ();});
  });
}
document.getElementById('add-band-btn').onclick=()=>{S.peqBands.push({id:S.peqIdCtr++,type:'peaking',freq:4000,gain:0,q:1});rebuildPeqNodes();renderPeqBands();drawPEQ();};

// â”€â”€ PLAYBACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadTrack(obj){
  initCtx();if(S.ctx.state==='suspended')S.ctx.resume();
  AUDIO.src=obj.url;
  document.getElementById('track-title').textContent=obj.name;
  document.getElementById('track-artist').textContent=obj.folder||'â€”';
  document.getElementById('track-source').textContent=obj.source||'Local File';
  document.getElementById('export-track-name').textContent=obj.name;
  AUDIO.play().then(()=>{S.playing=true;document.getElementById('play-btn').textContent='â¸';});
  document.querySelectorAll('.lib-track').forEach(r=>r.classList.remove('playing'));
  document.querySelectorAll('.lib-track').forEach((r,i)=>{if(S.queue[i]===obj)r.classList.add('playing');});
}
function togglePlay(){
  initCtx();if(S.ctx.state==='suspended')S.ctx.resume();
  if(S.playing){AUDIO.pause();S.playing=false;document.getElementById('play-btn').textContent='â–¶';}
  else{AUDIO.play();S.playing=true;document.getElementById('play-btn').textContent='â¸';}
}
AUDIO.addEventListener('timeupdate',()=>{
  if(!AUDIO.duration)return;
  document.getElementById('seek').value=AUDIO.currentTime/AUDIO.duration*100;
  document.getElementById('t-cur').textContent=fmt(AUDIO.currentTime);
  document.getElementById('t-dur').textContent=fmt(AUDIO.duration);
});
AUDIO.addEventListener('ended',()=>{if(S.repeat){AUDIO.currentTime=0;AUDIO.play();return;}nextTrack();});
AUDIO.addEventListener('loadedmetadata',()=>{document.getElementById('export-btn').disabled=false;});
document.getElementById('seek').addEventListener('input',e=>{if(AUDIO.duration)AUDIO.currentTime=e.target.value/100*AUDIO.duration;});
document.getElementById('vol').addEventListener('input',e=>{if(S.masterGain){const b=S.boost;S.masterGain.gain.value=(0.55+0.85*b/20)*parseFloat(e.target.value);}});
document.getElementById('play-btn').onclick=togglePlay;
document.getElementById('prev-btn').onclick=()=>prevTrack();
document.getElementById('next-btn').onclick=()=>nextTrack();
document.getElementById('shuffle-btn').onclick=function(){S.shuffle=!S.shuffle;this.classList.toggle('active',S.shuffle);};
document.getElementById('repeat-btn').onclick=function(){S.repeat=!S.repeat;this.classList.toggle('active',S.repeat);};
function prevTrack(){if(S.queueIdx>0){S.queueIdx--;loadTrack(S.queue[S.queueIdx]);}}
function nextTrack(){
  if(!S.queue.length)return;
  if(S.shuffle)S.queueIdx=Math.floor(Math.random()*S.queue.length);
  else if(S.queueIdx<S.queue.length-1)S.queueIdx++;
  else S.queueIdx=0;
  loadTrack(S.queue[S.queueIdx]);
}
function fmt(s){const m=Math.floor(s/60),sec=Math.floor(s%60);return`${m}:${sec<10?'0':''}${sec}`;}

// â”€â”€ LIBRARY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateLibStats(){
  const total=S.queue.length,folders=Object.keys(S.library).length;
  document.getElementById('lib-stats').textContent=
    total>0?`${total} track${total!==1?'s':''} across ${folders} folder${folders!==1?'s':''}`:' No tracks loaded';
}
function addFiles(files){
  Array.from(files).forEach(f=>{
    if(!f.type.startsWith('audio/'))return;
    const parts=(f.webkitRelativePath||f.name).split('/');
    const folder=parts.length>1?parts[0]:'Device Audio';
    const name=parts[parts.length-1];
    if(!S.library[folder])S.library[folder]=[];
    if(!S.library[folder].find(t=>t.name===name)){
      S.library[folder].push({name,url:URL.createObjectURL(f),folder,source:'Local File'});
    }
  });
  flattenQueue();renderLibrary();updateLibStats();
}
function flattenQueue(){S.queue=[];Object.values(S.library).forEach(t=>S.queue.push(...t));}
function renderLibrary(filter=''){
  const cont=document.getElementById('lib-list');cont.innerHTML='';
  const q=filter.toLowerCase();let totalShown=0;
  Object.entries(S.library).sort((a,b)=>a[0].localeCompare(b[0])).forEach(([folder,tracks])=>{
    const filtered=q?tracks.filter(t=>t.name.toLowerCase().includes(q)||folder.toLowerCase().includes(q)):tracks;
    if(!filtered.length)return;
    totalShown+=filtered.length;
    const div=document.createElement('div');div.className='lib-folder';
    const hdr=document.createElement('div');hdr.className='lib-folder-header';
    hdr.innerHTML=`<span>ğŸ“ ${folder}</span><span class="lib-folder-count">${filtered.length}</span>`;
    div.appendChild(hdr);
    const list=document.createElement('div');
    filtered.forEach((t,i)=>{
      const row=document.createElement('div');row.className='lib-track';
      const qIdx=S.queue.indexOf(t);
      if(qIdx===S.queueIdx&&S.playing)row.classList.add('playing');
      row.innerHTML=`<span class="lib-track-num">${i+1}</span>
        <span class="lib-track-name">${t.name}</span>
        <button class="lib-track-play">${qIdx===S.queueIdx&&S.playing?'â¸':'â–¶'}</button>`;
      const playFn=e=>{if(e)e.stopPropagation();S.queueIdx=S.queue.indexOf(t);loadTrack(t);switchTab('player');};
      row.querySelector('.lib-track-play').onclick=playFn;
      row.onclick=playFn;
      list.appendChild(row);
    });
    let open=true;hdr.onclick=()=>{open=!open;list.style.display=open?'':'none';};
    div.appendChild(list);cont.appendChild(div);
  });
  if(q&&totalShown===0)cont.innerHTML=`<div style="text-align:center;color:var(--sub);padding:20px;">No results for "${filter}"</div>`;
}
document.getElementById('search-bar').addEventListener('input',function(){renderLibrary(this.value);});
document.getElementById('scan-device-btn').onclick=()=>{
  if(!S.permissionGranted){document.getElementById('perm-modal').classList.add('open');return;}
  document.getElementById('file-input').click();
};
document.getElementById('folder-btn').onclick=()=>document.getElementById('folder-input').click();
document.getElementById('folder-input').addEventListener('change',e=>addFiles(e.target.files));
document.getElementById('file-input').addEventListener('change',e=>addFiles(e.target.files));
const dz=document.getElementById('drop-zone');
dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('drag-over');});
dz.addEventListener('dragleave',()=>dz.classList.remove('drag-over'));
dz.addEventListener('drop',e=>{e.preventDefault();dz.classList.remove('drag-over');addFiles(e.dataTransfer.files);});
dz.addEventListener('click',()=>document.getElementById('file-input').click());

// â”€â”€ SOUND TOOL CONTROLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.style-btn').forEach(btn=>{
  btn.onclick=()=>{document.querySelectorAll('.style-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');S.currentStyle=btn.dataset.style;rebuildStyleNodes();};
});
document.getElementById('style-intensity').addEventListener('input',function(){document.getElementById('style-intensity-val').textContent=this.value;S.styleIntensity=+this.value;rebuildStyleNodes();});
document.getElementById('nr-toggle').addEventListener('click',function(){S.nrEnabled=!S.nrEnabled;this.classList.toggle('on',S.nrEnabled);applyNR();});
document.getElementById('nr-amount').addEventListener('input',function(){document.getElementById('nr-amount-val').textContent=this.value;S.nrAmount=+this.value;applyNR();});
['bass','mids','treble'].forEach(k=>{
  document.getElementById(`tone-${k}`).addEventListener('input',function(){document.getElementById(`tone-${k}-val`).textContent=this.value;S.toneVals[k]=+this.value;applyTone();});
});
document.getElementById('boost-val').addEventListener('input',function(){document.getElementById('boost-display').textContent=this.value;S.boost=+this.value;applyBoost();});
document.getElementById('brightness-val').addEventListener('input',function(){document.getElementById('brightness-display').textContent=this.value;S.brightness=+this.value;applyBrightness();});
document.querySelectorAll('.atmos-btn').forEach(btn=>{
  btn.onclick=()=>{document.querySelectorAll('.atmos-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');S.atmosMode=btn.dataset.mode;rewire();};
});

// â”€â”€ STREAMING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STREAM_OAUTH={
  spotify:'https://accounts.spotify.com/authorize?client_id=YOUR_SPOTIFY_CLIENT_ID&response_type=token&redirect_uri=com.dolby.unifiedplayer://callback&scope=streaming%20user-read-email%20user-read-private',
  tidal:'https://login.tidal.com/oauth2/authorize?client_id=YOUR_TIDAL_CLIENT_ID&response_type=code&redirect_uri=com.dolby.unifiedplayer://callback',
  deezer:'https://connect.deezer.com/oauth/auth.php?app_id=YOUR_DEEZER_APP_ID&redirect_uri=com.dolby.unifiedplayer://callback&perms=basic_access,streaming',
  apple:'https://appleid.apple.com/auth/authorize',
  youtube:'https://accounts.google.com/o/oauth2/auth?client_id=YOUR_YOUTUBE_CLIENT_ID&redirect_uri=com.dolby.unifiedplayer://callback&response_type=token&scope=https://www.googleapis.com/auth/youtube.readonly',
};
document.querySelectorAll('.stream-service').forEach(svc=>{
  svc.onclick=()=>{
    const id=svc.dataset.svc;
    if(S.streamConnected[id]){
      S.streamConnected[id]=false;
      const st=document.getElementById(`status-${id}`);st.textContent='Connect';st.className='stream-status disconnected';
    }else{
      if(typeof window.Capacitor!=='undefined'&&window.Capacitor.Plugins&&window.Capacitor.Plugins.Browser){
        window.Capacitor.Plugins.Browser.open({url:STREAM_OAUTH[id]});
      }else{window.open(STREAM_OAUTH[id],`${id}_auth`,'width=400,height=600');}
      setTimeout(()=>{S.streamConnected[id]=true;const st=document.getElementById(`status-${id}`);st.textContent='âœ“ Connected';st.className='stream-status connected';},2000);
    }
  };
});

// â”€â”€ WAV EXPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function encodeWAV32(L,R,sr){
  const len=L.length,buf=new ArrayBuffer(44+len*8),dv=new DataView(buf);
  const str=(o,s)=>{for(let i=0;i<s.length;i++)dv.setUint8(o+i,s.charCodeAt(i));};
  str(0,'RIFF');dv.setUint32(4,36+len*8,true);str(8,'WAVE');
  str(12,'fmt ');dv.setUint32(16,16,true);dv.setUint16(20,3,true);
  dv.setUint16(22,2,true);dv.setUint32(24,sr,true);dv.setUint32(28,sr*8,true);
  dv.setUint16(32,8,true);dv.setUint16(34,32,true);
  str(36,'data');dv.setUint32(40,len*8,true);
  let o=44;for(let i=0;i<len;i++){dv.setFloat32(o,L[i],true);o+=4;dv.setFloat32(o,R[i],true);o+=4;}
  return buf;
}
document.getElementById('export-btn').addEventListener('click',async()=>{
  if(!AUDIO.src||AUDIO.src===window.location.href)return;
  const expBtn=document.getElementById('export-btn'),progDiv=document.getElementById('export-progress');
  const progBar=document.getElementById('export-progress-bar'),progTxt=document.getElementById('export-status-text');
  expBtn.disabled=true;progDiv.style.display='block';progTxt.textContent='Decoding source audio...';progBar.style.width='10%';
  try{
    const resp=await fetch(AUDIO.src),ab=await resp.arrayBuffer();
    const tmpCtx=new(window.AudioContext||window.webkitAudioContext)();
    const decoded=await tmpCtx.decodeAudioData(ab);tmpCtx.close();
    const sr=S.srActual;
    progTxt.textContent=`Rendering @ ${sr/1000}kHz...`;progBar.style.width='30%';
    const offCtx=new OfflineAudioContext(2,Math.ceil(sr*decoded.duration),sr);
    const offSrc=offCtx.createBufferSource();offSrc.buffer=decoded;
    const mkF=(type,freq,gain,q)=>{const f=offCtx.createBiquadFilter();f.type=type;f.frequency.value=freq;f.gain.value=gain;f.Q.value=q;return f;};
    const offNR=mkF('highpass',S.nrEnabled?(20+180*S.nrAmount/20):3,0,S.nrEnabled?(0.6+1.8*S.nrAmount/20):0.6);
    const offStyle=(STYLE_PRESETS[S.currentStyle]||[]).map(f=>mkF(f.type,f.freq,f.gain*S.styleIntensity/10,f.q));
    const offBass=mkF('lowshelf',200,S.toneVals.bass*0.75,1);
    const offMids=mkF('peaking',1000,S.toneVals.mids*0.75,0.8);
    const offTreble=mkF('highshelf',5000,S.toneVals.treble*0.75,1);
    const offPeq=S.peqBands.map(b=>mkF(b.type,Math.max(3,Math.min(b.freq,45000)),b.gain,b.q));
    const offComp=offCtx.createDynamicsCompressor();
    const bv=S.boost;
    offComp.threshold.value=-44+(24*bv/20);offComp.ratio.value=3+(17*bv/20);
    offComp.knee.value=30-(22*bv/20);offComp.release.value=(300-180*bv/20)/1000;
    const offBrightness=mkF('highshelf',8000,(S.brightness-10)*0.9,1);
    const offMaster=offCtx.createGain();offMaster.gain.value=0.55+0.85*bv/20;
    let node=offSrc;const c=(a,b2)=>a.connect(b2);
    c(node,offNR);node=offNR;
    offStyle.forEach(s=>{c(node,s);node=s;});
    c(node,offBass);c(offBass,offMids);c(offMids,offTreble);node=offTreble;
    offPeq.forEach(p=>{c(node,p);node=p;});
    c(node,offComp);c(offComp,offBrightness);c(offBrightness,offMaster);c(offMaster,offCtx.destination);
    offSrc.start();
    progBar.style.width='60%';
    const rendered=await offCtx.startRendering();
    progBar.style.width='85%';progTxt.textContent='Encoding 32-bit WAV...';
    const L=rendered.getChannelData(0),R=rendered.numberOfChannels>1?rendered.getChannelData(1):L;
    const wavBuf=encodeWAV32(L,R,sr);
    const blob=new Blob([wavBuf],{type:'audio/wav'});
    const a=document.createElement('a');a.href=URL.createObjectURL(blob);
    const name=(document.getElementById('track-title').textContent||'export').replace(/\.[^.]+$/,'');
    a.download=`${name}_32bit_${sr/1000}kHz.wav`;a.click();URL.revokeObjectURL(a.href);
    progBar.style.width='100%';progTxt.textContent='âœ“ Export complete!';
    setTimeout(()=>{progDiv.style.display='none';expBtn.disabled=false;},2500);
  }catch(err){
    progTxt.textContent='âœ— Export failed: '+err.message;
    setTimeout(()=>{progDiv.style.display='none';expBtn.disabled=false;},3000);
  }
});

// â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(id){
  document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===id));
  document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
  const panels={player:'player-panel',streaming:'streaming-panel',dolby:'dolby-panel',
    atmos:'atmos-panel',peq:'peq-panel',library:'library-panel',export:'export-panel'};
  const el=document.getElementById(panels[id]);if(el)el.classList.add('active');
  if(id==='peq'){renderPeqBands();setTimeout(drawPEQ,50);}
}
document.querySelectorAll('.tab').forEach(t=>{t.onclick=()=>switchTab(t.dataset.tab);});

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
buildMeterUI();renderPeqBands();updateLibStats();
document.addEventListener('touchstart',()=>initCtx(),{once:true});
document.addEventListener('click',()=>initCtx(),{once:true});
</script>
</body>
</html>