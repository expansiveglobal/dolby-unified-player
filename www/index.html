<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Dolby Unified Player</title>
<script src="https://js-cdn.music.apple.com/musickit/v3/musickit.js" async></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#07070f;--panel:#0e0e1a;--card:#141422;--card2:#1a1a28;
  --border:#22223a;--acc:#6344f5;--acO:#ff6b35;--acG:#00e5a0;
  --text:#dde0f0;--sub:#55557a;--red:#ff3366;
  --sp:#1db954;--dz:#ef5466;--td:#00ffff;--am:#fc3c44;--yt:#ff0000;
}
body{background:var(--bg);color:var(--text);font-family:'Segoe UI',system-ui,sans-serif;min-height:100vh;overflow-x:hidden}
.app{display:grid;grid-template-columns:230px 1fr;grid-template-rows:48px 1fr;height:100vh;overflow:hidden}
.topbar{grid-column:1/-1;background:var(--panel);border-bottom:1px solid var(--border);
  display:flex;align-items:center;padding:0 14px;gap:10px;z-index:20;flex-shrink:0}
.logo{font-weight:900;font-size:15px;background:linear-gradient(90deg,#6344f5,#ff6b35);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:.5px;flex-shrink:0}
.logo sub{font-size:9px;font-weight:400;-webkit-text-fill-color:var(--sub);letter-spacing:2px;display:block;margin-top:-2px}
.tbadge{padding:2px 8px;border-radius:9px;font-size:9px;font-weight:800;letter-spacing:1px;
  border:1px solid;cursor:default;flex-shrink:0;text-transform:uppercase}
.off{color:var(--sub);border-color:var(--border);background:transparent}
.on-g{color:var(--acG);border-color:var(--acG);background:rgba(0,229,160,.07)}
.on-o{color:var(--acO);border-color:var(--acO);background:rgba(255,107,53,.07)}
.on-a{color:var(--acc);border-color:var(--acc);background:rgba(99,68,245,.07)}
.sidebar{background:var(--panel);border-right:1px solid var(--border);overflow-y:auto;
  display:flex;flex-direction:column;min-height:0}
.shdr{padding:10px 12px 7px;font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;
  color:var(--sub);border-bottom:1px solid var(--border);display:flex;align-items:center;
  justify-content:space-between;flex-shrink:0}
.shdr-btns{display:flex;gap:5px}
.ibtn{background:rgba(99,68,245,.15);border:1px solid rgba(99,68,245,.35);color:#9080ff;
  padding:2px 8px;border-radius:5px;cursor:pointer;font-size:9px;transition:.2s}
.ibtn:hover{background:rgba(99,68,245,.3)}
.ibtn.green{background:rgba(0,229,160,.1);border-color:rgba(0,229,160,.35);color:var(--acG)}
.ibtn.green:hover{background:rgba(0,229,160,.2)}
.libscroll{flex:1;overflow-y:auto;min-height:0}
.frow{padding:7px 11px;display:flex;align-items:center;gap:6px;cursor:pointer;
  border-bottom:1px solid var(--border);font-size:11px;transition:.12s;user-select:none}
.frow:hover{background:var(--card)}
.frow.open .fi{transform:rotate(90deg)}
.fi{transition:transform .2s;font-size:11px;display:inline-block;flex-shrink:0}
.fmeta{font-size:9px;color:var(--sub);margin-top:1px}
.trow{padding:5px 11px 5px 26px;display:flex;align-items:center;gap:6px;cursor:pointer;
  font-size:11px;transition:.12s;border-bottom:1px solid rgba(255,255,255,.02)}
.trow:hover{background:rgba(255,255,255,.03)}
.trow.act{color:var(--acc)}
.trow.act::before{content:'â–¶ ';font-size:8px}
.tname{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;min-width:0}
.libempty{padding:18px 12px;text-align:center;color:var(--sub);font-size:10px;line-height:2}
.lib-auto-banner{padding:7px 12px;background:rgba(0,229,160,.06);border-bottom:1px solid rgba(0,229,160,.15);
  font-size:9px;color:var(--acG);display:flex;align-items:center;gap:6px}
.lib-auto-banner .dot{width:6px;height:6px;border-radius:50%;background:var(--acG);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.main{overflow-y:auto;min-height:0;background:var(--bg)}
.mi{padding:14px}
.platforms{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:14px}
.pcard{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px 8px;
  text-align:center;cursor:pointer;transition:.2s;position:relative;overflow:hidden}
.pcard:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,.4)}
.pcard.connected{border-color:var(--pcolor,var(--acc))}
.pcard.connected::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:var(--pcolor,var(--acc))}
.picon{font-size:24px;margin-bottom:4px}
.pname{font-size:10px;font-weight:700;letter-spacing:.5px;color:var(--sub)}
.pstatus{font-size:8px;margin-top:3px;font-weight:700;letter-spacing:1px}
.pstatus.conn{color:var(--pcolor,var(--acc))}
.pstatus.disc{color:var(--sub)}
.stream-panel{background:var(--card);border:1px solid var(--border);border-radius:12px;
  padding:14px;margin-bottom:14px;display:none}
.stream-panel.open{display:block}
.stream-hdr{display:flex;align-items:center;gap:8px;margin-bottom:10px}
.stream-logo{width:24px;height:24px;border-radius:6px;display:flex;align-items:center;
  justify-content:center;font-size:14px;flex-shrink:0}
.stream-title{font-size:13px;font-weight:700}
.stream-sub{font-size:10px;color:var(--sub);flex:1}
.sbar{display:flex;gap:7px;margin-bottom:10px}
.sinput{flex:1;background:var(--card2);border:1px solid var(--border);color:var(--text);
  padding:7px 12px;border-radius:8px;font-size:12px;outline:none;transition:.2s}
.sinput:focus{border-color:var(--acc)}
.sbtn2{padding:7px 14px;border-radius:8px;border:1px solid var(--acc);background:rgba(99,68,245,.15);
  color:var(--acc);font-size:11px;cursor:pointer;transition:.2s;white-space:nowrap;font-weight:600}
.sbtn2:hover{background:rgba(99,68,245,.3)}
.sresults{display:grid;gap:5px;max-height:280px;overflow-y:auto}
.strack{background:var(--card2);border:1px solid var(--border);border-radius:8px;padding:8px 10px;
  display:flex;align-items:center;gap:10px;cursor:pointer;transition:.15s}
.strack:hover{border-color:var(--acc);background:rgba(99,68,245,.05)}
.strack-art{width:40px;height:40px;border-radius:6px;object-fit:cover;background:var(--card);
  flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:18px;overflow:hidden}
.strack-art img{width:100%;height:100%;object-fit:cover;border-radius:6px}
.strack-info{flex:1;min-width:0}
.strack-name{font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.strack-artist{font-size:10px;color:var(--sub);margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.strack-dur{font-size:10px;color:var(--sub);flex-shrink:0}
.strack-play{width:30px;height:30px;border-radius:50%;background:var(--acc);border:none;
  color:#fff;cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center;
  flex-shrink:0;transition:.15s}
.strack-play:hover{transform:scale(1.1);background:var(--acO)}
#ytFrame{display:none;width:0;height:0;position:absolute}
.np{background:linear-gradient(135deg,#0e0e1e,#180f25);border:1px solid var(--border);
  border-radius:14px;padding:14px;margin-bottom:12px;position:relative;overflow:hidden}
.np::before{content:'';position:absolute;inset:0;
  background:radial-gradient(ellipse at 20% 50%,rgba(99,68,245,.05),transparent 70%);pointer-events:none}
.np-title{font-size:16px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.np-sub{font-size:10px;color:var(--sub);margin-top:2px;margin-bottom:6px}
.np-fmt{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:10px}
.fb{font-size:9px;padding:2px 6px;border-radius:5px;font-weight:700;border:1px solid}
.fb-w{color:var(--acG);border-color:rgba(0,229,160,.3);background:rgba(0,229,160,.07)}
.fb-b{color:#a090ff;border-color:rgba(99,68,245,.3);background:rgba(99,68,245,.07)}
.fb-c{color:var(--acO);border-color:rgba(255,107,53,.3);background:rgba(255,107,53,.07)}
.fb-src{font-size:9px;padding:2px 6px;border-radius:5px;font-weight:700;border:1px solid;color:var(--text)}
canvas#viz{width:100%;height:52px;display:block;border-radius:7px;background:rgba(0,0,0,.4);margin-bottom:10px}
.seek-w{margin-bottom:8px}
.sbar-r{width:100%;-webkit-appearance:none;appearance:none;height:3px;border-radius:2px;
  background:var(--border);outline:none;cursor:pointer;accent-color:var(--acc)}
.trow2{display:flex;justify-content:space-between;font-size:10px;color:var(--sub);margin-top:3px}
.ctrl{display:flex;align-items:center;gap:8px;margin-bottom:10px}
.pbtn{width:46px;height:46px;border-radius:50%;
  background:linear-gradient(135deg,#6344f5,#ff6b35);border:none;color:#fff;
  font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;
  box-shadow:0 3px 16px rgba(99,68,245,.4);transition:.18s;flex-shrink:0}
.pbtn:hover{transform:scale(1.07)}
.cbtn{background:var(--card2);border:1px solid var(--border);color:var(--text);width:32px;height:32px;
  border-radius:50%;cursor:pointer;font-size:12px;display:flex;align-items:center;
  justify-content:center;transition:.2s;flex-shrink:0}
.cbtn:hover{border-color:var(--acc);color:var(--acc)}
.cbtn.on{background:var(--acc);border-color:var(--acc);color:#fff}
.vol{display:flex;align-items:center;gap:5px;flex:1}
.vol input[type=range]{flex:1;accent-color:var(--acc)}
.dropz{border:2px dashed var(--border);border-radius:9px;padding:14px;text-align:center;
  cursor:pointer;transition:.2s;font-size:10px;color:var(--sub);background:rgba(0,0,0,.15)}
.dropz:hover,.dropz.drag{border-color:var(--acc);background:rgba(99,68,245,.04)}
.sh{font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--sub);
  margin:4px 0 9px;display:flex;align-items:center;gap:7px}
.sh span{display:block;height:1px;flex:1;background:var(--border)}
.tgrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px}
.tc{background:var(--card);border:1px solid var(--border);border-radius:11px;padding:13px}
.tc-t{font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;margin-bottom:11px;display:flex;align-items:center;gap:5px}
.tc-on{color:var(--acc)} .tc-atm{color:var(--acO)} .tc-g{color:var(--acG)}
.sgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:4px;margin-bottom:9px}
.sbtn{background:var(--card2);border:1px solid var(--border);color:var(--sub);padding:6px 3px;
  border-radius:7px;cursor:pointer;font-size:10px;text-align:center;transition:.14s;line-height:1.3}
.sbtn:hover{border-color:var(--acc);color:var(--text)}
.sbtn.on{background:var(--acc);border-color:var(--acc);color:#fff;font-weight:600}
.sbtn.soff{grid-column:span 3;background:rgba(255,255,255,.02);color:var(--sub);font-style:italic}
.sbtn.soff.on{background:var(--sub);border-color:var(--sub)}
.lr{display:flex;align-items:center;gap:7px;margin-top:5px}
.ll{font-size:9px;color:var(--sub);width:55px;flex-shrink:0}
.sg{flex:1;-webkit-appearance:none;appearance:none;height:3px;border-radius:2px;outline:none;cursor:pointer;
  background:linear-gradient(90deg,var(--acc) var(--p,50%),var(--border) var(--p,50%))}
.sg::-webkit-slider-thumb{-webkit-appearance:none;width:12px;height:12px;border-radius:50%;background:var(--acc);cursor:pointer}
.vb{font-size:10px;color:var(--text);min-width:24px;text-align:right}
.tr{display:flex;align-items:center;gap:7px}
.tl{font-size:9px;color:var(--sub);width:38px;flex-shrink:0}
.bs{flex:1;-webkit-appearance:none;appearance:none;height:3px;border-radius:2px;background:var(--border);outline:none;cursor:pointer;accent-color:var(--acc)}
.tv{font-size:10px;min-width:28px;text-align:right}
.trows{display:flex;flex-direction:column;gap:8px}
.tog{position:relative;width:36px;height:20px;flex-shrink:0}
.tog input{opacity:0;width:0;height:0;position:absolute}
.togsl{position:absolute;inset:0;background:var(--border);border-radius:10px;cursor:pointer;transition:.25s}
.togsl:before{content:'';position:absolute;width:14px;height:14px;left:3px;top:3px;background:#fff;border-radius:50%;transition:.25s}
.tog input:checked+.togsl{background:var(--acc)}
.tog input:checked+.togsl:before{transform:translateX(16px)}
.tog-row{display:flex;align-items:center;gap:7px;margin-bottom:7px}
.blv{height:5px;background:var(--border);border-radius:3px;overflow:hidden;margin-top:2px;margin-bottom:7px}
.blf{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--acc),var(--acO));transition:width .15s}
.atmos-w{background:var(--card);border:1px solid rgba(255,107,53,.18);border-radius:11px;padding:13px;margin-bottom:12px}
.amodes{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px}
.ab{background:var(--card2);border:1px solid var(--border);color:var(--sub);padding:6px 10px;
  border-radius:8px;cursor:pointer;font-size:10px;transition:.14s;display:flex;align-items:center;gap:4px}
.ab:hover{border-color:var(--acO);color:var(--text)}
.ab.on{background:rgba(255,107,53,.12);border-color:var(--acO);color:var(--acO);font-weight:700}
.chmap{background:var(--card2);border:1px solid var(--border);border-radius:9px;padding:10px;margin-bottom:12px}
.chg{display:grid;grid-template-columns:repeat(5,1fr);gap:4px;margin-top:8px}
.chc{background:var(--card);border:1px solid var(--border);border-radius:6px;padding:5px 3px;text-align:center;cursor:pointer;transition:.14s}
.chc.sub{border-color:rgba(99,68,245,.4);background:rgba(99,68,245,.05)}
.chc.height{border-color:rgba(0,229,160,.3);background:rgba(0,229,160,.05)}
.chn{font-size:8px;font-weight:700;color:var(--sub)}
.chd{font-size:9px;font-weight:600;margin-top:1px}
.chl{height:2px;border-radius:1px;background:var(--border);overflow:hidden;margin-top:3px}
.chb{height:100%;border-radius:1px;transition:width .1s}
.wav-w{background:var(--card);border:1px solid rgba(0,229,160,.18);border-radius:11px;padding:13px;margin-bottom:12px}
.wav-s{display:flex;align-items:center;gap:7px;margin-bottom:8px}
.wdot{width:7px;height:7px;border-radius:50%;background:var(--border);flex-shrink:0;transition:.3s}
.wdot.act{background:var(--acG);box-shadow:0 0 7px var(--acG)}
.wbtns{display:flex;gap:7px;flex-wrap:wrap;margin-top:8px}
.wbtn{padding:5px 12px;border-radius:7px;border:1px solid var(--border);background:var(--card2);
  color:var(--text);font-size:10px;cursor:pointer;transition:.2s}
.wbtn:hover{border-color:var(--acG);color:var(--acG)}
.wbtn.p{background:rgba(0,229,160,.1);border-color:var(--acG);color:var(--acG);font-weight:600}
.wpr{display:none;margin-top:8px}
.wprbar{background:var(--border);height:3px;border-radius:2px;overflow:hidden}
.wprf{height:100%;background:var(--acG);width:0%;transition:width .2s;border-radius:2px}
.peq-w{background:var(--card);border:1px solid var(--border);border-radius:11px;padding:13px;margin-bottom:14px}
canvas#peq{width:100%;height:120px;display:block;background:#06060e;border-radius:7px;margin-bottom:9px;cursor:crosshair}
.pbands{display:flex;gap:5px;overflow-x:auto;padding-bottom:3px;margin-bottom:9px}
.pb{background:var(--card2);border:1px solid var(--border);border-radius:7px;padding:6px 4px;
  min-width:62px;text-align:center;cursor:pointer;transition:.14s;flex-shrink:0}
.pb:hover{border-color:var(--acc)} .pb.sel{border-color:var(--acc);background:rgba(99,68,245,.1)}
.pbf{font-size:9px;color:var(--sub)} .pbg{font-size:11px;font-weight:700;margin-top:1px} .pbt{font-size:8px;color:var(--sub);margin-top:1px}
.pctrl{display:flex;gap:8px;flex-wrap:wrap;align-items:flex-end}
.pf{display:flex;flex-direction:column;gap:2px}
.pf label{font-size:9px;color:var(--sub);letter-spacing:1px}
.pf input,.pf select{background:var(--bg);border:1px solid var(--border);color:var(--text);
  padding:4px 7px;border-radius:6px;font-size:11px;outline:none;width:84px}
.pf select{width:106px}
.pbtn2{padding:5px 10px;border-radius:6px;border:1px solid var(--border);background:var(--card2);
  color:var(--text);font-size:9px;cursor:pointer;transition:.2s;white-space:nowrap}
.pbtn2:hover{border-color:var(--acc);color:var(--acc)}
.pbtn2.del{color:var(--red);border-color:rgba(255,51,102,.3)}
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
.modal{background:#12121f;border:1px solid var(--border);border-radius:16px;padding:28px;width:420px;max-width:94vw;box-shadow:0 20px 60px rgba(0,0,0,.5)}
.modal h2{font-size:16px;font-weight:800;margin-bottom:4px}
.modal p{font-size:11px;color:var(--sub);line-height:1.7;margin-bottom:14px}
.modal label{font-size:10px;color:var(--sub);display:block;margin-bottom:3px;letter-spacing:1px}
.modal input{width:100%;background:var(--card);border:1px solid var(--border);color:var(--text);
  padding:8px 11px;border-radius:8px;font-size:12px;outline:none;margin-bottom:10px;transition:.2s}
.modal input:focus{border-color:var(--acc)}
.modal-btns{display:flex;gap:8px;justify-content:flex-end;margin-top:4px}
.modal-btns button{padding:8px 18px;border-radius:8px;border:1px solid var(--border);cursor:pointer;font-size:11px;font-weight:600;transition:.2s}
.mbtn-cancel{background:transparent;color:var(--sub)}
.mbtn-connect{background:var(--pcolor2,var(--acc));border-color:var(--pcolor2,var(--acc));color:#fff}
.mbtn-connect:hover{opacity:.85}
.pstep{font-size:10px;color:var(--sub);padding:8px;background:var(--card2);border-radius:7px;line-height:1.7;margin-bottom:10px}
.pstep a{color:var(--acc);text-decoration:none}
input[type=file]{display:none}
::-webkit-scrollbar{width:4px;height:4px}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
@media(max-width:680px){.app{grid-template-columns:1fr}.sidebar{display:none}.tgrid{grid-template-columns:1fr}.platforms{grid-template-columns:repeat(3,1fr)}}
</style>
</head>
<body>
<div class="app">
<!-- TOPBAR -->
<div class="topbar">
  <div class="logo">DOLBY UNIFIED PLAYER<sub>ON + ATMOS + STREAMING</sub></div>
  <div style="flex:1"></div>
  <span id="bNR" class="tbadge off">NR OFF</span>
  <span id="bAtmos" class="tbadge off">ATMOS OFF</span>
  <span id="bSrc" class="tbadge off">LOCAL</span>
</div>

<!-- SIDEBAR -->
<div class="sidebar">
  <div class="shdr">
    Library
    <div class="shdr-btns">
      <button class="ibtn green" onclick="autoScanLib()" title="Auto-scan music folder">âŸ³ Auto</button>
      <button class="ibtn" onclick="scanFolder()">ï¼‹ Folder</button>
    </div>
  </div>
  <div class="lib-auto-banner" id="autoLibBanner" style="display:none">
    <div class="dot"></div>
    <span id="autoLibTxt">Library monitoring active</span>
  </div>
  <div class="libscroll" id="libScroll">
    <div class="libempty" id="libEmpty">ğŸ“ No library yet<br>Click <strong>âŸ³ Auto</strong> to auto-load<br>or drop files below â†’</div>
  </div>
  <input type="file" id="folderIn" webkitdirectory multiple accept="audio/*" onchange="onFolderScan(event)">
  <input type="file" id="fileIn" multiple accept="audio/*" onchange="onFileIn(event)">
</div>

<!-- MAIN -->
<div class="main"><div class="mi">

<div class="sh">ğŸ§ Streaming Platforms<span></span></div>
<div class="platforms">
  <div class="pcard" id="pc-spotify" style="--pcolor:var(--sp)" onclick="openPlatform('spotify')">
    <div class="picon">ğŸµ</div><div class="pname" style="color:var(--sp)">Spotify</div>
    <div class="pstatus disc" id="ps-spotify">CONNECT</div>
  </div>
  <div class="pcard" id="pc-deezer" style="--pcolor:var(--dz)" onclick="openPlatform('deezer')">
    <div class="picon">ğŸ¶</div><div class="pname" style="color:var(--dz)">Deezer</div>
    <div class="pstatus disc" id="ps-deezer">CONNECT</div>
  </div>
  <div class="pcard" id="pc-tidal" style="--pcolor:var(--td)" onclick="openPlatform('tidal')">
    <div class="picon">ğŸŒŠ</div><div class="pname" style="color:var(--td)">Tidal</div>
    <div class="pstatus disc" id="ps-tidal">CONNECT</div>
  </div>
  <div class="pcard" id="pc-apple" style="--pcolor:var(--am)" onclick="openPlatform('apple')">
    <div class="picon">ğŸ</div><div class="pname" style="color:var(--am)">Apple Music</div>
    <div class="pstatus disc" id="ps-apple">CONNECT</div>
  </div>
  <div class="pcard" id="pc-youtube" style="--pcolor:var(--yt)" onclick="openPlatform('youtube')">
    <div class="picon">â–¶ï¸</div><div class="pname" style="color:var(--yt)">YouTube</div>
    <div class="pstatus disc" id="ps-youtube">CONNECT</div>
  </div>
</div>

<div class="stream-panel" id="streamPanel">
  <div class="stream-hdr">
    <div class="stream-logo" id="streamLogo"></div>
    <div>
      <div class="stream-title" id="streamTitle">Platform</div>
      <div class="stream-sub" id="streamSub">Search for music</div>
    </div>
    <button class="ibtn" onclick="disconnectPlatform()" style="margin-left:auto">Disconnect</button>
  </div>
  <div class="sbar">
    <input class="sinput" id="searchInput" type="text" placeholder="Search tracks, artists, albumsâ€¦" onkeydown="if(event.key==='Enter')doSearch()">
    <button class="sbtn2" onclick="doSearch()">Search</button>
  </div>
  <div class="sresults" id="sresults"></div>
</div>

<div id="ytFrame"></div>

<!-- NOW PLAYING -->
<div class="np">
  <div class="np-title" id="npTitle">No Track Loaded</div>
  <div class="np-sub" id="npSub">Load files, scan library, or connect a streaming platform</div>
  <div class="np-fmt">
    <span class="fb fb-w">WAV 24-bit / 192kHz</span>
    <span class="fb fb-b">9,216 kbps</span>
    <span class="fb fb-c">9.2.4 CH</span>
    <span class="fb fb-src" id="srcBadge" style="border-color:var(--border);background:rgba(255,255,255,.04)">LOCAL</span>
  </div>
  <canvas id="viz"></canvas>
  <div class="seek-w">
    <input type="range" class="sbar-r" id="seekBar" min="0" max="100" value="0" step="0.05" oninput="seek(this.value)">
    <div class="trow2"><span id="tCur">0:00</span><span id="tDur">0:00</span></div>
  </div>
  <div class="ctrl">
    <button class="cbtn" onclick="prevTrk()">â®</button>
    <button class="pbtn" id="playBtn" onclick="togglePlay()">â–¶</button>
    <button class="cbtn" onclick="nextTrk()">â­</button>
    <button class="cbtn" id="repBtn" onclick="toggleRepeat()" title="Repeat">ğŸ”</button>
    <button class="cbtn" id="shufBtn" onclick="toggleShuffle()" title="Shuffle">ğŸ”€</button>
    <div class="vol">
      <span style="font-size:12px">ğŸ”‰</span>
      <input type="range" min="0" max="1" step="0.01" value="0.8" id="volSl" oninput="setVol(this.value)">
      <span style="font-size:12px">ğŸ”Š</span>
    </div>
  </div>
  <div class="dropz" id="dropZ" onclick="document.getElementById('fileIn').click()"
    ondragover="doDragOver(event)" ondragleave="doDragLeave()" ondrop="doDrop(event)">
    ğŸµ Click or drag &amp; drop audio files Â· <strong style="color:var(--acG)">All formats auto-detected</strong>
  </div>
</div>

<!-- DOLBY ON TOOLS -->
<div class="sh">âš¡ Dolby On â€” Sound Tools<span></span></div>
<div class="tgrid">
  <div class="tc">
    <div class="tc-t tc-on">ğŸ¨ Style</div>
    <div class="sgrid">
      <button class="sbtn on" data-s="standard" onclick="setStyle('standard',this)">Standard</button>
      <button class="sbtn" data-s="amped" onclick="setStyle('amped',this)">Amped</button>
      <button class="sbtn" data-s="lyric" onclick="setStyle('lyric',this)">Lyric</button>
      <button class="sbtn" data-s="deep" onclick="setStyle('deep',this)">Deep</button>
      <button class="sbtn" data-s="natural" onclick="setStyle('natural',this)">Natural</button>
      <button class="sbtn" data-s="thump" onclick="setStyle('thump',this)">Thump</button>
      <button class="sbtn soff" data-s="off" onclick="setStyle('off',this)">Off â€” No EQ</button>
    </div>
    <div class="lr"><span class="ll">Intensity</span>
      <input type="range" class="sg" id="styleInt" min="0" max="20" value="10" step="1" oninput="onStyleInt(this)">
      <span class="vb" id="styleIntV">10</span>
    </div>
  </div>
  <div class="tc">
    <div class="tc-t tc-on">ğŸ›ï¸ Noise Reduction</div>
    <div class="tog-row">
      <label class="tog"><input type="checkbox" id="nrCb" onchange="onNR(this)"><div class="togsl"></div></label>
      <span id="nrLbl" style="font-size:12px;font-weight:600;color:var(--sub)">Off</span>
    </div>
    <div class="lr" style="margin-bottom:8px"><span class="ll">Amount</span>
      <input type="range" class="sg" id="nrAmt" min="0" max="20" value="10" step="1" oninput="onNRamt(this)" disabled>
      <span class="vb" id="nrAmtV">10</span>
    </div>
    <div style="font-size:9px;color:var(--sub);line-height:1.7">Removes amp hum, AC noise, static background floor.</div>
  </div>
  <div class="tc">
    <div class="tc-t tc-on">ğŸšï¸ Tone</div>
    <div class="trows">
      <div class="tr"><span class="tl">Treble</span>
        <input type="range" class="bs" id="toneTreble" min="-20" max="20" value="0" step="1" oninput="onTone('treble',this)">
        <span class="tv" id="vTreble">0</span>
      </div>
      <div class="tr"><span class="tl">Mids</span>
        <input type="range" class="bs" id="toneMids" min="-20" max="20" value="0" step="1" oninput="onTone('mids',this)">
        <span class="tv" id="vMids">0</span>
      </div>
      <div class="tr"><span class="tl">Bass</span>
        <input type="range" class="bs" id="toneBass" min="-20" max="20" value="0" step="1" oninput="onTone('bass',this)">
        <span class="tv" id="vBass">0</span>
      </div>
    </div>
    <div style="font-size:9px;color:var(--sub);margin-top:7px">âˆ’20 to +20 Â· Center: 0</div>
  </div>
  <div class="tc">
    <div class="tc-t tc-on">âš¡ Boost</div>
    <div class="lr"><span class="ll">Level</span>
      <input type="range" class="sg" id="boostSl" min="0" max="20" value="10" step="1" oninput="onBoost(this)">
      <span class="vb" id="boostV">10</span>
    </div>
    <div class="blv"><div class="blf" id="boostFill" style="width:50%"></div></div>
    <div style="font-size:9px;color:var(--sub);line-height:1.7">Professional compression + limiting. 0 = full dynamics. 20 = max loudness.</div>
  </div>
</div>

<!-- DOLBY ATMOS -->
<div class="sh">ğŸŒ Dolby Atmos â€” Spatial Audio<span></span></div>
<div class="atmos-w">
  <div class="tc-t tc-atm">Object-Based HRTF Binaural Â· 9.2.4 Virtual Speaker Array</div>
  <div class="amodes">
    <button class="ab" data-m="off" onclick="setAtmos('off',this)">âœ• Off</button>
    <button class="ab on" data-m="music" onclick="setAtmos('music',this)">ğŸµ Music</button>
    <button class="ab" data-m="movie" onclick="setAtmos('movie',this)">ğŸ¬ Movie</button>
    <button class="ab" data-m="game" onclick="setAtmos('game',this)">ğŸ® Game</button>
    <button class="ab" data-m="voice" onclick="setAtmos('voice',this)">ğŸ™ï¸ Voice</button>
    <button class="ab" data-m="spatial" onclick="setAtmos('spatial',this)">ğŸŒ€ Full Spatial</button>
    <button class="ab" data-m="concert" onclick="setAtmos('concert',this)">ğŸ· Concert</button>
  </div>
  <div id="atmosDesc" style="font-size:10px;color:var(--sub);line-height:1.7;margin-bottom:10px">
    Music: HRTF binaural Â· stereo widening Â· light room acoustics for music.
  </div>
  <div class="chmap">
    <div style="font-size:9px;font-weight:700;letter-spacing:1px;color:var(--acO);margin-bottom:4px">
      9.2.4 CHANNEL MAP Â· 15 VIRTUAL OBJECTS Â· LIVE LEVELS
    </div>
    <div class="chg" id="chGrid"></div>
  </div>
</div>

<!-- WAV CONVERTER â€” 192kHz/24-bit -->
<div class="sh">ğŸ’¾ Real-Time Converter â€” 192kHz / 24-bit<span></span></div>
<div class="wav-w">
  <div class="wav-s">
    <div class="wdot" id="wavDot"></div>
    <span id="wavTxt" style="font-size:11px;font-weight:700;color:var(--sub)">Converter Ready</span>
  </div>
  <div style="font-size:10px;color:var(--sub);line-height:1.8">
    Target: <strong style="color:var(--acG)">WAV 24-bit PCM / 192kHz</strong> Â·
    <strong style="color:#a090ff">9,216 kbps</strong> Â·
    <strong style="color:var(--acO)">9.2.4 (15ch)</strong>
    Â· Full DSP chain applied on export. Local files only â€” streaming providers prohibit audio re-encoding.
  </div>
  <div class="wbtns">
    <button class="wbtn p" onclick="exportWAV()">â¬‡ Export WAV (24-bit / 192kHz)</button>
    <button class="wbtn" onclick="exportInfo()">â„¹ Info</button>
  </div>
  <div class="wpr" id="wpr">
    <div class="wprbar"><div class="wprf" id="wprf"></div></div>
    <div id="wprtxt" style="font-size:10px;color:var(--sub);margin-top:3px"></div>
  </div>
</div>

<!-- PARAMETRIC EQ -->
<div class="sh">ğŸ”¬ Parametric EQ â€” 20Hz to 96kHz<span></span></div>
<div class="peq-w">
  <canvas id="peq" onclick="peqClick(event)"></canvas>
  <div class="pbands" id="pbands"></div>
  <div class="pctrl">
    <div class="pf"><label>TYPE</label>
      <select id="peqType" onchange="updatePeqBand()">
        <option value="peaking">Peaking</option>
        <option value="lowshelf">Low Shelf</option>
        <option value="highshelf">High Shelf</option>
        <option value="lowpass">Low Pass</option>
        <option value="highpass">High Pass</option>
        <option value="notch">Notch</option>
        <option value="bandpass">Band Pass</option>
        <option value="allpass">All Pass</option>
      </select>
    </div>
    <div class="pf"><label>FREQ (Hz)</label>
      <input type="number" id="peqFreq" min="20" max="96000" value="1000" onchange="updatePeqBand()">
    </div>
    <div class="pf"><label>GAIN (dB)</label>
      <input type="number" id="peqGain" min="-24" max="24" value="0" step="0.5" onchange="updatePeqBand()">
    </div>
    <div class="pf"><label>Q</label>
      <input type="number" id="peqQ" min="0.05" max="30" value="1.4" step="0.05" onchange="updatePeqBand()">
    </div>
    <button class="pbtn2" onclick="addPeqBand()">ï¼‹ Band</button>
    <button class="pbtn2 del" onclick="removePeqBand()">âˆ’ Band</button>
    <button class="pbtn2" onclick="resetPeq()">Reset</button>
  </div>
</div>

</div></div>
</div>

<!-- MODAL -->
<div class="modal-bg" id="modalBg" style="display:none" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <h2 id="modalTitle">Connect Platform</h2>
    <p id="modalDesc"></p>
    <div id="modalBody"></div>
    <div class="modal-btns">
      <button class="mbtn-cancel" onclick="closeModal()">Cancel</button>
      <button class="mbtn-connect" id="modalConnectBtn" onclick="doConnect()">Connect</button>
    </div>
  </div>
</div>

<audio id="mainAudio"></audio>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TARGET SPEC: 192kHz / 24-bit / 9,216 kbps
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TARGET_SR = 192000;   // 192 kHz sample rate
const TARGET_BIT = 24;      // 24-bit depth
const TARGET_CH  = 2;       // stereo output (internal 15ch HRTF mixdown)
// Calculated bitrate: 192000 * 24 * 2 = 9,216,000 bps = 9,216 kbps

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLATFORM CONFIGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PLATFORMS = {
  spotify:{name:'Spotify',icon:'ğŸµ',color:'var(--sp)',
    scope:'streaming user-read-email user-read-private user-library-read',
    sdkSrc:'https://sdk.scdn.co/spotify-player.js',
    desc:'Requires Spotify Premium. Create an app at developer.spotify.com, set Redirect URI to: '+location.origin+location.pathname,
    fields:[{id:'clientId',label:'CLIENT ID',placeholder:'Your Spotify Client ID'}]},
  deezer:{name:'Deezer',icon:'ğŸ¶',color:'var(--dz)',
    desc:'Create an app at developers.deezer.com. Free accounts get 30-sec previews; Premium gets full tracks.',
    fields:[{id:'appId',label:'APP ID',placeholder:'Your Deezer App ID'}]},
  tidal:{name:'Tidal',icon:'ğŸŒŠ',color:'var(--td)',
    desc:'Create an app at developer.tidal.com. Tidal uses OAuth 2.1 + PKCE. Paste your Client ID.',
    fields:[{id:'clientId',label:'CLIENT ID',placeholder:'Your Tidal Client ID'}]},
  apple:{name:'Apple Music',icon:'ğŸ',color:'var(--am)',
    desc:'Requires Apple Developer Program. Generate a MusicKit JWT at developer.apple.com â†’ Keys.',
    fields:[{id:'devToken',label:'DEVELOPER TOKEN (JWT)',placeholder:'eyJhbGci...'}]},
  youtube:{name:'YouTube',icon:'â–¶ï¸',color:'var(--yt)',
    desc:'Free â€” uses YouTube Data API v3. Get a key at console.cloud.google.com â†’ Enable YouTube Data API v3 â†’ Create credentials.',
    fields:[{id:'apiKey',label:'API KEY',placeholder:'AIzaSy...'}]}
};

const STATE = {connected:{},activePlatform:null,spotifyPlayer:null,ytPlayer:null,ytReady:false,mkInstance:null};
let pendingPlatform=null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUDIO ENGINE â€” 192kHz context
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const AUD = document.getElementById('mainAudio');
let ACX=null,srcNode=null,inited=false;
let compNode=null,analyserN=null,masterGain=null;
let nrNode=null,toneN={},styleN=[],peqNodes=[];
let convNode=null,dryG=null,wetG=null,panners=[];

let tracks=[],folders=[],curIdx=-1,doRepeat=false,doShuffle=false;
let styleKey='standard',styleInt_=10;
let nrOn=false,nrAmt_=10,boostLv=10;
let toneV={treble:0,mids:0,bass:0};
let atmosMode='music',selPeq=0;

// Auto-library state
let autoLibHandle=null, autoLibWatcher=null;

const CH_DEFS=[
  {name:'L',az:-30,el:0,dist:1,t:'bed'},{name:'C',az:0,el:0,dist:1,t:'bed'},{name:'R',az:30,el:0,dist:1,t:'bed'},
  {name:'Ls',az:-110,el:0,dist:1,t:'bed'},{name:'Rs',az:110,el:0,dist:1,t:'bed'},
  {name:'Lrs',az:-145,el:0,dist:1,t:'bed'},{name:'Rrs',az:145,el:0,dist:1,t:'bed'},
  {name:'Lw',az:-60,el:0,dist:1,t:'bed'},{name:'Rw',az:60,el:0,dist:1,t:'bed'},
  {name:'LFE1',az:0,el:-30,dist:.5,t:'sub'},{name:'LFE2',az:0,el:-30,dist:.5,t:'sub'},
  {name:'LTF',az:-45,el:45,dist:1.2,t:'height'},{name:'RTF',az:45,el:45,dist:1.2,t:'height'},
  {name:'LTR',az:-135,el:45,dist:1.2,t:'height'},{name:'RTR',az:135,el:45,dist:1.2,t:'height'},
];

const STYLE_EQ={
  standard:[{f:80,g:2,q:.7,t:'lowshelf'},{f:200,g:.5,q:1.8,t:'peaking'},{f:2500,g:1.5,q:1.2,t:'peaking'},{f:12e3,g:2,q:.8,t:'highshelf'}],
  amped:[{f:55,g:6,q:.7,t:'lowshelf'},{f:110,g:4,q:1.5,t:'peaking'},{f:450,g:-2,q:1.5,t:'peaking'},{f:3500,g:3,q:1.2,t:'peaking'},{f:10e3,g:5,q:.8,t:'highshelf'}],
  lyric:[{f:80,g:-1.5,q:.9,t:'lowshelf'},{f:700,g:1,q:2,t:'peaking'},{f:2400,g:4.5,q:1.2,t:'peaking'},{f:5e3,g:3,q:1.5,t:'peaking'},{f:14e3,g:1.5,q:.8,t:'highshelf'}],
  deep:[{f:38,g:8,q:.6,t:'lowshelf'},{f:75,g:6,q:1.2,t:'peaking'},{f:150,g:3,q:1.5,t:'peaking'},{f:380,g:-1,q:1.5,t:'peaking'},{f:8e3,g:-1,q:.8,t:'highshelf'}],
  natural:[{f:65,g:1,q:.8,t:'lowshelf'},{f:320,g:-.5,q:1.8,t:'peaking'},{f:1400,g:.5,q:2.5,t:'peaking'},{f:5500,g:.5,q:2,t:'peaking'},{f:13e3,g:1,q:.8,t:'highshelf'}],
  thump:[{f:38,g:7,q:.6,t:'lowshelf'},{f:60,g:5,q:1.3,t:'peaking'},{f:120,g:3,q:1.5,t:'peaking'},{f:500,g:-1,q:1.5,t:'peaking'},{f:2500,g:2,q:1.5,t:'peaking'},{f:10e3,g:1,q:.8,t:'highshelf'}],
  off:[]
};

const ATMOS_D={
  off:'Atmos disabled. Direct stereo output.',
  music:'Music: HRTF binaural Â· stereo widening Â· light room acoustics for music.',
  movie:'Movie: Wide cinematic soundstage Â· deep reverb Â· elevated LFE Â· overhead objects.',
  game:'Game: Precision 3D Â· minimal reverb Â· directional cues Â· fast transient response.',
  voice:'Voice: Center-focused Â· NR floor suppression Â· presence 2â€“5kHz Â· tight compression.',
  spatial:'Full Spatial: Maximum immersion Â· all 15 objects active Â· long room IR Â· 9.2.4 array.',
  concert:'Concert Hall: 30m reverb Â· early reflections from all angles Â· diffuse HF tail.'
};

let peqBands=[
  {f:20,g:0,q:.7,t:'lowshelf'},{f:60,g:0,q:1.4,t:'peaking'},
  {f:200,g:0,q:1.4,t:'peaking'},{f:600,g:0,q:1.4,t:'peaking'},
  {f:2000,g:0,q:1.4,t:'peaking'},{f:6000,g:0,q:1.4,t:'peaking'},
  {f:20000,g:0,q:1.4,t:'peaking'},{f:80000,g:0,q:.7,t:'highshelf'},
];

function initAudio(){
  if(inited)return; inited=true;
  // Create context at 192kHz
  ACX=new(window.AudioContext||window.webkitAudioContext)({sampleRate:TARGET_SR});
  srcNode=ACX.createMediaElementSource(AUD);
  compNode=ACX.createDynamicsCompressor(); applyBoost(boostLv);
  analyserN=ACX.createAnalyser(); analyserN.fftSize=2048; // larger for 192kHz precision
  masterGain=ACX.createGain(); masterGain.gain.value=.8;
  nrNode=ACX.createBiquadFilter(); nrNode.type='highpass'; nrNode.frequency.value=20; nrNode.Q.value=.5;
  const bF=ACX.createBiquadFilter(); bF.type='lowshelf'; bF.frequency.value=200; bF.gain.value=0;
  const mF=ACX.createBiquadFilter(); mF.type='peaking'; mF.frequency.value=1000; mF.Q.value=.8; mF.gain.value=0;
  const tF=ACX.createBiquadFilter(); tF.type='highshelf'; tF.frequency.value=5000; tF.gain.value=0;
  toneN={bass:bF,mids:mF,treble:tF};
  convNode=ACX.createConvolver(); buildImpulse(atmosMode);
  dryG=ACX.createGain(); dryG.gain.value=1;
  wetG=ACX.createGain(); wetG.gain.value=.08;
  rebuildPeqN(); buildPanners(); connectChain();
}

function buildImpulse(mode){
  if(!ACX||!convNode)return;
  const sr=ACX.sampleRate; // 192000
  const params={off:[.3,5],music:[.8,2.8],movie:[2.5,2],game:[.5,4],voice:[.25,5],spatial:[3.5,1.8],concert:[4,1.5]};
  const [dur,dec]=params[mode]||[.8,2.8];
  const len=Math.floor(sr*dur);
  const buf=ACX.createBuffer(2,len,sr);
  for(let c=0;c<2;c++){const d=buf.getChannelData(c);for(let i=0;i<len;i++)d[i]=(Math.random()*2-1)*Math.pow(1-i/len,dec);}
  convNode.buffer=buf;
}

function buildPanners(){
  panners.forEach(p=>{try{p.panner.disconnect();p.gain.disconnect();}catch(e){}});
  panners=CH_DEFS.map(ch=>{
    const p=ACX.createPanner();
    p.panningModel='HRTF'; p.distanceModel='inverse'; p.rolloffFactor=1;
    p.coneInnerAngle=360; p.coneOuterAngle=360; p.coneOuterGain=0;
    const a=ch.az*Math.PI/180,e=ch.el*Math.PI/180;
    p.positionX.value=ch.dist*Math.cos(e)*Math.sin(a);
    p.positionY.value=ch.dist*Math.sin(e);
    p.positionZ.value=-ch.dist*Math.cos(e)*Math.cos(a);
    const g=ACX.createGain(); g.gain.value=ch.t==='sub'?.85:ch.t==='height'?.7:1;
    return{panner:p,gain:g,...ch};
  });
}

function rebuildPeqN(){
  if(!ACX)return;
  peqNodes.forEach(n=>{try{n.disconnect();}catch(e){}});
  peqNodes=peqBands.map(b=>{
    const f=ACX.createBiquadFilter();
    // Clamp to Nyquist of 192kHz = 96kHz
    f.type=b.t; f.frequency.value=Math.max(20,Math.min(b.f,ACX.sampleRate*.499));
    f.gain.value=b.g; f.Q.value=b.q; return f;
  });
}

function connectChain(){
  if(!ACX||!srcNode)return;
  [srcNode,...styleN,nrNode,toneN.bass,toneN.mids,toneN.treble,...peqNodes,compNode,dryG,wetG,convNode,...panners.map(p=>p.panner),...panners.map(p=>p.gain),analyserN].forEach(n=>{if(n)try{n.disconnect();}catch(e){}});
  let n=srcNode;
  n.connect(nrNode); n=nrNode;
  styleN.forEach(f=>{n.connect(f);n=f;});
  n.connect(toneN.bass); n=toneN.bass;
  n.connect(toneN.mids); n=toneN.mids;
  n.connect(toneN.treble); n=toneN.treble;
  peqNodes.forEach(f=>{n.connect(f);n=f;});
  n.connect(compNode); n=compNode;
  if(atmosMode!=='off'){
    n.connect(dryG); n.connect(convNode); convNode.connect(wetG);
    panners.forEach(p=>{dryG.connect(p.panner);wetG.connect(p.panner);p.panner.connect(p.gain);p.gain.connect(analyserN);});
  } else { n.connect(analyserN); }
  analyserN.connect(masterGain); masterGain.connect(ACX.destination);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTO LIBRARY â€” File System Access API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const AUDIO_EXTS=/\.(mp3|flac|wav|aiff?|ogg|opus|m4a|aac|wma|alac|ape|dsf|dsd|wv|mp4|mka)$/i;

async function autoScanLib(){
  if(!window.showDirectoryPicker){
    // Fallback: trigger folder input
    document.getElementById('folderIn').click();
    return;
  }
  try{
    const dirHandle=await window.showDirectoryPicker({mode:'read'});
    autoLibHandle=dirHandle;
    document.getElementById('autoLibBanner').style.display='flex';
    document.getElementById('autoLibTxt').textContent='Scanning "'+dirHandle.name+'"â€¦';
    await scanDirectoryHandle(dirHandle, dirHandle.name);
    document.getElementById('autoLibTxt').textContent='Library: "'+dirHandle.name+'" Â· '+tracks.length+' tracks Â· monitoringâ€¦';
    // Start periodic watcher (every 30s for new files)
    clearInterval(autoLibWatcher);
    autoLibWatcher=setInterval(()=>refreshAutoLib(dirHandle),30000);
  }catch(e){
    if(e.name!=='AbortError') alert('Could not access folder: '+e.message);
  }
}

async function scanDirectoryHandle(dirHandle, folderName, recursive=true){
  const newTracks=[];
  for await(const [name,handle] of dirHandle.entries()){
    if(handle.kind==='file' && AUDIO_EXTS.test(name)){
      // Skip duplicates by name+folder
      const key=folderName+'/'+name;
      if(!tracks.find(t=>t._key===key)){
        try{
          const file=await handle.getFile();
          const url=URL.createObjectURL(file);
          newTracks.push({name:name.replace(/\.[^/.]+$/,''),url,folder:folderName,_key:key,_handle:handle});
        }catch(e){}
      }
    } else if(recursive && handle.kind==='directory'){
      await scanDirectoryHandle(handle, folderName+'/'+name, recursive);
    }
  }
  if(newTracks.length){
    const ex=folders.find(x=>x.name===folderName);
    if(ex) ex.tracks.push(...newTracks);
    else folders.push({name:folderName,tracks:newTracks,open:true});
    tracks.push(...newTracks);
    renderLib();
    if(curIdx<0&&tracks.length)loadTrack(0);
  }
  return newTracks.length;
}

async function refreshAutoLib(dirHandle){
  if(!dirHandle)return;
  const added=await scanDirectoryHandle(dirHandle, dirHandle.name);
  if(added>0){
    document.getElementById('autoLibTxt').textContent='Library updated +'+added+' tracks Â· "'+dirHandle.name+'" Â· '+tracks.length+' total';
    setTimeout(()=>{
      document.getElementById('autoLibTxt').textContent='Library: "'+dirHandle.name+'" Â· '+tracks.length+' tracks Â· monitoringâ€¦';
    },3000);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLATFORM CONNECT / OAUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openPlatform(id){
  const p=PLATFORMS[id];
  pendingPlatform=id;
  if(STATE.connected[id]){showStreamPanel(id);return;}
  document.getElementById('modalTitle').textContent='Connect '+p.name;
  document.getElementById('modalDesc').textContent='';
  let html=`<div class="pstep">${p.desc}</div>`;
  if(p.fields) p.fields.forEach(f=>{html+=`<label>${f.label}</label><input id="mf_${f.id}" type="text" placeholder="${f.placeholder}" autocomplete="off">`;});
  document.getElementById('modalBody').innerHTML=html;
  document.getElementById('modalBg').style.display='flex';
}
function closeModal(){document.getElementById('modalBg').style.display='none';pendingPlatform=null;}
async function doConnect(){
  const id=pendingPlatform; if(!id)return;
  const p=PLATFORMS[id]; const creds={};
  if(p.fields) p.fields.forEach(f=>{creds[f.id]=document.getElementById('mf_'+f.id).value.trim();});
  const first=p.fields&&p.fields[0]?creds[p.fields[0].id]:'';
  if(p.fields&&!first){alert('Please enter the required credentials.');return;}
  STATE.connected[id]={...creds}; closeModal();
  try{
    if(id==='spotify')await initSpotify(creds);
    else if(id==='deezer')await initDeezer(creds);
    else if(id==='tidal')await initTidal(creds);
    else if(id==='apple')await initApple(creds);
    else if(id==='youtube')await initYouTube(creds);
  }catch(e){
    alert('Connection error: '+e.message+'\n\nCheck credentials and try again.');
    delete STATE.connected[id]; updatePlatformUI(id,false); return;
  }
  updatePlatformUI(id,true); showStreamPanel(id);
}
function disconnectPlatform(){
  const id=STATE.activePlatform; if(!id)return;
  delete STATE.connected[id];
  if(id==='spotify'&&STATE.spotifyPlayer){try{STATE.spotifyPlayer.disconnect();}catch(e){} STATE.spotifyPlayer=null;}
  if(id==='youtube'&&STATE.ytPlayer){try{STATE.ytPlayer.destroy();}catch(e){} STATE.ytPlayer=null;}
  updatePlatformUI(id,false);
  document.getElementById('streamPanel').classList.remove('open');
  STATE.activePlatform=null; updateSrcBadge('LOCAL');
}
function updatePlatformUI(id,conn){
  const card=document.getElementById('pc-'+id),status=document.getElementById('ps-'+id);
  if(conn){card.classList.add('connected');status.textContent='CONNECTED';status.className='pstatus conn';}
  else{card.classList.remove('connected');status.textContent='CONNECT';status.className='pstatus disc';}
}
function showStreamPanel(id){
  STATE.activePlatform=id;
  const p=PLATFORMS[id],panel=document.getElementById('streamPanel');
  panel.classList.add('open');
  document.getElementById('streamLogo').textContent=p.icon;
  document.getElementById('streamTitle').textContent=p.name;
  document.getElementById('streamSub').textContent='Search '+p.name+' catalog';
  document.getElementById('sresults').innerHTML='';
  document.getElementById('searchInput').value='';
  updateSrcBadge(p.name.toUpperCase());
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLATFORM INITS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function generatePKCEVerifier(){const a=new Uint8Array(32);crypto.getRandomValues(a);return btoa(String.fromCharCode(...a)).replace(/\+/g,'-').replace(/\//g,'_').replace(/=/g,'');}
async function generatePKCEChallenge(v){const e=new TextEncoder(),d=await crypto.subtle.digest('SHA-256',e.encode(v));return btoa(String.fromCharCode(...new Uint8Array(d))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=/g,'');}

async function initSpotify({clientId}){
  const v=generatePKCEVerifier(),c=await generatePKCEChallenge(v);
  sessionStorage.setItem('sp_verifier',v); sessionStorage.setItem('sp_client',clientId);
  const params=new URLSearchParams({client_id:clientId,response_type:'code',redirect_uri:location.origin+location.pathname,scope:PLATFORMS.spotify.scope,code_challenge_method:'S256',code_challenge:c,state:'spotify_auth'});
  window.location.href='https://accounts.spotify.com/authorize?'+params;
}
async function spotifyHandleCallback(){
  const p=new URLSearchParams(location.search);
  if(p.get('state')!=='spotify_auth'||!p.get('code'))return;
  const code=p.get('code'),v=sessionStorage.getItem('sp_verifier'),cid=sessionStorage.getItem('sp_client');
  history.replaceState({},'',location.pathname);
  const res=await fetch('https://accounts.spotify.com/api/token',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:new URLSearchParams({grant_type:'authorization_code',code,redirect_uri:location.origin+location.pathname,client_id:cid,code_verifier:v})});
  const data=await res.json();
  if(data.access_token){STATE.connected.spotify={token:data.access_token,refreshToken:data.refresh_token,clientId:cid};updatePlatformUI('spotify',true);showStreamPanel('spotify');initSpotifySDK(data.access_token);return true;}
}
function initSpotifySDK(token){
  window.onSpotifyWebPlaybackSDKReady=()=>{
    const player=new Spotify.Player({name:'Dolby Unified Player',getOAuthToken:cb=>cb(token),volume:.8});
    player.addListener('ready',({device_id})=>{STATE.connected.spotify.deviceId=device_id;});
    player.connect(); STATE.spotifyPlayer=player;
  };
  if(!document.getElementById('spSDK')){const s=document.createElement('script');s.id='spSDK';s.src=PLATFORMS.spotify.sdkSrc;document.head.appendChild(s);}
}
async function initDeezer({appId}){
  await loadScript('https://e-cdns-files.dzcdn.net/js/min/dz.js');
  await new Promise(res=>{DZ.init({appId,channelUrl:location.origin+'/channel.html',player:{onload:res}});setTimeout(res,3000);});
  await new Promise((res,rej)=>{DZ.login(r=>{if(r.authResponse){STATE.connected.deezer.token=r.authResponse.accessToken;res();}else rej(new Error('Deezer login cancelled'));},{perms:'basic_access,email,offline_access,listening_history'});});
}
async function initTidal({clientId}){
  const v=generatePKCEVerifier(),c=await generatePKCEChallenge(v);
  sessionStorage.setItem('td_verifier',v); sessionStorage.setItem('td_client',clientId);
  const params=new URLSearchParams({response_type:'code',client_id:clientId,redirect_uri:location.origin+location.pathname,scope:'user.read collection.read playlists.read',code_challenge_method:'S256',code_challenge:c,state:'tidal_auth'});
  window.location.href='https://login.tidal.com/authorize?'+params;
}
async function tidalHandleCallback(){
  const p=new URLSearchParams(location.search);
  if(p.get('state')!=='tidal_auth'||!p.get('code'))return;
  const code=p.get('code'),v=sessionStorage.getItem('td_verifier'),cid=sessionStorage.getItem('td_client');
  history.replaceState({},'',location.pathname);
  const res=await fetch('https://auth.tidal.com/v1/oauth2/token',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:new URLSearchParams({grant_type:'authorization_code',code,redirect_uri:location.origin+location.pathname,client_id:cid,code_verifier:v})});
  const data=await res.json();
  if(data.access_token){STATE.connected.tidal={token:data.access_token,clientId:cid,countryCode:'US'};updatePlatformUI('tidal',true);showStreamPanel('tidal');return true;}
}
async function initApple({devToken}){
  if(!window.MusicKit)throw new Error('MusicKit JS not loaded. Try again.');
  const mk=await MusicKit.configure({developerToken:devToken,app:{name:'Dolby Unified Player',build:'1.0.0'}});
  await mk.authorize(); STATE.connected.apple.mk=mk; STATE.mkInstance=mk;
}
async function initYouTube({apiKey}){
  STATE.connected.youtube.apiKey=apiKey;
  await new Promise(res=>{
    window.onYouTubeIframeAPIReady=res;
    if(window.YT&&window.YT.Player){res();return;}
    const s=document.createElement('script');s.src='https://www.youtube.com/iframe_api';document.head.appendChild(s);
  });
  const container=document.getElementById('ytFrame'); container.style.display='block';
  STATE.ytPlayer=new YT.Player('ytFrame',{width:1,height:1,playerVars:{autoplay:0,controls:0,origin:location.origin},events:{
    onReady:()=>{STATE.ytReady=true;},
    onStateChange:e=>{
      if(e.data===YT.PlayerState.ENDED)document.getElementById('playBtn').textContent='â–¶';
      if(e.data===YT.PlayerState.PLAYING)document.getElementById('playBtn').textContent='â¸';
    }
  }});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SEARCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doSearch(){
  const q=document.getElementById('searchInput').value.trim(); if(!q)return;
  const id=STATE.activePlatform;
  document.getElementById('sresults').innerHTML='<div style="padding:12px;color:var(--sub);font-size:11px;text-align:center">Searchingâ€¦</div>';
  try{
    let results=[];
    if(id==='spotify')results=await searchSpotify(q);
    else if(id==='deezer')results=await searchDeezer(q);
    else if(id==='tidal')results=await searchTidal(q);
    else if(id==='apple')results=await searchApple(q);
    else if(id==='youtube')results=await searchYouTube(q);
    renderSearchResults(results,id);
  }catch(e){document.getElementById('sresults').innerHTML=`<div style="padding:12px;color:var(--red);font-size:11px">${e.message}</div>`;}
}
async function searchSpotify(q){
  const token=STATE.connected.spotify?.token; if(!token)throw new Error('Not authenticated');
  const r=await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(q)}&type=track&limit=10`,{headers:{Authorization:'Bearer '+token}});
  const d=await r.json(); if(d.error)throw new Error(d.error.message);
  return d.tracks.items.map(t=>({id:'spotify:track:'+t.id,name:t.name,artist:t.artists.map(a=>a.name).join(', '),duration:msToTime(t.duration_ms),art:t.album.images[0]?.url,uri:t.uri,platform:'spotify'}));
}
async function searchDeezer(q){
  const r=await fetch(`https://api.deezer.com/search?q=${encodeURIComponent(q)}&limit=10&output=json`);
  const d=await r.json(); if(d.error)throw new Error(d.error.message||'Deezer error');
  return (d.data||[]).map(t=>({id:'dz:'+t.id,name:t.title,artist:t.artist.name,duration:secToTime(t.duration),art:t.album.cover_small,preview:t.preview,platform:'deezer'}));
}
async function searchTidal(q){
  const token=STATE.connected.tidal?.token; if(!token)throw new Error('Not authenticated');
  const cc=STATE.connected.tidal.countryCode||'US';
  const r=await fetch(`https://openapi.tidal.com/v2/searchresults/${encodeURIComponent(q)}/relationships/tracks?countryCode=${cc}&include=tracks`,{headers:{Authorization:'Bearer '+token,'Content-Type':'application/vnd.tidal.v1+json'}});
  const d=await r.json();
  return (d.included||d.data||[]).slice(0,10).map(t=>{const a=t.attributes||{};return{id:'tidal:'+t.id,name:a.title||t.id,artist:a.artist||'',duration:a.duration||'',art:null,platform:'tidal'};});
}
async function searchApple(q){
  const mk=STATE.mkInstance; if(!mk)throw new Error('MusicKit not initialized');
  const r=await mk.api.music('/v1/catalog/us/search',{term:q,types:'songs',limit:10});
  return (r.data?.results?.songs?.data||[]).map(s=>({id:'am:'+s.id,name:s.attributes.name,artist:s.attributes.artistName,duration:msToTime(s.attributes.durationInMillis),art:s.attributes.artwork?.url?.replace('{w}','80').replace('{h}','80'),appleId:s.id,platform:'apple'}));
}
async function searchYouTube(q){
  const key=STATE.connected.youtube?.apiKey; if(!key)throw new Error('No API key');
  const r=await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(q)}&type=video&videoCategoryId=10&maxResults=10&key=${key}`);
  const d=await r.json(); if(d.error)throw new Error(d.error.message);
  return d.items.map(v=>({id:'yt:'+v.id.videoId,name:v.snippet.title,artist:v.snippet.channelTitle,duration:'',art:v.snippet.thumbnails?.default?.url,videoId:v.id.videoId,platform:'youtube'}));
}
function renderSearchResults(results,platform){
  const c=document.getElementById('sresults');
  if(!results.length){c.innerHTML='<div style="padding:12px;color:var(--sub);font-size:11px;text-align:center">No results found</div>';return;}
  c.innerHTML='';
  results.forEach(r=>{
    const d=document.createElement('div'); d.className='strack';
    d.innerHTML=`<div class="strack-art">${r.art?`<img src="${r.art}" alt="" onerror="this.parentNode.textContent='ğŸµ'">`:'ğŸµ'}</div>
      <div class="strack-info"><div class="strack-name">${escHtml(r.name)}</div><div class="strack-artist">${escHtml(r.artist||'')}</div></div>
      <span class="strack-dur">${r.duration||''}</span>
      <button class="strack-play">â–¶</button>`;
    d.querySelector('.strack-play').onclick=()=>playStreamTrack(r);
    d.onclick=e=>{if(e.target.tagName!=='BUTTON')playStreamTrack(r);};
    c.appendChild(d);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STREAM PLAYBACK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function playStreamTrack(track){
  STATE.currentPlatformTrack=track;
  document.getElementById('npTitle').textContent=track.name;
  document.getElementById('npSub').textContent=(track.artist||'')+(track.duration?' Â· '+track.duration:'');
  updateSrcBadge(PLATFORMS[track.platform].name.toUpperCase());
  if(track.platform==='spotify'){
    const dId=STATE.connected.spotify?.deviceId,token=STATE.connected.spotify?.token;
    if(!token)return;
    if(dId){await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${dId}`,{method:'PUT',headers:{Authorization:'Bearer '+token,'Content-Type':'application/json'},body:JSON.stringify({uris:[track.uri]})});document.getElementById('playBtn').textContent='â¸';}
    else alert('Spotify player not ready. Ensure Spotify app is open with Premium account.');
  } else if(track.platform==='deezer'){
    if(window.DZ){DZ.player.playTracks([track.id.replace('dz:','')]);document.getElementById('playBtn').textContent='â¸';}
    else if(track.preview){if(!inited)initAudio();AUD.src=track.preview;AUD.play();document.getElementById('playBtn').textContent='â¸';}
  } else if(track.platform==='apple'){
    if(STATE.mkInstance){await STATE.mkInstance.setQueue({song:track.appleId});await STATE.mkInstance.play();document.getElementById('playBtn').textContent='â¸';}
  } else if(track.platform==='youtube'){
    if(STATE.ytReady&&STATE.ytPlayer){STATE.ytPlayer.loadVideoById(track.videoId);STATE.ytPlayer.playVideo();document.getElementById('playBtn').textContent='â¸';}
  } else if(track.platform==='tidal'){
    alert('Tidal playback requires the official TIDAL SDK.\nOpen in TIDAL app:\nhttps://tidal.com/track/'+track.id.replace('tidal:',''));
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DOLBY ON TOOLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setStyle(key,btn){
  document.querySelectorAll('.sbtn').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on'); styleKey=key;
  if(inited)applyStyle();
}
function applyStyle(){
  styleN.forEach(n=>{try{n.disconnect();}catch(e){}});
  styleN=(STYLE_EQ[styleKey]||[]).map(b=>{
    const f=ACX.createBiquadFilter(); f.type=b.t; f.frequency.value=b.f; f.Q.value=b.q||1.4;
    f.gain.value=b.g*(styleInt_/10); return f;
  });
  connectChain();
}
function onStyleInt(el){
  styleInt_=+el.value; document.getElementById('styleIntV').textContent=styleInt_;
  el.style.setProperty('--p',(styleInt_/20*100)+'%');
  if(inited)applyStyle();
}
function onNR(cb){
  nrOn=cb.checked;
  const l=document.getElementById('nrLbl'); l.textContent=nrOn?'Active':'Off'; l.style.color=nrOn?'var(--acG)':'var(--sub)';
  document.getElementById('nrAmt').disabled=!nrOn;
  document.getElementById('bNR').className='tbadge '+(nrOn?'on-g':'off');
  document.getElementById('bNR').textContent=nrOn?'NR ON':'NR OFF';
  if(inited)applyNR();
}
function onNRamt(el){
  nrAmt_=+el.value; document.getElementById('nrAmtV').textContent=nrAmt_;
  el.style.setProperty('--p',(nrAmt_/20*100)+'%');
  if(inited)applyNR();
}
function applyNR(){
  if(!nrNode)return;
  // At 192kHz, NR highpass range is more effective
  nrNode.frequency.value=nrOn?20+(nrAmt_/20)*200:20;
  nrNode.Q.value=nrOn?.6+(nrAmt_/20)*1.8:.1;
}
function onTone(band,el){
  const v=+el.value; toneV[band]=v;
  const key=band.charAt(0).toUpperCase()+band.slice(1);
  document.getElementById('v'+key).textContent=(v>0?'+':'')+v;
  if(toneN[band])toneN[band].gain.value=v*.75;
}
function onBoost(el){
  boostLv=+el.value; document.getElementById('boostV').textContent=boostLv;
  document.getElementById('boostFill').style.width=(boostLv/20*100)+'%';
  el.style.setProperty('--p',(boostLv/20*100)+'%');
  applyBoost(boostLv);
}
function applyBoost(lv){
  if(!compNode)return;
  const t=lv/20;
  compNode.threshold.value=-44+t*24; compNode.ratio.value=3+t*17;
  compNode.knee.value=30-t*22; compNode.attack.value=.003; compNode.release.value=.30-t*.18;
  if(masterGain)masterGain.gain.value=.55+t*.85;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DOLBY ATMOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setAtmos(mode,btn){
  document.querySelectorAll('.ab').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on'); atmosMode=mode;
  document.getElementById('atmosDesc').textContent=ATMOS_D[mode];
  document.getElementById('bAtmos').className='tbadge '+(mode!=='off'?'on-o':'off');
  document.getElementById('bAtmos').textContent=mode==='off'?'ATMOS OFF':'ATMOS '+mode.toUpperCase();
  if(!ACX)return;
  buildImpulse(mode);
  const mx={off:[0,1],music:[.08,1],movie:[.35,.88],game:[.12,1],voice:[.04,1],spatial:[.45,.85],concert:[.5,.82]};
  const [w,d]=mx[mode]||[.08,1];
  wetG.gain.value=w; dryG.gain.value=d;
  if(mode==='spatial'||mode==='concert')panners.forEach(p=>{if(p.t==='height')p.gain.gain.value=.9;});
  if(mode==='voice'){compNode.ratio.value=18;compNode.threshold.value=-32;}
  else if(mode==='movie'){compNode.ratio.value=10;compNode.threshold.value=-22;}
  else applyBoost(boostLv);
  connectChain();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHANNEL MAP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildChMap(){
  const g=document.getElementById('chGrid'); g.innerHTML='';
  CH_DEFS.forEach((ch,i)=>{
    const d=document.createElement('div');
    d.className='chc '+(ch.t==='sub'?'sub':ch.t==='height'?'height':'');
    d.id='ch_'+i;
    d.innerHTML=`<div class="chn">${ch.name}</div><div class="chd">âˆ’âˆ</div>
      <div class="chl"><div class="chb" id="cb_${i}" style="background:${ch.t==='sub'?'var(--acc)':ch.t==='height'?'var(--acG)':'var(--acO)'}"></div></div>`;
    g.appendChild(d);
  });
}
buildChMap();
function animateCh(){
  requestAnimationFrame(animateCh);
  if(!analyserN)return;
  const d=new Uint8Array(analyserN.frequencyBinCount); analyserN.getByteFrequencyData(d);
  const bins=d.length;
  CH_DEFS.forEach((ch,i)=>{
    let s=0,e=0;
    if(ch.t==='sub'){s=0;e=Math.floor(bins*.02);} // sub-bass at 192kHz Nyquist
    else if(ch.t==='height'){s=Math.floor(bins*.15);e=Math.floor(bins*.6);}
    else{const sp=i/9;s=Math.floor(bins*sp*.85);e=Math.floor(bins*(sp*.85+.1));}
    let sum=0,cnt=0;
    for(let j=s;j<e&&j<bins;j++){sum+=d[j];cnt++;}
    const pct=cnt>0?(sum/cnt)/255*100:0;
    const bar=document.getElementById('cb_'+i);
    if(bar)bar.style.width=pct+'%';
    const db=document.querySelector('#ch_'+i+' .chd');
    if(db)db.textContent=pct>0?(20*Math.log10(pct/100)).toFixed(0)+'dB':'âˆ’âˆ';
  });
}
animateCh();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WAV EXPORT â€” 24-bit / 192kHz
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportInfo(){
  alert('WAV Spec:\nâ€¢ 24-bit integer PCM\nâ€¢ 192,000 Hz sample rate\nâ€¢ 2ch stereo (full 15ch HRTF internal mixdown)\nâ€¢ RIFF PCM header (type=1)\nâ€¢ Bitrate: 9,216 kbps\nâ€¢ All Dolby On DSP applied on render\n\nNote: Local files only. Streaming providers prohibit audio capture/re-encoding per their Terms of Service.');
}

async function exportWAV(){
  if(!tracks.length||curIdx<0){alert('Load a local file first. Streaming tracks cannot be exported.');return;}
  const btn=document.querySelector('.wbtn.p');
  btn.textContent='â³ Renderingâ€¦'; btn.disabled=true;
  document.getElementById('wpr').style.display='block';
  document.getElementById('wavDot').classList.add('act');
  document.getElementById('wavTxt').textContent='Rendering at 192kHzâ€¦';
  try{
    const url=tracks[curIdx].url;
    document.getElementById('wprf').style.width='10%';
    document.getElementById('wprtxt').textContent='Fetching audioâ€¦';
    const resp=await fetch(url);
    const ab=await resp.arrayBuffer();
    document.getElementById('wprf').style.width='25%';
    // Decode to determine duration
    const tmp=new AudioContext();
    const tb=await tmp.decodeAudioData(ab.slice(0));
    await tmp.close();
    const dur=tb.duration;
    const len=Math.floor(dur*TARGET_SR);
    document.getElementById('wprf').style.width='40%';
    document.getElementById('wprtxt').textContent='Building offline context at 192kHzâ€¦';
    // OfflineAudioContext at 192kHz, stereo output
    const OAC=new OfflineAudioContext(TARGET_CH, len, TARGET_SR);
    const sb=await OAC.decodeAudioData(ab.slice(0));
    const s=OAC.createBufferSource(); s.buffer=sb;
    let n=s;
    // NR
    const oNR=OAC.createBiquadFilter();
    oNR.type='highpass'; oNR.frequency.value=nrOn?20+(nrAmt_/20)*200:20; oNR.Q.value=nrOn?.6+(nrAmt_/20)*1.8:.1;
    n.connect(oNR); n=oNR;
    // Style
    (STYLE_EQ[styleKey]||[]).forEach(b=>{const f=OAC.createBiquadFilter();f.type=b.t;f.frequency.value=b.f;f.Q.value=b.q||1.4;f.gain.value=b.g*(styleInt_/10);n.connect(f);n=f;});
    // Tone
    const oB=OAC.createBiquadFilter();oB.type='lowshelf';oB.frequency.value=200;oB.gain.value=toneV.bass*.75;
    const oM=OAC.createBiquadFilter();oM.type='peaking';oM.frequency.value=1000;oM.Q.value=.8;oM.gain.value=toneV.mids*.75;
    const oT=OAC.createBiquadFilter();oT.type='highshelf';oT.frequency.value=5000;oT.gain.value=toneV.treble*.75;
    n.connect(oB);n=oB;n.connect(oM);n=oM;n.connect(oT);n=oT;
    // PEQ â€” clamp to 192kHz Nyquist (96kHz)
    peqBands.forEach(b=>{
      const f=OAC.createBiquadFilter();
      f.type=b.t; f.frequency.value=Math.max(20,Math.min(b.f,TARGET_SR*.499));
      f.Q.value=b.q; f.gain.value=b.g;
      n.connect(f); n=f;
    });
    // Compressor
    const oC=OAC.createDynamicsCompressor();
    const t_=boostLv/20;
    oC.threshold.value=-44+t_*24; oC.ratio.value=3+t_*17; oC.knee.value=30-t_*22;
    oC.attack.value=.003; oC.release.value=.30-t_*.18;
    n.connect(oC);
    const oG=OAC.createGain(); oG.gain.value=.55+t_*.85;
    oC.connect(oG); oG.connect(OAC.destination);
    s.start(0);
    document.getElementById('wprf').style.width='60%';
    document.getElementById('wprtxt').textContent='Rendering DSP chain at 192kHzâ€¦';
    const rendered=await OAC.startRendering();
    document.getElementById('wprf').style.width='85%';
    document.getElementById('wprtxt').textContent='Encoding 24-bit WAVâ€¦';
    const blob=encodeWAV24(rendered);
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download=(tracks[curIdx].name||'export').replace(/[^a-z0-9]/gi,'_')+'_24bit_192kHz.wav';
    a.click();
    document.getElementById('wprf').style.width='100%';
    document.getElementById('wprtxt').textContent='Export complete â€” '+TARGET_SR/1000+'kHz / '+TARGET_BIT+'-bit';
    document.getElementById('wavTxt').textContent='Export Complete âœ“';
  }catch(e){
    document.getElementById('wavTxt').textContent='Error: '+e.message;
    document.getElementById('wavTxt').style.color='var(--red)';
    console.error(e);
  }
  btn.textContent='â¬‡ Export WAV (24-bit / 192kHz)'; btn.disabled=false;
  setTimeout(()=>{document.getElementById('wavDot').classList.remove('act');document.getElementById('wavTxt').style.color='var(--sub)';document.getElementById('wavTxt').textContent='Converter Ready';},5000);
}

// Encode rendered AudioBuffer â†’ 24-bit integer PCM WAV
function encodeWAV24(buf){
  const nc=buf.numberOfChannels, sr=buf.sampleRate, ns=buf.length;
  const bp=3; // bytes per sample â€” 24-bit = 3 bytes
  const dl=ns*nc*bp;
  const ab=new ArrayBuffer(44+dl), v=new DataView(ab);
  const ws=(o,s)=>{for(let i=0;i<s.length;i++)v.setUint8(o+i,s.charCodeAt(i));};
  ws(0,'RIFF'); v.setUint32(4,36+dl,true); ws(8,'WAVE');
  ws(12,'fmt '); v.setUint32(16,16,true);
  v.setUint16(20,1,true);           // PCM = 1
  v.setUint16(22,nc,true);
  v.setUint32(24,sr,true);
  v.setUint32(28,sr*nc*bp,true);    // byte rate
  v.setUint16(32,nc*bp,true);       // block align
  v.setUint16(34,TARGET_BIT,true);  // 24 bits
  ws(36,'data'); v.setUint32(40,dl,true);
  let off=44;
  // Interleave channels, convert float32 â†’ int24
  for(let i=0;i<ns;i++){
    for(let c=0;c<nc;c++){
      // Clamp float to [-1,1], scale to 24-bit signed integer range
      const s=Math.max(-1,Math.min(1,buf.getChannelData(c)[i]));
      const int24=Math.round(s*8388607); // 2^23 - 1
      // Write 3 bytes little-endian
      v.setUint8(off,   int24 & 0xFF);
      v.setUint8(off+1,(int24 >> 8) & 0xFF);
      v.setUint8(off+2,(int24 >> 16) & 0xFF);
      off+=3;
    }
  }
  return new Blob([ab],{type:'audio/wav'});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARAMETRIC EQ â€” range to 96kHz Nyquist
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPeqUI(){
  const row=document.getElementById('pbands'); row.innerHTML='';
  peqBands.forEach((b,i)=>{
    const d=document.createElement('div');
    d.className='pb'+(i===selPeq?' sel':'');
    d.innerHTML=`<div class="pbf">${fmtF(b.f)}</div><div class="pbg">${b.g>0?'+':''}${b.g}dB</div><div class="pbt">${b.t}</div>`;
    d.onclick=()=>{selPeq=i;renderPeqUI();};
    row.appendChild(d);
  });
  const b=peqBands[selPeq];
  if(b){document.getElementById('peqType').value=b.t;document.getElementById('peqFreq').value=b.f;document.getElementById('peqGain').value=b.g;document.getElementById('peqQ').value=b.q;}
  drawPeq();
}
function updatePeqBand(){
  if(!peqBands[selPeq])return;
  peqBands[selPeq]={t:document.getElementById('peqType').value,f:Math.max(20,Math.min(96000,+document.getElementById('peqFreq').value)),g:+document.getElementById('peqGain').value,q:+document.getElementById('peqQ').value};
  if(ACX){const n=peqNodes[selPeq];if(n){const b=peqBands[selPeq];n.type=b.t;n.frequency.value=Math.max(20,Math.min(b.f,ACX.sampleRate*.499));n.gain.value=b.g;n.Q.value=b.q;}}
  renderPeqUI();
}
function addPeqBand(){peqBands.push({f:1000,g:0,q:1.4,t:'peaking'});selPeq=peqBands.length-1;if(ACX){rebuildPeqN();connectChain();}renderPeqUI();}
function removePeqBand(){if(peqBands.length<=1)return;peqBands.splice(selPeq,1);selPeq=Math.max(0,selPeq-1);if(ACX){rebuildPeqN();connectChain();}renderPeqUI();}
function resetPeq(){peqBands=[{f:20,g:0,q:.7,t:'lowshelf'},{f:60,g:0,q:1.4,t:'peaking'},{f:200,g:0,q:1.4,t:'peaking'},{f:600,g:0,q:1.4,t:'peaking'},{f:2000,g:0,q:1.4,t:'peaking'},{f:6000,g:0,q:1.4,t:'peaking'},{f:20000,g:0,q:1.4,t:'peaking'},{f:80000,g:0,q:.7,t:'highshelf'}];selPeq=0;if(ACX){rebuildPeqN();connectChain();}renderPeqUI();}
function peqClick(e){
  const c=e.target,r=c.getBoundingClientRect(),x=(e.clientX-r.left)/r.width,y=(e.clientY-r.top)/r.height;
  peqBands[selPeq].f=Math.round(20*Math.pow(96000/20,x));
  peqBands[selPeq].g=Math.max(-24,Math.min(24,Math.round((.5-y)*48)));
  updatePeqBand();
}
function drawPeq(){
  const canvas=document.getElementById('peq'),W=canvas.width,H=canvas.height;
  if(!W||!H)return;
  const c=canvas.getContext('2d'); c.clearRect(0,0,W,H);
  c.strokeStyle='#111120'; c.lineWidth=1;
  [20,100,500,2e3,10e3,40e3,96e3].forEach(f=>{
    const x=fToX(f,W); c.beginPath();c.moveTo(x,0);c.lineTo(x,H);c.stroke();
    c.fillStyle='#252540';c.font='9px sans-serif';c.fillText(fmtF(f),x+2,H-3);
  });
  [-18,-12,-6,0,6,12,18].forEach(g=>{const y=gToY(g,H);c.strokeStyle=g===0?'#20203a':'#111120';c.beginPath();c.moveTo(0,y);c.lineTo(W,y);c.stroke();});
  const SR=ACX?ACX.sampleRate:TARGET_SR; // 192000
  const freqs=Array.from({length:W},(_,i)=>20*Math.pow(96000/20,i/W));
  const sum=new Float32Array(W);
  peqBands.forEach(b=>{const mg=biquadMag(b,freqs,SR);for(let i=0;i<W;i++)sum[i]+=mg[i];});
  const gr=c.createLinearGradient(0,0,W,0);
  gr.addColorStop(0,'#6344f5');gr.addColorStop(.5,'#a060ff');gr.addColorStop(1,'#ff6b35');
  c.beginPath();c.strokeStyle=gr;c.lineWidth=2;
  for(let i=0;i<W;i++){const y=gToY(sum[i],H);i===0?c.moveTo(i,y):c.lineTo(i,y);}
  c.stroke();
  peqBands.forEach((b,i)=>{const x=fToX(b.f,W),y=gToY(b.g,H);c.beginPath();c.arc(x,y,i===selPeq?6:4,0,Math.PI*2);c.fillStyle=i===selPeq?'#ff6b35':'#6344f5';c.fill();});
}
function fmtF(f){return f>=1000?(f/1000).toFixed(f%1000===0?0:1)+'k':f+'Hz';}
function fToX(f,W){return W*Math.log(f/20)/Math.log(96000/20);}
function gToY(g,H){return H*(.5-g/48);}
function biquadMag(band,freqs,SR){
  const out=new Float32Array(freqs.length);
  const f0=band.f,G=band.g,Q=Math.max(band.q,.01),type=band.type||band.t;
  const A=Math.pow(10,G/40),sqA=Math.sqrt(A);
  freqs.forEach((f,i)=>{
    const w0=2*Math.PI*f0/SR,cw=Math.cos(w0),sw=Math.sin(w0),alpha=sw/(2*Q);
    let b0,b1,b2,a0,a1,a2;
    if(type==='peaking'){b0=1+alpha*A;b1=-2*cw;b2=1-alpha*A;a0=1+alpha/A;a1=-2*cw;a2=1-alpha/A;}
    else if(type==='lowshelf'){b0=A*((A+1)-(A-1)*cw+2*sqA*alpha);b1=2*A*((A-1)-(A+1)*cw);b2=A*((A+1)-(A-1)*cw-2*sqA*alpha);a0=(A+1)+(A-1)*cw+2*sqA*alpha;a1=-2*((A-1)+(A+1)*cw);a2=(A+1)+(A-1)*cw-2*sqA*alpha;}
    else if(type==='highshelf'){b0=A*((A+1)+(A-1)*cw+2*sqA*alpha);b1=-2*A*((A-1)+(A+1)*cw);b2=A*((A+1)+(A-1)*cw-2*sqA*alpha);a0=(A+1)-(A-1)*cw+2*sqA*alpha;a1=2*((A-1)-(A+1)*cw);a2=(A+1)-(A-1)*cw-2*sqA*alpha;}
    else if(type==='lowpass'){b0=(1-cw)/2;b1=1-cw;b2=(1-cw)/2;a0=1+alpha;a1=-2*cw;a2=1-alpha;}
    else if(type==='highpass'){b0=(1+cw)/2;b1=-(1+cw);b2=(1+cw)/2;a0=1+alpha;a1=-2*cw;a2=1-alpha;}
    else if(type==='notch'){b0=1;b1=-2*cw;b2=1;a0=1+alpha;a1=-2*cw;a2=1-alpha;}
    else if(type==='bandpass'){b0=alpha;b1=0;b2=-alpha;a0=1+alpha;a1=-2*cw;a2=1-alpha;}
    else{out[i]=0;return;}
    const w=2*Math.PI*f/SR;
    const cr={r:Math.cos(-w),i:Math.sin(-w)},cr2={r:Math.cos(-2*w),i:Math.sin(-2*w)};
    const nR=(b0+b1*cr.r+b2*cr2.r)/a0,nI=(b1*cr.i+b2*cr2.i)/a0;
    const dR=1+(a1*cr.r+a2*cr2.r)/a0,dI=(a1*cr.i+a2*cr2.i)/a0;
    const den=dR*dR+dI*dI;
    const hR=(nR*dR+nI*dI)/den,hI=(nI*dR-nR*dI)/den;
    out[i]=20*Math.log10(Math.max(1e-10,Math.sqrt(hR*hR+hI*hI)));
  });
  return out;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOCAL LIBRARY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function scanFolder(){document.getElementById('folderIn').click();}
function onFolderScan(e){
  const files=Array.from(e.target.files).filter(f=>f.type.startsWith('audio/')||AUDIO_EXTS.test(f.name));
  if(!files.length)return;
  const map={};
  files.forEach(f=>{const p=f.webkitRelativePath.split('/');const fd=p.length>1?p[0]:'Root';(map[fd]=map[fd]||[]).push(f);});
  Object.entries(map).forEach(([nm,fls])=>{
    const nt=fls.map(f=>({name:f.name.replace(/\.[^/.]+$/,''),url:URL.createObjectURL(f),folder:nm}));
    const ex=folders.find(x=>x.name===nm);
    if(ex)ex.tracks.push(...nt); else folders.push({name:nm,tracks:nt,open:true});
    tracks.push(...nt);
  });
  renderLib(); if(curIdx<0&&tracks.length)loadTrack(0);
}
function onFileIn(e){
  const files=Array.from(e.target.files).filter(f=>f.type.startsWith('audio/')||AUDIO_EXTS.test(f.name));
  addFiles(files,'Dropped Files');
}
function addFiles(files,fn){
  if(!files.length)return;
  const nt=files.map(f=>({name:f.name.replace(/\.[^/.]+$/,''),url:URL.createObjectURL(f),folder:fn}));
  const ex=folders.find(x=>x.name===fn);
  if(ex)ex.tracks.push(...nt); else folders.push({name:fn,tracks:nt,open:true});
  tracks.push(...nt); renderLib(); if(curIdx<0&&tracks.length)loadTrack(0);
}
function renderLib(){
  const scroll=document.getElementById('libScroll');
  document.getElementById('libEmpty').style.display=folders.length?'none':'block';
  scroll.querySelectorAll('.frow,.trow').forEach(e=>e.remove());
  folders.forEach(fd=>{
    const fr=document.createElement('div');
    fr.className='frow'+(fd.open?' open':'');
    fr.innerHTML=`<span class="fi">â–¶</span><div style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${fd.name}</div><div class="fmeta">${fd.tracks.length}</div>`;
    fr.onclick=()=>{fd.open=!fd.open;renderLib();};
    scroll.appendChild(fr);
    if(fd.open)fd.tracks.forEach(t=>{
      const idx=tracks.indexOf(t);
      const tr=document.createElement('div');
      tr.className='trow'+(idx===curIdx?' act':'');
      tr.innerHTML=`<span class="tname">${t.name}</span>`;
      tr.onclick=()=>{loadTrack(idx);playAudio();};
      scroll.appendChild(tr);
    });
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLAYBACK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadTrack(idx){
  curIdx=idx; const t=tracks[idx];
  AUD.src=t.url; AUD.load();
  document.getElementById('npTitle').textContent=t.name;
  document.getElementById('npSub').textContent=t.folder||'';
  updateSrcBadge('LOCAL'); renderLib();
}
function playAudio(){
  if(!inited)initAudio();
  if(ACX.state==='suspended')ACX.resume();
  AUD.play(); document.getElementById('playBtn').textContent='â¸';
}
function pauseAudio(){AUD.pause();document.getElementById('playBtn').textContent='â–¶';}
function togglePlay(){
  if(STATE.activePlatform==='youtube'&&STATE.ytPlayer&&STATE.ytReady){
    const st=STATE.ytPlayer.getPlayerState();
    if(st===1){STATE.ytPlayer.pauseVideo();document.getElementById('playBtn').textContent='â–¶';}
    else{STATE.ytPlayer.playVideo();document.getElementById('playBtn').textContent='â¸';}
    return;
  }
  if(STATE.activePlatform==='spotify'&&STATE.spotifyPlayer){
    STATE.spotifyPlayer.togglePlay();
    STATE.spotifyPlayer.getCurrentState().then(s=>{document.getElementById('playBtn').textContent=s&&s.paused?'â–¶':'â¸';});
    return;
  }
  if(STATE.activePlatform==='apple'&&STATE.mkInstance){
    STATE.mkInstance.isPlaying?STATE.mkInstance.pause():STATE.mkInstance.play();return;
  }
  if(!tracks.length){document.getElementById('fileIn').click();return;}
  if(curIdx<0){loadTrack(0);playAudio();return;}
  if(!inited)initAudio();
  if(ACX.state==='suspended')ACX.resume();
  AUD.paused?playAudio():pauseAudio();
}
function prevTrk(){if(!tracks.length)return;const i=doShuffle?Math.floor(Math.random()*tracks.length):Math.max(0,curIdx-1);loadTrack(i);playAudio();}
function nextTrk(){if(!tracks.length)return;let i=doShuffle?Math.floor(Math.random()*tracks.length):curIdx+1;if(i>=tracks.length)i=0;loadTrack(i);playAudio();}
function toggleRepeat(){doRepeat=!doRepeat;document.getElementById('repBtn').classList.toggle('on',doRepeat);AUD.loop=doRepeat;}
function toggleShuffle(){doShuffle=!doShuffle;document.getElementById('shufBtn').classList.toggle('on',doShuffle);}
function seek(v){if(AUD.duration)AUD.currentTime=AUD.duration*(v/100);}
function setVol(v){
  if(masterGain)masterGain.gain.value=+v*(.55+(boostLv/20)*.85); else AUD.volume=+v;
  if(STATE.ytPlayer&&STATE.ytReady)STATE.ytPlayer.setVolume(+v*100);
  if(STATE.spotifyPlayer)STATE.spotifyPlayer.setVolume(+v);
}
function fmtT(s){s=s||0;return Math.floor(s/60)+':'+String(Math.floor(s%60)).padStart(2,'0');}
AUD.addEventListener('timeupdate',()=>{
  const d=AUD.duration||1;
  document.getElementById('seekBar').value=(AUD.currentTime/d)*100;
  document.getElementById('tCur').textContent=fmtT(AUD.currentTime);
  document.getElementById('tDur').textContent=fmtT(AUD.duration);
});
AUD.addEventListener('ended',()=>{if(!doRepeat)nextTrk();});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VISUALIZER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const vizC=document.getElementById('viz');
function resizeViz(){vizC.width=vizC.offsetWidth*devicePixelRatio;vizC.height=vizC.offsetHeight*devicePixelRatio;}
resizeViz(); window.addEventListener('resize',()=>{resizeViz();resizePeqC();});
function drawViz(){
  requestAnimationFrame(drawViz);
  const ct=vizC.getContext('2d'),W=vizC.width,H=vizC.height;
  ct.clearRect(0,0,W,H);
  if(!analyserN)return;
  const data=new Uint8Array(analyserN.frequencyBinCount);
  analyserN.getByteFrequencyData(data);
  const bw=W/data.length*2.4;
  for(let i=0;i<data.length;i++){
    const p=i/data.length,h=(data[i]/255)*H;
    ct.fillStyle=`rgb(${Math.round(99+p*156)},${Math.round(68+p*39)},${Math.round(245+p*(53-245))})`;
    ct.fillRect(i*bw*1.15,H-h,bw,h);
  }
}
drawViz();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PEQ CANVAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const peqC=document.getElementById('peq');
function resizePeqC(){peqC.width=peqC.offsetWidth;peqC.height=120;drawPeq();}
setTimeout(resizePeqC,100);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRAG & DROP â€” auto-detect all audio
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doDragOver(e){e.preventDefault();document.getElementById('dropZ').classList.add('drag');}
function doDragLeave(){document.getElementById('dropZ').classList.remove('drag');}
function doDrop(e){
  e.preventDefault(); doDragLeave();
  const files=Array.from(e.dataTransfer.files).filter(f=>f.type.startsWith('audio/')||AUDIO_EXTS.test(f.name));
  addFiles(files,'Dropped Files');
}

// Also listen for drop on the whole app for convenience
document.body.addEventListener('dragover',e=>{if(e.dataTransfer.types.includes('Files')){e.preventDefault();}});
document.body.addEventListener('drop',e=>{
  const files=Array.from(e.dataTransfer.files).filter(f=>f.type.startsWith('audio/')||AUDIO_EXTS.test(f.name));
  if(files.length){e.preventDefault();addFiles(files,'Dropped Files');}
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function msToTime(ms){const s=Math.floor(ms/1000);return Math.floor(s/60)+':'+String(s%60).padStart(2,'0');}
function secToTime(s){return Math.floor(s/60)+':'+String(s%60).padStart(2,'0');}
function escHtml(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function loadScript(src){return new Promise((res,rej)=>{const s=document.createElement('script');s.src=src;s.onload=res;s.onerror=()=>rej(new Error('Failed to load '+src));document.head.appendChild(s);});}
function updateSrcBadge(txt){
  const b=document.getElementById('srcBadge');
  b.textContent=txt;
  const colors={SPOTIFY:'var(--sp)',DEEZER:'var(--dz)',TIDAL:'var(--td)','APPLE MUSIC':'var(--am)','YOUTUBE':'var(--yt)',LOCAL:'var(--border)'};
  const c=colors[txt]||'var(--border)';
  b.style.borderColor=c; b.style.color=txt==='LOCAL'?'var(--sub)':c;
  b.style.background=txt==='LOCAL'?'rgba(255,255,255,.02)':`color-mix(in srgb,${c} 10%,transparent)`;
  document.getElementById('bSrc').textContent=txt;
  document.getElementById('bSrc').className='tbadge '+(txt==='LOCAL'?'off':'on-a');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OAUTH CALLBACK HANDLING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(async()=>{
  const p=new URLSearchParams(location.search);
  if(p.get('state')==='spotify_auth')await spotifyHandleCallback();
  if(p.get('state')==='tidal_auth')await tidalHandleCallback();
})();

// Init slider fills
document.getElementById('styleInt').style.setProperty('--p','50%');
document.getElementById('nrAmt').style.setProperty('--p','50%');
document.getElementById('boostSl').style.setProperty('--p','50%');
renderPeqUI();
</script>
</body>
</html>