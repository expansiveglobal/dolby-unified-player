<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Dolby Unified Player</title>
<script src="https://js-cdn.music.apple.com/musickit/v3/musickit.js" async></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#07070f;--panel:#0e0e1a;--card:#141422;--card2:#1a1a28;
  --border:#22223a;--acc:#6344f5;--acO:#ff6b35;--acG:#00e5a0;
  --text:#dde0f0;--sub:#55557a;--red:#ff3366;
  --sp:#1db954;--dz:#ef5466;--td:#00ffff;--am:#fc3c44;--yt:#ff0000;
}
body{background:var(--bg);color:var(--text);font-family:'Segoe UI',system-ui,sans-serif;min-height:100vh;overflow-x:hidden}
.app{display:grid;grid-template-columns:230px 1fr;grid-template-rows:48px 1fr;height:100vh;overflow:hidden}
.topbar{grid-column:1/-1;background:var(--panel);border-bottom:1px solid var(--border);
  display:flex;align-items:center;padding:0 14px;gap:10px;z-index:20;flex-shrink:0}
.logo{font-weight:900;font-size:15px;background:linear-gradient(90deg,#6344f5,#ff6b35);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:.5px;flex-shrink:0}
.logo sub{font-size:9px;font-weight:400;-webkit-text-fill-color:var(--sub);letter-spacing:2px;display:block;margin-top:-2px}
.tbadge{padding:2px 8px;border-radius:9px;font-size:9px;font-weight:800;letter-spacing:1px;border:1px solid;cursor:default;flex-shrink:0;text-transform:uppercase}
.off{color:var(--sub);border-color:var(--border);background:transparent}
.on-g{color:var(--acG);border-color:var(--acG);background:rgba(0,229,160,.07)}
.on-o{color:var(--acO);border-color:var(--acO);background:rgba(255,107,53,.07)}
.on-a{color:var(--acc);border-color:var(--acc);background:rgba(99,68,245,.07)}
.sidebar{background:var(--panel);border-right:1px solid var(--border);overflow-y:auto;display:flex;flex-direction:column;min-height:0}
.shdr{padding:10px 12px 7px;font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--sub);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.shdr-btns{display:flex;gap:5px}
.ibtn{background:rgba(99,68,245,.15);border:1px solid rgba(99,68,245,.35);color:#9080ff;padding:2px 8px;border-radius:5px;cursor:pointer;font-size:9px;transition:.2s}
.ibtn:hover{background:rgba(99,68,245,.3)}
.ibtn.green{background:rgba(0,229,160,.1);border-color:rgba(0,229,160,.35);color:var(--acG)}
.ibtn.green:hover{background:rgba(0,229,160,.2)}
.libscroll{flex:1;overflow-y:auto;min-height:0}
.frow{padding:7px 11px;display:flex;align-items:center;gap:6px;cursor:pointer;border-bottom:1px solid var(--border);font-size:11px;transition:.12s;user-select:none}
.frow:hover{background:var(--card)}
.frow.open .fi{transform:rotate(90deg)}
.fi{transition:transform .2s;font-size:11px;display:inline-block;flex-shrink:0}
.fmeta{font-size:9px;color:var(--sub);margin-top:1px}
.trow{padding:5px 11px 5px 26px;display:flex;align-items:center;gap:6px;cursor:pointer;font-size:11px;transition:.12s;border-bottom:1px solid rgba(255,255,255,.02)}
.trow:hover{background:rgba(255,255,255,.03)}
.trow.act{color:var(--acc)}
.trow.act::before{content:'â–¶ ';font-size:8px}
.tname{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;min-width:0}
.libempty{padding:18px 12px;text-align:center;color:var(--sub);font-size:10px;line-height:2}
.lib-banner{padding:7px 12px;background:rgba(0,229,160,.06);border-bottom:1px solid rgba(0,229,160,.15);font-size:9px;color:var(--acG);display:flex;align-items:center;gap:6px}
.lib-banner .dot{width:6px;height:6px;border-radius:50%;background:var(--acG);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.main{overflow-y:auto;min-height:0;background:var(--bg)}
.mi{padding:14px}
/* PLATFORMS */
.platforms{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:14px}
.pcard{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px 8px;text-align:center;cursor:pointer;transition:.2s;position:relative;overflow:hidden}
.pcard:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,.4)}
.pcard.connected{border-color:var(--pcolor,var(--acc))}
.pcard.connected::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:var(--pcolor,var(--acc))}
.picon{font-size:24px;margin-bottom:4px}
.pname{font-size:10px;font-weight:700;letter-spacing:.5px;color:var(--sub)}
.pstatus{font-size:8px;margin-top:3px;font-weight:700;letter-spacing:1px}
.pstatus.conn{color:var(--pcolor,var(--acc))}
.pstatus.disc{color:var(--sub)}
/* STREAM PANEL */
.stream-panel{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:14px;display:none}
.stream-panel.open{display:block}
.stream-hdr{display:flex;align-items:center;gap:8px;margin-bottom:10px}
.stream-logo{width:24px;height:24px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.stream-title{font-size:13px;font-weight:700}
.stream-sub{font-size:10px;color:var(--sub);flex:1}
.sbar{display:flex;gap:7px;margin-bottom:10px}
.sinput{flex:1;background:var(--card2);border:1px solid var(--border);color:var(--text);padding:7px 12px;border-radius:8px;font-size:12px;outline:none;transition:.2s}
.sinput:focus{border-color:var(--acc)}
.sbtn2{padding:7px 14px;border-radius:8px;border:1px solid var(--acc);background:rgba(99,68,245,.15);color:var(--acc);font-size:11px;cursor:pointer;transition:.2s;white-space:nowrap;font-weight:600}
.sbtn2:hover{background:rgba(99,68,245,.3)}
.sresults{display:grid;gap:5px;max-height:280px;overflow-y:auto}
.strack{background:var(--card2);border:1px solid var(--border);border-radius:8px;padding:8px 10px;display:flex;align-items:center;gap:10px;cursor:pointer;transition:.15s}
.strack:hover{border-color:var(--acc);background:rgba(99,68,245,.05)}
.strack-art{width:40px;height:40px;border-radius:6px;background:var(--card);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:18px;overflow:hidden}
.strack-art img{width:100%;height:100%;object-fit:cover;border-radius:6px}
.strack-info{flex:1;min-width:0}
.strack-name{font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.strack-artist{font-size:10px;color:var(--sub);margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.strack-dur{font-size:10px;color:var(--sub);flex-shrink:0}
.strack-play{width:30px;height:30px;border-radius:50%;background:var(--acc);border:none;color:#fff;cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:.15s}
.strack-play:hover{transform:scale(1.1);background:var(--acO)}
#ytFrame{display:none;width:0;height:0;position:absolute}
/* NOW PLAYING */
.np{background:linear-gradient(135deg,#0e0e1e,#180f25);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:12px;position:relative;overflow:hidden}
.np::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at 20% 50%,rgba(99,68,245,.05),transparent 70%);pointer-events:none}
.np-title{font-size:16px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.np-sub{font-size:10px;color:var(--sub);margin-top:2px;margin-bottom:6px}
.np-fmt{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:10px}
.fb{font-size:9px;padding:2px 6px;border-radius:5px;font-weight:700;border:1px solid}
.fb-w{color:var(--acG);border-color:rgba(0,229,160,.3);background:rgba(0,229,160,.07)}
.fb-b{color:#a090ff;border-color:rgba(99,68,245,.3);background:rgba(99,68,245,.07)}
.fb-c{color:var(--acO);border-color:rgba(255,107,53,.3);background:rgba(255,107,53,.07)}
.fb-src{font-size:9px;padding:2px 6px;border-radius:5px;font-weight:700;border:1px solid;color:var(--text)}
canvas#viz{width:100%;height:52px;display:block;border-radius:7px;background:rgba(0,0,0,.4);margin-bottom:10px}
.seek-w{margin-bottom:8px}
.sbar-r{width:100%;-webkit-appearance:none;appearance:none;height:3px;border-radius:2px;background:var(--border);outline:none;cursor:pointer;accent-color:var(--acc)}
.trow2{display:flex;justify-content:space-between;font-size:10px;color:var(--sub);margin-top:3px}
.ctrl{display:flex;align-items:center;gap:8px;margin-bottom:10px}
.pbtn{width:46px;height:46px;border-radius:50%;background:linear-gradient(135deg,#6344f5,#ff6b35);border:none;color:#fff;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 3px 16px rgba(99,68,245,.4);transition:.18s;flex-shrink:0}
.pbtn:hover{transform:scale(1.07)}
.cbtn{background:var(--card2);border:1px solid var(--border);color:var(--text);width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center;transition:.2s;flex-shrink:0}
.cbtn:hover{border-color:var(--acc);color:var(--acc)}
.cbtn.on{background:var(--acc);border-color:var(--acc);color:#fff}
.vol{display:flex;align-items:center;gap:5px;flex:1}
.vol input[type=range]{flex:1;accent-color:var(--acc)}
.dropz{border:2px dashed var(--border);border-radius:9px;padding:14px;text-align:center;cursor:pointer;transition:.2s;font-size:10px;color:var(--sub);background:rgba(0,0,0,.15)}
.dropz:hover,.dropz.drag{border-color:var(--acc);background:rgba(99,68,245,.04)}
.sh{font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--sub);margin:4px 0 9px;display:flex;align-items:center;gap:7px}
.sh span{display:block;height:1px;flex:1;background:var(--border)}
.tgrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px}
.tc{background:var(--card);border:1px solid var(--border);border-radius:11px;padding:13px}
.tc-t{font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;margin-bottom:11px;display:flex;align-items:center;gap:5px}
.tc-on{color:var(--acc)} .tc-sur{color:var(--acO)} .tc-g{color:var(--acG)}
.sgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:4px;margin-bottom:9px}
.sbtn{background:var(--card2);border:1px solid var(--border);color:var(--sub);padding:6px 3px;border-radius:7px;cursor:pointer;font-size:10px;text-align:center;transition:.14s;line-height:1.3}
.sbtn:hover{border-color:var(--acc);color:var(--text)}
.sbtn.on{background:var(--acc);border-color:var(--acc);color:#fff;font-weight:600}
.sbtn.soff{grid-column:span 3;background:rgba(255,255,255,.02);color:var(--sub);font-style:italic}
.sbtn.soff.on{background:var(--sub);border-color:var(--sub)}
.lr{display:flex;align-items:center;gap:7px;margin-top:5px}
.ll{font-size:9px;color:var(--sub);width:55px;flex-shrink:0}
.sg{flex:1;-webkit-appearance:none;appearance:none;height:3px;border-radius:2px;outline:none;cursor:pointer;background:linear-gradient(90deg,var(--acc) var(--p,50%),var(--border) var(--p,50%))}
.sg::-webkit-slider-thumb{-webkit-appearance:none;width:12px;height:12px;border-radius:50%;background:var(--acc);cursor:pointer}
.vb{font-size:10px;color:var(--text);min-width:24px;text-align:right}
.tr{display:flex;align-items:center;gap:7px}
.tl{font-size:9px;color:var(--sub);width:38px;flex-shrink:0}
.bs{flex:1;-webkit-appearance:none;appearance:none;height:3px;border-radius:2px;background:var(--border);outline:none;cursor:pointer;accent-color:var(--acc)}
.tv{font-size:10px;min-width:28px;text-align:right}
.trows{display:flex;flex-direction:column;gap:8px}
.tog{position:relative;width:36px;height:20px;flex-shrink:0}
.tog input{opacity:0;width:0;height:0;position:absolute}
.togsl{position:absolute;inset:0;background:var(--border);border-radius:10px;cursor:pointer;transition:.25s}
.togsl:before{content:'';position:absolute;width:14px;height:14px;left:3px;top:3px;background:#fff;border-radius:50%;transition:.25s}
.tog input:checked+.togsl{background:var(--acc)}
.tog input:checked+.togsl:before{transform:translateX(16px)}
.tog-row{display:flex;align-items:center;gap:7px;margin-bottom:7px}
.blv{height:5px;background:var(--border);border-radius:3px;overflow:hidden;margin-top:2px;margin-bottom:7px}
.blf{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--acc),var(--acO));transition:width .15s}
/* 9.1.4 SURROUND */
.sur-w{background:var(--card);border:1px solid rgba(255,107,53,.18);border-radius:11px;padding:13px;margin-bottom:12px}
.sur-modes{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px}
.smb{background:var(--card2);border:1px solid var(--border);color:var(--sub);padding:6px 10px;border-radius:8px;cursor:pointer;font-size:10px;transition:.14s}
.smb:hover{border-color:var(--acO);color:var(--text)}
.smb.on{background:rgba(255,107,53,.12);border-color:var(--acO);color:var(--acO);font-weight:700}
.sur-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:4px;margin-top:8px}
.sur-ch{background:var(--card);border:1px solid var(--border);border-radius:6px;padding:5px 3px;text-align:center;transition:.14s}
.sur-ch.sub{border-color:rgba(99,68,245,.4);background:rgba(99,68,245,.05)}
.sur-ch.ht{border-color:rgba(0,229,160,.3);background:rgba(0,229,160,.05)}
.sur-ch.act{border-color:var(--acO)}
.chn{font-size:8px;font-weight:700;color:var(--sub)}
.chd{font-size:9px;font-weight:600;margin-top:1px}
.chl{height:2px;border-radius:1px;background:var(--border);overflow:hidden;margin-top:3px}
.chb{height:100%;border-radius:1px;transition:width .08s}
/* WAV */
.wav-w{background:var(--card);border:1px solid rgba(0,229,160,.18);border-radius:11px;padding:13px;margin-bottom:12px}
.wav-s{display:flex;align-items:center;gap:7px;margin-bottom:8px}
.wdot{width:7px;height:7px;border-radius:50%;background:var(--border);flex-shrink:0;transition:.3s}
.wdot.act{background:var(--acG);box-shadow:0 0 7px var(--acG)}
.wbtns{display:flex;gap:7px;flex-wrap:wrap;margin-top:8px}
.wbtn{padding:5px 12px;border-radius:7px;border:1px solid var(--border);background:var(--card2);color:var(--text);font-size:10px;cursor:pointer;transition:.2s}
.wbtn:hover{border-color:var(--acG);color:var(--acG)}
.wbtn.p{background:rgba(0,229,160,.1);border-color:var(--acG);color:var(--acG);font-weight:600}
.wpr{display:none;margin-top:8px}
.wprbar{background:var(--border);height:3px;border-radius:2px;overflow:hidden}
.wprf{height:100%;background:var(--acG);width:0%;transition:width .2s;border-radius:2px}
/* PEQ */
.peq-w{background:var(--card);border:1px solid var(--border);border-radius:11px;padding:13px;margin-bottom:14px}
canvas#peq{width:100%;height:120px;display:block;background:#06060e;border-radius:7px;margin-bottom:9px;cursor:crosshair}
.pbands{display:flex;gap:5px;overflow-x:auto;padding-bottom:3px;margin-bottom:9px}
.pb{background:var(--card2);border:1px solid var(--border);border-radius:7px;padding:6px 4px;min-width:62px;text-align:center;cursor:pointer;transition:.14s;flex-shrink:0}
.pb:hover{border-color:var(--acc)} .pb.sel{border-color:var(--acc);background:rgba(99,68,245,.1)}
.pbf{font-size:9px;color:var(--sub)} .pbg{font-size:11px;font-weight:700;margin-top:1px} .pbt{font-size:8px;color:var(--sub);margin-top:1px}
.pctrl{display:flex;gap:8px;flex-wrap:wrap;align-items:flex-end}
.pf{display:flex;flex-direction:column;gap:2px}
.pf label{font-size:9px;color:var(--sub);letter-spacing:1px}
.pf input,.pf select{background:var(--bg);border:1px solid var(--border);color:var(--text);padding:4px 7px;border-radius:6px;font-size:11px;outline:none;width:84px}
.pf select{width:106px}
.pbtn2{padding:5px 10px;border-radius:6px;border:1px solid var(--border);background:var(--card2);color:var(--text);font-size:9px;cursor:pointer;transition:.2s;white-space:nowrap}
.pbtn2:hover{border-color:var(--acc);color:var(--acc)}
.pbtn2.del{color:var(--red);border-color:rgba(255,51,102,.3)}
/* MODAL */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:100;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(6px)}
.modal{background:#12121f;border:1px solid var(--border);border-radius:16px;padding:28px;width:440px;max-width:94vw;box-shadow:0 20px 60px rgba(0,0,0,.6)}
.modal h2{font-size:16px;font-weight:800;margin-bottom:6px}
.modal p{font-size:11px;color:var(--sub);line-height:1.7;margin-bottom:14px}
.modal label{font-size:10px;color:var(--sub);display:block;margin-bottom:3px;letter-spacing:1px;text-transform:uppercase}
.modal input{width:100%;background:var(--card);border:1px solid var(--border);color:var(--text);padding:8px 11px;border-radius:8px;font-size:12px;outline:none;margin-bottom:10px;transition:.2s}
.modal input:focus{border-color:var(--acc)}
.modal-btns{display:flex;gap:8px;justify-content:flex-end;margin-top:4px}
.modal-btns button{padding:8px 18px;border-radius:8px;border:1px solid var(--border);cursor:pointer;font-size:11px;font-weight:600;transition:.2s}
.mbtn-cancel{background:transparent;color:var(--sub)}
.mbtn-connect{background:var(--acc);border-color:var(--acc);color:#fff}
.mbtn-connect:hover{opacity:.85}
.pstep{font-size:10px;color:var(--sub);padding:9px;background:var(--card2);border-radius:7px;line-height:1.8;margin-bottom:10px}
.pstep a{color:var(--acc);text-decoration:none}
.pstep a:hover{text-decoration:underline}
.oauth-btn{width:100%;padding:10px;border-radius:9px;border:none;font-size:12px;font-weight:700;cursor:pointer;transition:.2s;margin-bottom:8px;display:flex;align-items:center;justify-content:center;gap:8px}
.oauth-btn:hover{opacity:.88;transform:translateY(-1px)}
.oauth-waiting{text-align:center;padding:16px;color:var(--sub);font-size:11px}
.oauth-waiting .spin{display:inline-block;animation:spin 1s linear infinite;font-size:20px;margin-bottom:8px;display:block}
@keyframes spin{to{transform:rotate(360deg)}}
input[type=file]{display:none}
::-webkit-scrollbar{width:4px;height:4px}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
@media(max-width:680px){.app{grid-template-columns:1fr}.sidebar{display:none}.tgrid{grid-template-columns:1fr}.platforms{grid-template-columns:repeat(3,1fr)}}
</style>
</head>
<body>
<div class="app">
<div class="topbar">
  <div class="logo">DOLBY UNIFIED PLAYER<sub>SURROUND 9.1.4 Â· 192kHz Â· 24-bit</sub></div>
  <div style="flex:1"></div>
  <span style="font-size:9px;color:var(--sub);flex-shrink:0">â˜€</span>
  <input type="range" id="brightSl" min="0" max="20" value="10" step="1"
    style="width:72px;accent-color:var(--acc);cursor:pointer;flex-shrink:0"
    oninput="onBrightness(this)" title="Brightness">
  <span id="brightV" style="font-size:9px;color:var(--sub);min-width:16px;flex-shrink:0">10</span>
  <span style="font-size:9px;color:var(--sub);flex-shrink:0;margin-left:4px">â—ˆ</span>
  <input type="range" id="claritySl" min="0" max="20" value="10" step="1"
    style="width:72px;accent-color:var(--acO);cursor:pointer;flex-shrink:0"
    oninput="onClarity(this)" title="Clarity">
  <span id="clarityV" style="font-size:9px;color:var(--sub);min-width:16px;flex-shrink:0">10</span>
  <span id="bNR" class="tbadge off">NR OFF</span>
  <span id="bSur" class="tbadge off">SURROUND OFF</span>
  <span id="bSrc" class="tbadge off">LOCAL</span>
</div>

<div class="sidebar">
  <div class="shdr">
    Library
    <div class="shdr-btns">
      <button class="ibtn green" onclick="autoScanLib()" title="Auto-scan folder">âŸ³ Auto</button>
      <button class="ibtn" onclick="scanFolder()">ï¼‹ Folder</button>
    </div>
  </div>
  <div class="lib-banner" id="libBanner" style="display:none">
    <div class="dot"></div><span id="libBannerTxt">Monitoringâ€¦</span>
  </div>
  <div class="libscroll" id="libScroll">
    <div class="libempty" id="libEmpty">ğŸ“ No library yet<br>Click <strong>âŸ³ Auto</strong> to scan<br>or drop files below</div>
  </div>
  <input type="file" id="folderIn" webkitdirectory multiple accept="audio/*" onchange="onFolderScan(event)">
  <input type="file" id="fileIn" multiple accept="audio/*" onchange="onFileIn(event)">
</div>

<div class="main"><div class="mi">

<div class="sh">ğŸ§ Streaming Platforms<span></span></div>
<div class="platforms">
  <div class="pcard" id="pc-spotify" style="--pcolor:var(--sp)" onclick="openPlatform('spotify')">
    <div class="picon">ğŸµ</div><div class="pname" style="color:var(--sp)">Spotify</div>
    <div class="pstatus disc" id="ps-spotify">CONNECT</div>
  </div>
  <div class="pcard" id="pc-deezer" style="--pcolor:var(--dz)" onclick="openPlatform('deezer')">
    <div class="picon">ğŸ¶</div><div class="pname" style="color:var(--dz)">Deezer</div>
    <div class="pstatus disc" id="ps-deezer">CONNECT</div>
  </div>
  <div class="pcard" id="pc-tidal" style="--pcolor:var(--td)" onclick="openPlatform('tidal')">
    <div class="picon">ğŸŒŠ</div><div class="pname" style="color:var(--td)">Tidal</div>
    <div class="pstatus disc" id="ps-tidal">CONNECT</div>
  </div>
  <div class="pcard" id="pc-apple" style="--pcolor:var(--am)" onclick="openPlatform('apple')">
    <div class="picon">ğŸ</div><div class="pname" style="color:var(--am)">Apple Music</div>
    <div class="pstatus disc" id="ps-apple">CONNECT</div>
  </div>
  <div class="pcard" id="pc-youtube" style="--pcolor:var(--yt)" onclick="openPlatform('youtube')">
    <div class="picon">â–¶ï¸</div><div class="pname" style="color:var(--yt)">YouTube</div>
    <div class="pstatus disc" id="ps-youtube">CONNECT</div>
  </div>
</div>

<div class="stream-panel" id="streamPanel">
  <div class="stream-hdr">
    <div class="stream-logo" id="streamLogo"></div>
    <div><div class="stream-title" id="streamTitle">Platform</div><div class="stream-sub" id="streamSub">Search for music</div></div>
    <button class="ibtn" onclick="disconnectPlatform()" style="margin-left:auto">Disconnect</button>
  </div>
  <div class="sbar">
    <input class="sinput" id="searchInput" type="text" placeholder="Search tracks, artists, albumsâ€¦" onkeydown="if(event.key==='Enter')doSearch()">
    <button class="sbtn2" onclick="doSearch()">Search</button>
  </div>
  <div class="sresults" id="sresults"></div>
</div>
<div id="ytFrame"></div>

<!-- NOW PLAYING -->
<div class="np">
  <div class="np-title" id="npTitle">No Track Loaded</div>
  <div class="np-sub" id="npSub">Load files, scan library, or connect a streaming platform</div>
  <div class="np-fmt">
    <span class="fb fb-w">WAV 24-bit / 192kHz</span>
    <span class="fb fb-b">9,216 kbps</span>
    <span class="fb fb-c">9.1.4 Surround â†’ Stereo</span>
    <span class="fb fb-src" id="srcBadge" style="border-color:var(--border);background:rgba(255,255,255,.04)">LOCAL</span>
  </div>
  <canvas id="viz"></canvas>
  <div class="seek-w">
    <input type="range" class="sbar-r" id="seekBar" min="0" max="100" value="0" step="0.05" oninput="seek(this.value)">
    <div class="trow2"><span id="tCur">0:00</span><span id="tDur">0:00</span></div>
  </div>
  <div class="ctrl">
    <button class="cbtn" onclick="prevTrk()">â®</button>
    <button class="pbtn" id="playBtn" onclick="togglePlay()">â–¶</button>
    <button class="cbtn" onclick="nextTrk()">â­</button>
    <button class="cbtn" id="repBtn" onclick="toggleRepeat()">ğŸ”</button>
    <button class="cbtn" id="shufBtn" onclick="toggleShuffle()">ğŸ”€</button>
    <div class="vol">
      <span style="font-size:12px">ğŸ”‰</span>
      <input type="range" min="0" max="1" step="0.01" value="0.8" id="volSl" oninput="setVol(this.value)">
      <span style="font-size:12px">ğŸ”Š</span>
    </div>
  </div>
  <div class="dropz" id="dropZ" onclick="document.getElementById('fileIn').click()"
    ondragover="doDragOver(event)" ondragleave="doDragLeave()" ondrop="doDrop(event)">
    ğŸµ Click or drag &amp; drop audio files Â· <strong style="color:var(--acG)">All formats auto-detected</strong>
  </div>
</div>

<!-- DOLBY ON TOOLS -->
<div class="sh">âš¡ Dolby On â€” Sound Tools<span></span></div>
<div class="tgrid">
  <div class="tc">
    <div class="tc-t tc-on">ğŸ¨ Style</div>
    <div class="sgrid">
      <button class="sbtn on" onclick="setStyle('standard',this)">Standard</button>
      <button class="sbtn" onclick="setStyle('amped',this)">Amped</button>
      <button class="sbtn" onclick="setStyle('lyric',this)">Lyric</button>
      <button class="sbtn" onclick="setStyle('deep',this)">Deep</button>
      <button class="sbtn" onclick="setStyle('natural',this)">Natural</button>
      <button class="sbtn" onclick="setStyle('thump',this)">Thump</button>
      <button class="sbtn soff" onclick="setStyle('off',this)">Off â€” No EQ</button>
    </div>
    <div class="lr"><span class="ll">Intensity</span>
      <input type="range" class="sg" id="styleInt" min="0" max="20" value="10" step="1" oninput="onStyleInt(this)">
      <span class="vb" id="styleIntV">10</span>
    </div>
  </div>
  <div class="tc">
    <div class="tc-t tc-on">ğŸ›ï¸ Noise Reduction</div>
    <div class="tog-row">
      <label class="tog"><input type="checkbox" id="nrCb" onchange="onNR(this)"><div class="togsl"></div></label>
      <span id="nrLbl" style="font-size:12px;font-weight:600;color:var(--sub)">Off</span>
    </div>
    <div class="lr" style="margin-bottom:8px"><span class="ll">Amount</span>
      <input type="range" class="sg" id="nrAmt" min="0" max="20" value="10" step="1" oninput="onNRamt(this)" disabled>
      <span class="vb" id="nrAmtV">10</span>
    </div>
    <div style="font-size:9px;color:var(--sub);line-height:1.7">Removes amp hum, AC noise, static floor.</div>
  </div>
  <div class="tc">
    <div class="tc-t tc-on">ğŸšï¸ Tone</div>
    <div class="trows">
      <div class="tr"><span class="tl">Treble</span><input type="range" class="bs" id="toneTreble" min="-20" max="20" value="0" step="1" oninput="onTone('treble',this)"><span class="tv" id="vTreble">0</span></div>
      <div class="tr"><span class="tl">Mids</span><input type="range" class="bs" id="toneMids" min="-20" max="20" value="0" step="1" oninput="onTone('mids',this)"><span class="tv" id="vMids">0</span></div>
      <div class="tr"><span class="tl">Bass</span><input type="range" class="bs" id="toneBass" min="-20" max="20" value="0" step="1" oninput="onTone('bass',this)"><span class="tv" id="vBass">0</span></div>
    </div>
    <div style="font-size:9px;color:var(--sub);margin-top:7px">âˆ’20 to +20 Â· Center: 0</div>
  </div>
  <div class="tc">
    <div class="tc-t tc-on">âš¡ Boost</div>
    <div class="lr"><span class="ll">Level</span>
      <input type="range" class="sg" id="boostSl" min="0" max="20" value="10" step="1" oninput="onBoost(this)">
      <span class="vb" id="boostV">10</span>
    </div>
    <div class="blv"><div class="blf" id="boostFill" style="width:50%"></div></div>
    <div style="font-size:9px;color:var(--sub);line-height:1.7">0 = full dynamics Â· 20 = max loudness.</div>
  </div>
</div>

<!-- 9.1.4 SURROUND SOUND -->
<div class="sh">ğŸ”Š 9.1.4 Surround Sound â†’ Binaural Stereo<span></span></div>
<div class="sur-w">
  <div class="tc-t tc-sur">14-Channel HRTF Downmix Â· ITU-R BS.2051 Type H Layout Â· Real-time Binaural Render</div>
  <div class="sur-modes">
    <button class="smb" onclick="setSurround('off',this)">âœ• Bypass</button>
    <button class="smb on" onclick="setSurround('music',this)">ğŸµ Music</button>
    <button class="smb" onclick="setSurround('cinema',this)">ğŸ¬ Cinema</button>
    <button class="smb" onclick="setSurround('game',this)">ğŸ® Game</button>
    <button class="smb" onclick="setSurround('concert',this)">ğŸ· Concert</button>
    <button class="smb" onclick="setSurround('wide',this)">ğŸŒŠ Wide</button>
  </div>
  <div id="surDesc" style="font-size:10px;color:var(--sub);line-height:1.7;margin-bottom:10px">
    Music: 9.1.4 layout Â· HRTF panning per channel Â· room reflection impulse Â· binaural downmix to stereo.
  </div>
  <div style="font-size:9px;color:var(--sub);margin-bottom:8px;letter-spacing:1px;font-weight:700">LIVE CHANNEL LEVELS Â· 9.1.4 = 9 BED + 1 LFE + 4 HEIGHT</div>
  <div class="sur-grid" id="surGrid"></div>
  <div style="margin-top:10px;display:flex;gap:14px;flex-wrap:wrap">
    <div class="lr" style="flex:1;min-width:160px"><span class="ll">Room Size</span>
      <input type="range" class="sg" id="surRoom" min="0" max="20" value="8" step="1" oninput="onSurRoom(this)">
      <span class="vb" id="surRoomV">8</span>
    </div>
    <div class="lr" style="flex:1;min-width:160px"><span class="ll">Width</span>
      <input type="range" class="sg" id="surWidth" min="0" max="20" value="12" step="1" oninput="onSurWidth(this)">
      <span class="vb" id="surWidthV">12</span>
    </div>
  </div>
</div>

<!-- WAV EXPORT -->
<div class="sh">ğŸ’¾ Converter â€” 192kHz / 24-bit PCM<span></span></div>
<div class="wav-w">
  <div class="wav-s"><div class="wdot" id="wavDot"></div><span id="wavTxt" style="font-size:11px;font-weight:700;color:var(--sub)">Converter Ready</span></div>
  <div style="font-size:10px;color:var(--sub);line-height:1.8">
    Target: <strong style="color:var(--acG)">WAV 24-bit PCM / 192kHz</strong> Â·
    <strong style="color:#a090ff">9,216 kbps</strong> Â·
    Full DSP + 9.1.4 surround render applied on export.
  </div>
  <div class="wbtns">
    <button class="wbtn p" onclick="exportWAV()">â¬‡ Export WAV (24-bit / 192kHz)</button>
    <button class="wbtn" onclick="exportInfo()">â„¹ Info</button>
  </div>
  <div class="wpr" id="wpr">
    <div class="wprbar"><div class="wprf" id="wprf"></div></div>
    <div id="wprtxt" style="font-size:10px;color:var(--sub);margin-top:3px"></div>
  </div>
</div>

<!-- PARAMETRIC EQ -->
<div class="sh">ğŸ”¬ Parametric EQ â€” 20Hz to 96kHz<span></span></div>
<div class="peq-w">
  <canvas id="peq" onclick="peqClick(event)"></canvas>
  <div class="pbands" id="pbands"></div>
  <div class="pctrl">
    <div class="pf"><label>Type</label>
      <select id="peqType" onchange="updatePeqBand()">
        <option value="peaking">Peaking</option><option value="lowshelf">Low Shelf</option>
        <option value="highshelf">High Shelf</option><option value="lowpass">Low Pass</option>
        <option value="highpass">High Pass</option><option value="notch">Notch</option>
        <option value="bandpass">Band Pass</option><option value="allpass">All Pass</option>
      </select>
    </div>
    <div class="pf"><label>Freq (Hz)</label><input type="number" id="peqFreq" min="20" max="96000" value="1000" onchange="updatePeqBand()"></div>
    <div class="pf"><label>Gain (dB)</label><input type="number" id="peqGain" min="-24" max="24" value="0" step="0.5" onchange="updatePeqBand()"></div>
    <div class="pf"><label>Q</label><input type="number" id="peqQ" min="0.05" max="30" value="1.4" step="0.05" onchange="updatePeqBand()"></div>
    <button class="pbtn2" onclick="addPeqBand()">ï¼‹ Band</button>
    <button class="pbtn2 del" onclick="removePeqBand()">âˆ’ Band</button>
    <button class="pbtn2" onclick="resetPeq()">Reset</button>
  </div>
</div>

</div></div>
</div>

<!-- OAUTH MODAL -->
<div class="modal-bg" id="modalBg" style="display:none" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <h2 id="modalTitle">Connect Platform</h2>
    <p id="modalDesc" style="margin-bottom:10px"></p>
    <div id="modalBody"></div>
    <div class="modal-btns">
      <button class="mbtn-cancel" onclick="closeModal()">Cancel</button>
      <button class="mbtn-connect" id="modalBtn" onclick="doConnect()" style="display:none">Connect</button>
    </div>
  </div>
</div>

<audio id="mainAudio"></audio>

<script>
'use strict';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONSTANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TARGET_SR=192000, TARGET_BIT=24, TARGET_CH=2;
const AUDIO_EXTS=/\.(mp3|flac|wav|aiff?|ogg|opus|m4a|aac|wma|alac|ape|dsf|wv|mka)$/i;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLATFORM OAUTH CONFIGS
// Full PKCE OAuth 2.0 flows for all platforms
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PLATFORMS={
  spotify:{
    name:'Spotify', icon:'ğŸµ', color:'#1db954',
    // Full PKCE OAuth â€” no client secret needed
    authUrl:'https://accounts.spotify.com/authorize',
    tokenUrl:'https://accounts.spotify.com/api/token',
    scope:'streaming user-read-email user-read-private user-library-read user-read-playback-state user-modify-playback-state',
    redirectParam:'spotify_auth',
    sdkSrc:'https://sdk.scdn.co/spotify-player.js',
    // Modal: just needs Client ID (PKCE = no secret)
    fields:[{id:'clientId',label:'Spotify Client ID',hint:'From developer.spotify.com â†’ Your App â†’ Settings',placeholder:'Paste Client ID here'}],
    setupHtml:`<div class="pstep">
      <strong style="color:#1db954">Spotify â€” PKCE OAuth 2.0</strong><br>
      Requires <strong>Spotify Premium</strong> for full playback via Web Playback SDK.<br><br>
      1. Go to <a href="https://developer.spotify.com/dashboard" target="_blank">developer.spotify.com/dashboard</a><br>
      2. Create App â†’ set Redirect URI to: <strong id="spRedirect"></strong><br>
      3. Copy your <strong>Client ID</strong> and paste below.<br>
      No client secret needed â€” we use PKCE.
    </div>`
  },
  deezer:{
    name:'Deezer', icon:'ğŸ¶', color:'#ef5466',
    // Deezer uses implicit OAuth via their SDK
    fields:[{id:'appId',label:'Deezer App ID',hint:'From developers.deezer.com â†’ My Apps',placeholder:'Your Deezer App ID'}],
    setupHtml:`<div class="pstep">
      <strong style="color:#ef5466">Deezer â€” OAuth 2.0 Implicit</strong><br>
      Free accounts: 30-sec previews. Premium: full tracks.<br><br>
      1. Go to <a href="https://developers.deezer.com/myapps" target="_blank">developers.deezer.com/myapps</a><br>
      2. Create App â†’ set Redirect URI to: <strong id="dzRedirect"></strong><br>
      3. Copy your <strong>App ID</strong> below.
    </div>`
  },
  tidal:{
    name:'Tidal', icon:'ğŸŒŠ', color:'#00ffff',
    authUrl:'https://login.tidal.com/authorize',
    tokenUrl:'https://auth.tidal.com/v1/oauth2/token',
    scope:'user.read collection.read playlists.read',
    redirectParam:'tidal_auth',
    fields:[{id:'clientId',label:'Tidal Client ID',hint:'From developer.tidal.com â†’ Applications',placeholder:'Your Tidal Client ID'}],
    setupHtml:`<div class="pstep">
      <strong style="color:#00ffff">Tidal â€” OAuth 2.1 + PKCE</strong><br><br>
      1. Go to <a href="https://developer.tidal.com" target="_blank">developer.tidal.com</a> â†’ Applications<br>
      2. Create App â†’ set Redirect URI to: <strong id="tdRedirect"></strong><br>
      3. Copy your <strong>Client ID</strong> below.<br>
      You'll be redirected to Tidal login.
    </div>`
  },
  apple:{
    name:'Apple Music', icon:'ğŸ', color:'#fc3c44',
    // MusicKit JS â€” developer JWT + user auth
    fields:[{id:'devToken',label:'MusicKit Developer Token (JWT)',hint:'From developer.apple.com â†’ Certificates â†’ Keys',placeholder:'eyJhbGciOiJFUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6Ii4uLiJ9...'}],
    setupHtml:`<div class="pstep">
      <strong style="color:#fc3c44">Apple Music â€” MusicKit JS</strong><br>
      Requires Apple Developer Program ($99/yr).<br><br>
      1. <a href="https://developer.apple.com/account/resources/authkeys/list" target="_blank">developer.apple.com</a> â†’ Keys â†’ Create (MusicKit)<br>
      2. Generate a signed JWT Developer Token (ES256, kid=keyId, iss=teamId, exp=6months)<br>
      3. Paste the full JWT below. User will be asked to sign in via Apple.
    </div>`
  },
  youtube:{
    name:'YouTube', icon:'â–¶ï¸', color:'#ff0000',
    // Google OAuth 2.0 PKCE â€” YouTube Data API v3 + YouTube IFrame
    authUrl:'https://accounts.google.com/o/oauth2/v2/auth',
    tokenUrl:'https://oauth2.googleapis.com/token',
    scope:'https://www.googleapis.com/auth/youtube.readonly',
    redirectParam:'youtube_auth',
    fields:[
      {id:'clientId',label:'Google OAuth 2.0 Client ID',hint:'From console.cloud.google.com â†’ APIs â†’ Credentials â†’ OAuth 2.0',placeholder:'xxxxxxxx.apps.googleusercontent.com'},
    ],
    setupHtml:`<div class="pstep">
      <strong style="color:#ff0000">YouTube â€” Google OAuth 2.0 + PKCE</strong><br>
      Uses your own Google account â€” no API key quota sharing.<br><br>
      1. <a href="https://console.cloud.google.com/apis/library/youtube.googleapis.com" target="_blank">Enable YouTube Data API v3</a><br>
      2. <a href="https://console.cloud.google.com/apis/credentials" target="_blank">Create credentials</a> â†’ OAuth 2.0 Client ID â†’ Web App<br>
      3. Add Redirect URI: <strong id="ytRedirect"></strong><br>
      4. Paste your <strong>Client ID</strong> below. Full search + IFrame playback.
    </div>`
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STATE={
  connected:{},       // platform â†’ {token, refreshToken, clientId, ...}
  activePlatform:null,
  spotifyPlayer:null,
  ytPlayer:null, ytReady:false,
  mkInstance:null,
};
let pendingPlatform=null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUDIO ENGINE â€” 192kHz / 4096-sample buffer
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const AUD=document.getElementById('mainAudio');
let ACX=null,srcNode=null,inited=false;
let compNode=null,analyserN=null,masterGain=null;
let nrNode=null,toneN={},styleN=[],peqNodes=[];
// 9.1.4 surround nodes
let surPanners=[],surGains=[],surMixer=null,surConv=null,surDry=null,surWet=null;
let surMode='music',surRoom_=8,surWidth_=12;

let tracks=[],folders=[],curIdx=-1,doRepeat=false,doShuffle=false;
let styleKey='standard',styleInt_=10;
let nrOn=false,nrAmt_=10,boostLv=10;
let toneV={treble:0,mids:0,bass:0};
let selPeq=0;
let autoLibHandle=null,autoLibWatcher=null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 9.1.4 CHANNEL LAYOUT â€” ITU-R BS.2051 Type H
// 9 bed channels + 1 LFE + 4 height channels = 14 total
// Azimuth (Â°): 0=front, +R, -L  |  Elevation (Â°): 0=ear, +up
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CH914=[
  // Bed channels (9)
  {n:'L',   az:-30,  el:0,   t:'bed',  gain:1.0},
  {n:'C',   az:0,    el:0,   t:'bed',  gain:0.9},
  {n:'R',   az:30,   el:0,   t:'bed',  gain:1.0},
  {n:'Ls',  az:-110, el:0,   t:'bed',  gain:0.95},
  {n:'Rs',  az:110,  el:0,   t:'bed',  gain:0.95},
  {n:'Lss', az:-70,  el:0,   t:'bed',  gain:0.85},
  {n:'Rss', az:70,   el:0,   t:'bed',  gain:0.85},
  {n:'Lrs', az:-145, el:0,   t:'bed',  gain:0.8},
  {n:'Rrs', az:145,  el:0,   t:'bed',  gain:0.8},
  // LFE (1)
  {n:'LFE', az:0,    el:-30, t:'sub',  gain:1.0},
  // Height channels (4)
  {n:'LTF', az:-45,  el:45,  t:'ht',   gain:0.75},
  {n:'RTF', az:45,   el:45,  t:'ht',   gain:0.75},
  {n:'LTR', az:-135, el:45,  t:'ht',   gain:0.7},
  {n:'RTR', az:135,  el:45,  t:'ht',   gain:0.7},
];

// Surround mode presets: [wetMix, dryMix, roomDecay, heightGain, widthScale]
const SUR_MODES={
  off:   [0,    1,    0,    0,    1   ],
  music: [0.12, 0.95, 1.2,  0.7,  1.0 ],
  cinema:[0.35, 0.88, 2.8,  0.85, 1.3 ],
  game:  [0.08, 1.0,  0.5,  0.65, 0.9 ],
  concert:[0.45,0.82, 3.5,  0.9,  1.4 ],
  wide:  [0.18, 0.92, 1.8,  0.8,  1.6 ],
};
const SUR_DESC={
  off:    'Bypass: direct stereo, no spatial processing.',
  music:  'Music: 9.1.4 HRTF panning Â· natural room Â· moderate height Â· reference width.',
  cinema: 'Cinema: wide soundstage Â· deep reverb Â· elevated LFE Â· immersive height layer.',
  game:   'Game: tight 3D localisation Â· fast transients Â· minimal reverb Â· precise imaging.',
  concert:'Concert Hall: large room IR Â· strong early reflections Â· diffuse high-frequency tail.',
  wide:   'Wide: maximum stereo spread Â· all channels at full width Â· airy height layer.',
};

const STYLE_EQ={
  standard:[{f:80,g:2,q:.7,t:'lowshelf'},{f:200,g:.5,q:1.8,t:'peaking'},{f:2500,g:1.5,q:1.2,t:'peaking'},{f:12e3,g:2,q:.8,t:'highshelf'}],
  amped:   [{f:55,g:6,q:.7,t:'lowshelf'},{f:110,g:4,q:1.5,t:'peaking'},{f:450,g:-2,q:1.5,t:'peaking'},{f:3500,g:3,q:1.2,t:'peaking'},{f:10e3,g:5,q:.8,t:'highshelf'}],
  lyric:   [{f:80,g:-1.5,q:.9,t:'lowshelf'},{f:700,g:1,q:2,t:'peaking'},{f:2400,g:4.5,q:1.2,t:'peaking'},{f:5e3,g:3,q:1.5,t:'peaking'},{f:14e3,g:1.5,q:.8,t:'highshelf'}],
  deep:    [{f:38,g:8,q:.6,t:'lowshelf'},{f:75,g:6,q:1.2,t:'peaking'},{f:150,g:3,q:1.5,t:'peaking'},{f:380,g:-1,q:1.5,t:'peaking'},{f:8e3,g:-1,q:.8,t:'highshelf'}],
  natural: [{f:65,g:1,q:.8,t:'lowshelf'},{f:320,g:-.5,q:1.8,t:'peaking'},{f:1400,g:.5,q:2.5,t:'peaking'},{f:5500,g:.5,q:2,t:'peaking'},{f:13e3,g:1,q:.8,t:'highshelf'}],
  thump:   [{f:38,g:7,q:.6,t:'lowshelf'},{f:60,g:5,q:1.3,t:'peaking'},{f:120,g:3,q:1.5,t:'peaking'},{f:500,g:-1,q:1.5,t:'peaking'},{f:2500,g:2,q:1.5,t:'peaking'},{f:10e3,g:1,q:.8,t:'highshelf'}],
  off:[]
};

let peqBands=[
  {f:20,g:0,q:.7,t:'lowshelf'},{f:60,g:0,q:1.4,t:'peaking'},
  {f:200,g:0,q:1.4,t:'peaking'},{f:600,g:0,q:1.4,t:'peaking'},
  {f:2000,g:0,q:1.4,t:'peaking'},{f:6000,g:0,q:1.4,t:'peaking'},
  {f:20000,g:0,q:1.4,t:'peaking'},{f:80000,g:0,q:.7,t:'highshelf'},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUDIO INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initAudio(){
  if(inited)return; inited=true;
  ACX=new(window.AudioContext||window.webkitAudioContext)({sampleRate:TARGET_SR,latencyHint:'playback'});
  // 4096-sample buffer lock
  if(ACX.createScriptProcessor){
    const sp=ACX.createScriptProcessor(4096,2,2);
    sp.onaudioprocess=e=>{
      e.outputBuffer.getChannelData(0).set(e.inputBuffer.getChannelData(0));
      e.outputBuffer.getChannelData(1).set(e.inputBuffer.getChannelData(1));
    };
    ACX._sp4096=sp;
    sp.connect(ACX.destination);
  }
  srcNode=ACX.createMediaElementSource(AUD);
  compNode=ACX.createDynamicsCompressor(); applyBoost(boostLv);
  analyserN=ACX.createAnalyser(); analyserN.fftSize=2048;
  masterGain=ACX.createGain(); masterGain.gain.value=0.8;
  nrNode=ACX.createBiquadFilter(); nrNode.type='highpass'; nrNode.frequency.value=20; nrNode.Q.value=.5;
  const bF=ACX.createBiquadFilter(); bF.type='lowshelf'; bF.frequency.value=200; bF.gain.value=0;
  const mF=ACX.createBiquadFilter(); mF.type='peaking'; mF.frequency.value=1000; mF.Q.value=.8; mF.gain.value=0;
  const tF=ACX.createBiquadFilter(); tF.type='highshelf'; tF.frequency.value=5000; tF.gain.value=0;
  toneN={bass:bF,mids:mF,treble:tF};
  surMixer=ACX.createGain(); surMixer.gain.value=1;
  surDry=ACX.createGain();
  surWet=ACX.createGain();
  surConv=ACX.createConvolver();
  rebuildPeqN();
  build914Panners();
  buildSurImpulse(surMode);
  connectChain();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 9.1.4 PANNER ARRAY
// Each channel â†’ PannerNode with HRTF + per-channel gain
// All panners sum into analyserN via stereo mixdown
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function azElToXYZ(az,el,dist){
  const a=az*Math.PI/180, e=el*Math.PI/180;
  return{
    x:dist*Math.cos(e)*Math.sin(a),
    y:dist*Math.sin(e),
    z:-dist*Math.cos(e)*Math.cos(a)
  };
}

function build914Panners(){
  surPanners.forEach(p=>{try{p.disconnect();}catch(e){}});
  surGains.forEach(g=>{try{g.disconnect();}catch(e){}});
  surPanners=[]; surGains=[];
  CH914.forEach(ch=>{
    const p=ACX.createPanner();
    p.panningModel='HRTF';
    p.distanceModel='inverse';
    p.rolloffFactor=1;
    p.coneInnerAngle=360; p.coneOuterAngle=360; p.coneOuterGain=0;
    const {x,y,z}=azElToXYZ(ch.az,ch.el,1);
    p.positionX.value=x; p.positionY.value=y; p.positionZ.value=z;
    const g=ACX.createGain();
    // Apply width scaling: compress/expand azimuth effect via gain panning
    g.gain.value=ch.gain;
    surPanners.push(p);
    surGains.push(g);
  });
}

// Apply width scaling by adjusting panner positions
function applySurWidth(scale){
  if(!ACX)return;
  CH914.forEach((ch,i)=>{
    const dist=ch.t==='sub'?0.5:1;
    const effAz=ch.az*Math.max(0.1,Math.min(2,scale));
    const {x,y,z}=azElToXYZ(effAz,ch.el,dist);
    if(surPanners[i]){
      surPanners[i].positionX.setTargetAtTime(x,ACX.currentTime,.02);
      surPanners[i].positionY.setTargetAtTime(y,ACX.currentTime,.02);
      surPanners[i].positionZ.setTargetAtTime(z,ACX.currentTime,.02);
    }
  });
}

function buildSurImpulse(mode){
  if(!ACX||!surConv)return;
  const sr=ACX.sampleRate;
  const durMap={off:.1,music:1.4,cinema:3.2,game:.6,concert:4.2,wide:2.0};
  const decMap={off:6,  music:2.5,cinema:1.8,game:4,  concert:1.4,wide:2.2};
  const dur=durMap[mode]||1.4, dec=decMap[mode]||2.5;
  const len=Math.floor(sr*dur);
  const buf=ACX.createBuffer(2,len,sr);
  // Pre-delay 2ms for early reflection realism
  const preDelay=Math.floor(sr*.002);
  for(let c=0;c<2;c++){
    const d=buf.getChannelData(c);
    for(let i=0;i<preDelay;i++) d[i]=0;
    for(let i=preDelay;i<len;i++){
      d[i]=(Math.random()*2-1)*Math.pow(1-(i-preDelay)/(len-preDelay),dec);
    }
  }
  surConv.buffer=buf;
}

function connectChain(){
  if(!ACX||!srcNode)return;
  // Disconnect everything cleanly
  const all=[srcNode,...styleN,nrNode,toneN.bass,toneN.mids,toneN.treble,...peqNodes,
             compNode,surDry,surWet,surConv,surMixer,...surPanners,...surGains,analyserN,masterGain];
  all.forEach(n=>{if(n)try{n.disconnect();}catch(e){}});

  // Build pre-spatial chain: src â†’ NR â†’ style EQ â†’ tone â†’ PEQ â†’ compressor
  let n=srcNode;
  n.connect(nrNode); n=nrNode;
  styleN.forEach(f=>{n.connect(f);n=f;});
  n.connect(toneN.bass); n=toneN.bass;
  n.connect(toneN.mids); n=toneN.mids;
  n.connect(toneN.treble); n=toneN.treble;
  peqNodes.forEach(f=>{n.connect(f);n=f;});
  n.connect(compNode); n=compNode;

  if(surMode!=='off'){
    // Spatial path: compressor â†’ each of 14 HRTF panners (parallel fan-out)
    // + convolution reverb for room
    // Dry path: direct per-channel HRTF
    surDry.gain.value=SUR_MODES[surMode][1];
    surWet.gain.value=SUR_MODES[surMode][0];
    const [,,,htGain,widthScale]=SUR_MODES[surMode];
    // Connect reverb send
    n.connect(surConv);
    surConv.connect(surWet);
    // Fan out to all 14 panners
    CH914.forEach((ch,i)=>{
      // Direct (dry) signal to each panner
      n.connect(surDry);
      surDry.connect(surGains[i]);
      // Reverb (wet) to height channels only for realism
      if(ch.t==='ht'){
        surWet.connect(surGains[i]);
        surGains[i].gain.value=ch.gain*htGain;
      } else if(ch.t==='sub'){
        surGains[i].gain.value=ch.gain*1.1; // slight LFE boost
      } else {
        surGains[i].gain.value=ch.gain;
      }
      surGains[i].connect(surPanners[i]);
      surPanners[i].connect(analyserN);
    });
    applySurWidth(widthScale*(surWidth_/12));
  } else {
    // Bypass: direct to analyser
    n.connect(analyserN);
  }
  analyserN.connect(masterGain);
  masterGain.connect(ACX.destination);
}

function rebuildPeqN(){
  if(!ACX)return;
  peqNodes.forEach(n=>{try{n.disconnect();}catch(e){}});
  peqNodes=peqBands.map(b=>{
    const f=ACX.createBiquadFilter();
    f.type=b.t; f.frequency.value=Math.max(20,Math.min(b.f,ACX.sampleRate*.499));
    f.gain.value=b.g; f.Q.value=b.q; return f;
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SURROUND CONTROLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setSurround(mode,btn){
  document.querySelectorAll('.smb').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on'); surMode=mode;
  document.getElementById('surDesc').textContent=SUR_DESC[mode];
  document.getElementById('bSur').className='tbadge '+(mode!=='off'?'on-o':'off');
  document.getElementById('bSur').textContent=mode==='off'?'SURROUND OFF':'SURR '+mode.toUpperCase();
  if(!ACX)return;
  buildSurImpulse(mode);
  if(mode!=='off'){
    const[wet,dry,,htG,ws]=SUR_MODES[mode];
    surWet.gain.setTargetAtTime(wet,ACX.currentTime,.05);
    surDry.gain.setTargetAtTime(dry,ACX.currentTime,.05);
    CH914.forEach((ch,i)=>{
      const tgt=ch.t==='ht'?ch.gain*htG:ch.gain;
      surGains[i].gain.setTargetAtTime(tgt,ACX.currentTime,.05);
    });
    applySurWidth(ws*(surWidth_/12));
  }
  connectChain();
}
function onSurRoom(el){
  surRoom_=+el.value;
  document.getElementById('surRoomV').textContent=surRoom_;
  el.style.setProperty('--p',(surRoom_/20*100)+'%');
  if(ACX&&surMode!=='off')buildSurImpulse(surMode);
}
function onSurWidth(el){
  surWidth_=+el.value;
  document.getElementById('surWidthV').textContent=surWidth_;
  el.style.setProperty('--p',(surWidth_/20*100)+'%');
  if(ACX&&surMode!=='off'){
    const[,,,, ws]=SUR_MODES[surMode];
    applySurWidth(ws*(surWidth_/12));
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHANNEL METER UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildSurGrid(){
  const g=document.getElementById('surGrid'); g.innerHTML='';
  CH914.forEach((ch,i)=>{
    const d=document.createElement('div');
    d.className='sur-ch '+(ch.t==='sub'?'sub':ch.t==='ht'?'ht':'');
    d.id='sc_'+i;
    d.innerHTML=`<div class="chn">${ch.n}</div><div class="chd" id="sd_${i}">âˆ’âˆ</div>
      <div class="chl"><div class="chb" id="sb_${i}" style="background:${ch.t==='sub'?'var(--acc)':ch.t==='ht'?'var(--acG)':'var(--acO)'}"></div></div>`;
    g.appendChild(d);
  });
}
buildSurGrid();

function animateSur(){
  requestAnimationFrame(animateSur);
  if(!analyserN)return;
  const d=new Uint8Array(analyserN.frequencyBinCount);
  analyserN.getByteFrequencyData(d);
  const bins=d.length;
  CH914.forEach((ch,i)=>{
    let s,e;
    if(ch.t==='sub'){s=0;e=Math.floor(bins*.015);}
    else if(ch.t==='ht'){s=Math.floor(bins*.12);e=Math.floor(bins*.55);}
    else{const sp=i/9;s=Math.floor(bins*sp*.8);e=Math.floor(bins*(sp*.8+.09));}
    let sum=0,cnt=0;
    for(let j=s;j<e&&j<bins;j++){sum+=d[j];cnt++;}
    const pct=cnt>0?(sum/cnt)/255*100:0;
    const bar=document.getElementById('sb_'+i);
    const lbl=document.getElementById('sd_'+i);
    if(bar)bar.style.width=pct+'%';
    if(lbl)lbl.textContent=pct>0.5?(20*Math.log10(pct/100)).toFixed(0)+'dB':'âˆ’âˆ';
  });
}
animateSur();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PKCE HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function genVerifier(){
  const a=new Uint8Array(32); crypto.getRandomValues(a);
  return btoa(String.fromCharCode(...a)).replace(/\+/g,'-').replace(/\//g,'_').replace(/=/g,'');
}
async function genChallenge(v){
  const d=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(v));
  return btoa(String.fromCharCode(...new Uint8Array(d))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=/g,'');
}
const REDIRECT=()=>location.origin+location.pathname;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLATFORM MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openPlatform(id){
  pendingPlatform=id;
  if(STATE.connected[id]){showStreamPanel(id);return;}
  const p=PLATFORMS[id];
  document.getElementById('modalTitle').textContent='Connect '+p.name;
  document.getElementById('modalDesc').textContent='';
  document.getElementById('modalBtn').style.display='inline-flex';
  document.getElementById('modalBtn').style.background=p.color;
  document.getElementById('modalBtn').style.borderColor=p.color;
  document.getElementById('modalBtn').textContent='Connect â†’';
  let html=p.setupHtml;
  p.fields.forEach(f=>{
    html+=`<label>${f.label}<span style="color:var(--sub);font-size:9px;font-weight:400;margin-left:6px">${f.hint||''}</span></label>
           <input id="mf_${f.id}" type="text" placeholder="${f.placeholder}" autocomplete="off">`;
  });
  document.getElementById('modalBody').innerHTML=html;
  // Fill redirect URIs
  ['spRedirect','dzRedirect','tdRedirect','ytRedirect'].forEach(rid=>{
    const el=document.getElementById(rid);
    if(el)el.textContent=REDIRECT();
  });
  document.getElementById('modalBg').style.display='flex';
}
function closeModal(){document.getElementById('modalBg').style.display='none';pendingPlatform=null;}

async function doConnect(){
  const id=pendingPlatform; if(!id)return;
  const p=PLATFORMS[id];
  const creds={};
  p.fields.forEach(f=>{creds[f.id]=(document.getElementById('mf_'+f.id)||{}).value?.trim()||'';});
  const first=creds[p.fields[0].id];
  if(!first){alert('Please fill in the required field.');return;}
  document.getElementById('modalBtn').disabled=true;
  document.getElementById('modalBtn').textContent='Connectingâ€¦';
  try{
    STATE.connected[id]={...creds};
    if(id==='spotify')  { await initSpotify(creds); return; }  // redirects
    if(id==='tidal')    { await initTidal(creds); return; }     // redirects
    if(id==='youtube')  { await initYouTube(creds); return; }   // redirects
    if(id==='deezer')   await initDeezer(creds);
    if(id==='apple')    await initApple(creds);
    updatePlatformUI(id,true); showStreamPanel(id); closeModal();
  }catch(e){
    alert('Connection error: '+e.message);
    delete STATE.connected[id];
    document.getElementById('modalBtn').disabled=false;
    document.getElementById('modalBtn').textContent='Connect â†’';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SPOTIFY â€” PKCE OAuth 2.0
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function initSpotify({clientId}){
  const v=genVerifier(), c=await genChallenge(v);
  sessionStorage.setItem('sp_v',v); sessionStorage.setItem('sp_cid',clientId);
  const params=new URLSearchParams({
    client_id:clientId, response_type:'code',
    redirect_uri:REDIRECT(), scope:PLATFORMS.spotify.scope,
    code_challenge_method:'S256', code_challenge:c, state:'spotify_auth'
  });
  location.href='https://accounts.spotify.com/authorize?'+params;
}
async function spotifyOAuthCallback(){
  const p=new URLSearchParams(location.search);
  if(p.get('state')!=='spotify_auth'||!p.get('code'))return false;
  const code=p.get('code'), v=sessionStorage.getItem('sp_v'), cid=sessionStorage.getItem('sp_cid');
  if(!v||!cid)return false;
  history.replaceState({},'',location.pathname);
  const res=await fetch('https://accounts.spotify.com/api/token',{
    method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'},
    body:new URLSearchParams({grant_type:'authorization_code',code,redirect_uri:REDIRECT(),client_id:cid,code_verifier:v})
  });
  const data=await res.json();
  if(!data.access_token)throw new Error('Spotify token exchange failed');
  STATE.connected.spotify={token:data.access_token,refreshToken:data.refresh_token,clientId:cid,expiresAt:Date.now()+data.expires_in*1000};
  sessionStorage.removeItem('sp_v'); sessionStorage.removeItem('sp_cid');
  updatePlatformUI('spotify',true); showStreamPanel('spotify');
  loadSpotifySDK(data.access_token);
  return true;
}
function loadSpotifySDK(token){
  window.onSpotifyWebPlaybackSDKReady=()=>{
    const player=new Spotify.Player({name:'Dolby Unified Player',getOAuthToken:cb=>cb(token),volume:.8});
    player.addListener('ready',({device_id})=>{STATE.connected.spotify.deviceId=device_id;});
    player.addListener('player_state_changed',s=>{
      if(!s)return;
      document.getElementById('playBtn').textContent=s.paused?'â–¶':'â¸';
    });
    player.connect(); STATE.spotifyPlayer=player;
  };
  if(!document.getElementById('spSDK')){
    const s=document.createElement('script'); s.id='spSDK';
    s.src=PLATFORMS.spotify.sdkSrc; document.head.appendChild(s);
  }
}
async function refreshSpotifyToken(){
  const c=STATE.connected.spotify;
  if(!c?.refreshToken||!c?.clientId)return;
  if(Date.now()<(c.expiresAt||0)-60000)return; // still valid
  const res=await fetch('https://accounts.spotify.com/api/token',{
    method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'},
    body:new URLSearchParams({grant_type:'refresh_token',refresh_token:c.refreshToken,client_id:c.clientId})
  });
  const data=await res.json();
  if(data.access_token){
    c.token=data.access_token;
    c.expiresAt=Date.now()+data.expires_in*1000;
    if(data.refresh_token)c.refreshToken=data.refresh_token;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DEEZER â€” Implicit OAuth via DZ SDK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function initDeezer({appId}){
  await loadScript('https://e-cdns-files.dzcdn.net/js/min/dz.js');
  await new Promise(res=>{
    DZ.init({appId,channelUrl:location.origin+'/channel.html',player:{onload:res}});
    setTimeout(res,3500);
  });
  await new Promise((res,rej)=>{
    DZ.login(resp=>{
      if(resp.authResponse){STATE.connected.deezer.token=resp.authResponse.accessToken;res();}
      else rej(new Error('Deezer login cancelled or failed'));
    },{perms:'basic_access,email,offline_access,listening_history,manage_library'});
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TIDAL â€” OAuth 2.1 + PKCE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function initTidal({clientId}){
  const v=genVerifier(), c=await genChallenge(v);
  sessionStorage.setItem('td_v',v); sessionStorage.setItem('td_cid',clientId);
  const params=new URLSearchParams({
    response_type:'code', client_id:clientId,
    redirect_uri:REDIRECT(), scope:PLATFORMS.tidal.scope,
    code_challenge_method:'S256', code_challenge:c, state:'tidal_auth'
  });
  location.href='https://login.tidal.com/authorize?'+params;
}
async function tidalOAuthCallback(){
  const p=new URLSearchParams(location.search);
  if(p.get('state')!=='tidal_auth'||!p.get('code'))return false;
  const code=p.get('code'), v=sessionStorage.getItem('td_v'), cid=sessionStorage.getItem('td_cid');
  if(!v||!cid)return false;
  history.replaceState({},'',location.pathname);
  const res=await fetch('https://auth.tidal.com/v1/oauth2/token',{
    method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'},
    body:new URLSearchParams({grant_type:'authorization_code',code,redirect_uri:REDIRECT(),client_id:cid,code_verifier:v})
  });
  const data=await res.json();
  if(!data.access_token)throw new Error('Tidal token exchange failed');
  STATE.connected.tidal={token:data.access_token,refreshToken:data.refresh_token,clientId:cid,countryCode:'US',expiresAt:Date.now()+data.expires_in*1000};
  sessionStorage.removeItem('td_v'); sessionStorage.removeItem('td_cid');
  updatePlatformUI('tidal',true); showStreamPanel('tidal');
  return true;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APPLE MUSIC â€” MusicKit JS v3
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function initApple({devToken}){
  if(!window.MusicKit) throw new Error('MusicKit JS not loaded yet. Wait a moment and try again.');
  const mk=await MusicKit.configure({developerToken:devToken,app:{name:'Dolby Unified Player',build:'1.0.0'}});
  await mk.authorize(); // triggers Apple sign-in popup
  STATE.connected.apple.mk=mk; STATE.mkInstance=mk;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// YOUTUBE â€” Google OAuth 2.0 PKCE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function initYouTube({clientId}){
  const v=genVerifier(), c=await genChallenge(v);
  sessionStorage.setItem('yt_v',v); sessionStorage.setItem('yt_cid',clientId);
  const params=new URLSearchParams({
    client_id:clientId, response_type:'code',
    redirect_uri:REDIRECT(), scope:PLATFORMS.youtube.scope,
    code_challenge_method:'S256', code_challenge:c,
    state:'youtube_auth', access_type:'offline', prompt:'consent'
  });
  location.href='https://accounts.google.com/o/oauth2/v2/auth?'+params;
}
async function youtubeOAuthCallback(){
  const p=new URLSearchParams(location.search);
  if(p.get('state')!=='youtube_auth'||!p.get('code'))return false;
  const code=p.get('code'), v=sessionStorage.getItem('yt_v'), cid=sessionStorage.getItem('yt_cid');
  if(!v||!cid)return false;
  history.replaceState({},'',location.pathname);
  // Exchange code (requires server-side or CORS proxy for Google â€” use token endpoint directly)
  const res=await fetch('https://oauth2.googleapis.com/token',{
    method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'},
    body:new URLSearchParams({grant_type:'authorization_code',code,redirect_uri:REDIRECT(),client_id:cid,code_verifier:v})
  });
  const data=await res.json();
  if(!data.access_token)throw new Error('Google token exchange failed: '+(data.error_description||data.error||'unknown'));
  STATE.connected.youtube={token:data.access_token,refreshToken:data.refresh_token,clientId:cid,expiresAt:Date.now()+(data.expires_in||3600)*1000};
  sessionStorage.removeItem('yt_v'); sessionStorage.removeItem('yt_cid');
  updatePlatformUI('youtube',true); showStreamPanel('youtube');
  await loadYTiFrame();
  return true;
}
async function loadYTiFrame(){
  return new Promise(res=>{
    window.onYouTubeIframeAPIReady=res;
    if(window.YT&&window.YT.Player){res();return;}
    const s=document.createElement('script'); s.src='https://www.youtube.com/iframe_api'; document.head.appendChild(s);
  }).then(()=>{
    const container=document.getElementById('ytFrame'); container.style.display='block';
    STATE.ytPlayer=new YT.Player('ytFrame',{width:1,height:1,
      playerVars:{autoplay:0,controls:0,origin:location.origin},
      events:{
        onReady:()=>{STATE.ytReady=true;},
        onStateChange:e=>{
          if(e.data===YT.PlayerState.ENDED)nextTrk();
          document.getElementById('playBtn').textContent=(e.data===YT.PlayerState.PLAYING)?'â¸':'â–¶';
        }
      }
    });
  });
}
async function refreshYouTubeToken(){
  const c=STATE.connected.youtube;
  if(!c?.refreshToken||!c?.clientId)return;
  if(Date.now()<(c.expiresAt||0)-60000)return;
  const res=await fetch('https://oauth2.googleapis.com/token',{
    method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'},
    body:new URLSearchParams({grant_type:'refresh_token',refresh_token:c.refreshToken,client_id:c.clientId})
  });
  const data=await res.json();
  if(data.access_token){c.token=data.access_token;c.expiresAt=Date.now()+(data.expires_in||3600)*1000;}
}

function disconnectPlatform(){
  const id=STATE.activePlatform; if(!id)return;
  if(id==='spotify'&&STATE.spotifyPlayer){try{STATE.spotifyPlayer.disconnect();}catch(e){} STATE.spotifyPlayer=null;}
  if(id==='youtube'&&STATE.ytPlayer){try{STATE.ytPlayer.destroy();}catch(e){} STATE.ytPlayer=null; STATE.ytReady=false;}
  delete STATE.connected[id];
  updatePlatformUI(id,false);
  document.getElementById('streamPanel').classList.remove('open');
  STATE.activePlatform=null; updateSrcBadge('LOCAL');
}
function updatePlatformUI(id,conn){
  const card=document.getElementById('pc-'+id), status=document.getElementById('ps-'+id);
  if(conn){card.classList.add('connected');status.textContent='CONNECTED';status.className='pstatus conn';}
  else{card.classList.remove('connected');status.textContent='CONNECT';status.className='pstatus disc';}
}
function showStreamPanel(id){
  STATE.activePlatform=id;
  const p=PLATFORMS[id], panel=document.getElementById('streamPanel');
  panel.classList.add('open');
  document.getElementById('streamLogo').textContent=p.icon;
  document.getElementById('streamTitle').textContent=p.name;
  document.getElementById('streamSub').textContent='Search '+p.name+' catalog';
  document.getElementById('sresults').innerHTML='';
  document.getElementById('searchInput').value='';
  updateSrcBadge(p.name.toUpperCase());
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SEARCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doSearch(){
  const q=document.getElementById('searchInput').value.trim(); if(!q)return;
  const id=STATE.activePlatform;
  document.getElementById('sresults').innerHTML='<div style="padding:12px;color:var(--sub);font-size:11px;text-align:center">ğŸ” Searchingâ€¦</div>';
  try{
    let results=[];
    if(id==='spotify') results=await searchSpotify(q);
    if(id==='deezer')  results=await searchDeezer(q);
    if(id==='tidal')   results=await searchTidal(q);
    if(id==='apple')   results=await searchApple(q);
    if(id==='youtube') results=await searchYouTube(q);
    renderResults(results);
  }catch(e){
    document.getElementById('sresults').innerHTML=`<div style="padding:12px;color:var(--red);font-size:11px">${e.message}</div>`;
  }
}
async function searchSpotify(q){
  await refreshSpotifyToken();
  const token=STATE.connected.spotify?.token; if(!token)throw new Error('Not authenticated');
  const r=await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(q)}&type=track&limit=10`,{headers:{Authorization:'Bearer '+token}});
  const d=await r.json(); if(d.error)throw new Error(d.error.message);
  return d.tracks.items.map(t=>({id:'sp:'+t.id,name:t.name,artist:t.artists.map(a=>a.name).join(', '),duration:msToTime(t.duration_ms),art:t.album.images[0]?.url,uri:t.uri,platform:'spotify'}));
}
async function searchDeezer(q){
  const r=await fetch(`https://api.deezer.com/search?q=${encodeURIComponent(q)}&limit=10`);
  const d=await r.json(); if(d.error)throw new Error(d.error.message||'Deezer error');
  return (d.data||[]).map(t=>({id:'dz:'+t.id,name:t.title,artist:t.artist.name,duration:secToTime(t.duration),art:t.album.cover_small,preview:t.preview,platform:'deezer'}));
}
async function searchTidal(q){
  const token=STATE.connected.tidal?.token; if(!token)throw new Error('Not authenticated');
  const cc=STATE.connected.tidal.countryCode||'US';
  const r=await fetch(`https://openapi.tidal.com/v2/searchresults/${encodeURIComponent(q)}/relationships/tracks?countryCode=${cc}&include=tracks`,{headers:{Authorization:'Bearer '+token,'Content-Type':'application/vnd.tidal.v1+json'}});
  const d=await r.json();
  return (d.included||d.data||[]).slice(0,10).map(t=>{
    const a=t.attributes||{};
    return{id:'td:'+t.id,name:a.title||t.id,artist:a.artist||'',duration:a.duration||'',art:null,platform:'tidal'};
  });
}
async function searchApple(q){
  const mk=STATE.mkInstance; if(!mk)throw new Error('MusicKit not initialized');
  const r=await mk.api.music('/v1/catalog/us/search',{term:q,types:'songs',limit:10});
  return(r.data?.results?.songs?.data||[]).map(s=>({
    id:'am:'+s.id,name:s.attributes.name,artist:s.attributes.artistName,
    duration:msToTime(s.attributes.durationInMillis),
    art:s.attributes.artwork?.url?.replace('{w}','80').replace('{h}','80'),
    appleId:s.id,platform:'apple'
  }));
}
async function searchYouTube(q){
  await refreshYouTubeToken();
  const token=STATE.connected.youtube?.token; if(!token)throw new Error('Not authenticated');
  const r=await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(q)}&type=video&videoCategoryId=10&maxResults=10`,{headers:{Authorization:'Bearer '+token}});
  const d=await r.json(); if(d.error)throw new Error(d.error.message);
  return d.items.map(v=>({
    id:'yt:'+v.id.videoId,name:v.snippet.title,artist:v.snippet.channelTitle,
    duration:'',art:v.snippet.thumbnails?.default?.url,videoId:v.id.videoId,platform:'youtube'
  }));
}
function renderResults(results){
  const c=document.getElementById('sresults');
  if(!results.length){c.innerHTML='<div style="padding:12px;color:var(--sub);font-size:11px;text-align:center">No results</div>';return;}
  c.innerHTML='';
  results.forEach(r=>{
    const d=document.createElement('div'); d.className='strack';
    d.innerHTML=`<div class="strack-art">${r.art?`<img src="${r.art}" alt="" onerror="this.parentNode.textContent='ğŸµ'">`:'ğŸµ'}</div>
      <div class="strack-info"><div class="strack-name">${escHtml(r.name)}</div><div class="strack-artist">${escHtml(r.artist||'')}</div></div>
      <span class="strack-dur">${r.duration||''}</span>
      <button class="strack-play">â–¶</button>`;
    d.querySelector('.strack-play').onclick=()=>playStreamTrack(r);
    d.onclick=e=>{if(e.target.tagName!=='BUTTON')playStreamTrack(r);};
    c.appendChild(d);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STREAM PLAYBACK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function playStreamTrack(track){
  document.getElementById('npTitle').textContent=track.name;
  document.getElementById('npSub').textContent=(track.artist||'')+(track.duration?' Â· '+track.duration:'');
  updateSrcBadge(PLATFORMS[track.platform].name.toUpperCase());
  if(track.platform==='spotify'){
    const dId=STATE.connected.spotify?.deviceId, token=STATE.connected.spotify?.token;
    if(dId&&token){
      await refreshSpotifyToken();
      await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${dId}`,{
        method:'PUT', headers:{Authorization:'Bearer '+STATE.connected.spotify.token,'Content-Type':'application/json'},
        body:JSON.stringify({uris:[track.uri]})
      });
      document.getElementById('playBtn').textContent='â¸';
    } else alert('Spotify player not ready. Make sure Premium account and SDK loaded.');
  }
  else if(track.platform==='deezer'){
    if(window.DZ){DZ.player.playTracks([track.id.replace('dz:','')]);document.getElementById('playBtn').textContent='â¸';}
    else if(track.preview){if(!inited)initAudio();AUD.src=track.preview;AUD.play();document.getElementById('playBtn').textContent='â¸';}
  }
  else if(track.platform==='apple'){
    if(STATE.mkInstance){await STATE.mkInstance.setQueue({song:track.appleId});await STATE.mkInstance.play();document.getElementById('playBtn').textContent='â¸';}
  }
  else if(track.platform==='youtube'){
    if(!STATE.ytReady||!STATE.ytPlayer){await loadYTiFrame();}
    STATE.ytPlayer.loadVideoById(track.videoId);
    STATE.ytPlayer.playVideo();
    document.getElementById('playBtn').textContent='â¸';
  }
  else if(track.platform==='tidal'){
    alert('Tidal: full playback requires the native TIDAL SDK. Opening track in TIDAL appâ€¦\nhttps://tidal.com/track/'+track.id.replace('td:',''));
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DOLBY ON TOOLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setStyle(key,btn){
  document.querySelectorAll('.sbtn').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on'); styleKey=key;
  if(inited)applyStyle();
}
function applyStyle(){
  styleN.forEach(n=>{try{n.disconnect();}catch(e){}});
  styleN=(STYLE_EQ[styleKey]||[]).map(b=>{
    const f=ACX.createBiquadFilter(); f.type=b.t; f.frequency.value=b.f; f.Q.value=b.q||1.4;
    f.gain.value=b.g*(styleInt_/10); return f;
  });
  connectChain();
}
function onStyleInt(el){
  styleInt_=+el.value; document.getElementById('styleIntV').textContent=styleInt_;
  el.style.setProperty('--p',(styleInt_/20*100)+'%');
  if(inited)applyStyle();
}
function onNR(cb){
  nrOn=cb.checked;
  const l=document.getElementById('nrLbl'); l.textContent=nrOn?'Active':'Off'; l.style.color=nrOn?'var(--acG)':'var(--sub)';
  document.getElementById('nrAmt').disabled=!nrOn;
  document.getElementById('bNR').className='tbadge '+(nrOn?'on-g':'off');
  document.getElementById('bNR').textContent=nrOn?'NR ON':'NR OFF';
  if(inited)applyNR();
}
function onNRamt(el){nrAmt_=+el.value;document.getElementById('nrAmtV').textContent=nrAmt_;el.style.setProperty('--p',(nrAmt_/20*100)+'%');if(inited)applyNR();}
function applyNR(){if(!nrNode)return;nrNode.frequency.value=nrOn?20+(nrAmt_/20)*200:20;nrNode.Q.value=nrOn?.6+(nrAmt_/20)*1.8:.1;}
function onTone(band,el){
  const v=+el.value; toneV[band]=v;
  const k=band.charAt(0).toUpperCase()+band.slice(1);
  document.getElementById('v'+k).textContent=(v>0?'+':'')+v;
  if(toneN[band])toneN[band].gain.value=v*.75;
}
function onBoost(el){
  boostLv=+el.value; document.getElementById('boostV').textContent=boostLv;
  document.getElementById('boostFill').style.width=(boostLv/20*100)+'%';
  el.style.setProperty('--p',(boostLv/20*100)+'%');
  applyBoost(boostLv);
}
function applyBoost(lv){
  if(!compNode)return;
  const t=lv/20;
  compNode.threshold.value=-44+t*24; compNode.ratio.value=3+t*17;
  compNode.knee.value=30-t*22; compNode.attack.value=.003; compNode.release.value=.30-t*.18;
  if(masterGain)masterGain.gain.value=.55+t*.85;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTO LIBRARY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function autoScanLib(){
  if(!window.showDirectoryPicker){document.getElementById('folderIn').click();return;}
  try{
    const dir=await window.showDirectoryPicker({mode:'read'});
    autoLibHandle=dir;
    document.getElementById('libBanner').style.display='flex';
    document.getElementById('libBannerTxt').textContent='Scanning "'+dir.name+'"â€¦';
    await scanDirHandle(dir,dir.name);
    document.getElementById('libBannerTxt').textContent='"'+dir.name+'" Â· '+tracks.length+' tracks Â· watching';
    clearInterval(autoLibWatcher);
    autoLibWatcher=setInterval(async()=>{
      const added=await scanDirHandle(autoLibHandle,autoLibHandle.name);
      if(added){document.getElementById('libBannerTxt').textContent='+'+added+' new Â· '+tracks.length+' total';}
    },30000);
  }catch(e){if(e.name!=='AbortError')alert('Access error: '+e.message);}
}
async function scanDirHandle(dir,folder,depth=0){
  let added=0;
  for await(const[name,handle]of dir.entries()){
    if(handle.kind==='file'&&AUDIO_EXTS.test(name)){
      const key=folder+'/'+name;
      if(!tracks.find(t=>t._key===key)){
        try{
          const file=await handle.getFile();
          const url=URL.createObjectURL(file);
          const t={name:name.replace(/\.[^/.]+$/,''),url,folder,_key:key};
          const ex=folders.find(x=>x.name===folder);
          if(ex)ex.tracks.push(t); else folders.push({name:folder,tracks:[t],open:depth===0});
          tracks.push(t); added++;
        }catch(e){}
      }
    } else if(handle.kind==='directory'&&depth<4){
      added+=await scanDirHandle(handle,folder+'/'+name,depth+1);
    }
  }
  if(added){renderLib();if(curIdx<0&&tracks.length)loadTrack(0);}
  return added;
}
function scanFolder(){document.getElementById('folderIn').click();}
function onFolderScan(e){
  const files=Array.from(e.target.files).filter(f=>AUDIO_EXTS.test(f.name)||f.type.startsWith('audio/'));
  if(!files.length)return;
  const map={};
  files.forEach(f=>{const p=f.webkitRelativePath.split('/');const fd=p.length>1?p[0]:'Root';(map[fd]=map[fd]||[]).push(f);});
  Object.entries(map).forEach(([nm,fls])=>{
    const nt=fls.map(f=>({name:f.name.replace(/\.[^/.]+$/,''),url:URL.createObjectURL(f),folder:nm}));
    const ex=folders.find(x=>x.name===nm);
    if(ex)ex.tracks.push(...nt); else folders.push({name:nm,tracks:nt,open:true});
    tracks.push(...nt);
  });
  renderLib(); if(curIdx<0&&tracks.length)loadTrack(0);
}
function onFileIn(e){addFiles(Array.from(e.target.files).filter(f=>AUDIO_EXTS.test(f.name)||f.type.startsWith('audio/')));}
function addFiles(files,fn='Dropped Files'){
  if(!files.length)return;
  const nt=files.map(f=>({name:f.name.replace(/\.[^/.]+$/,''),url:URL.createObjectURL(f),folder:fn}));
  const ex=folders.find(x=>x.name===fn);
  if(ex)ex.tracks.push(...nt); else folders.push({name:fn,tracks:nt,open:true});
  tracks.push(...nt); renderLib(); if(curIdx<0&&tracks.length)loadTrack(0);
}
function renderLib(){
  const scroll=document.getElementById('libScroll');
  document.getElementById('libEmpty').style.display=folders.length?'none':'block';
  scroll.querySelectorAll('.frow,.trow').forEach(e=>e.remove());
  folders.forEach(fd=>{
    const fr=document.createElement('div');
    fr.className='frow'+(fd.open?' open':'');
    fr.innerHTML=`<span class="fi">â–¶</span><div style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${fd.name}</div><div class="fmeta">${fd.tracks.length}</div>`;
    fr.onclick=()=>{fd.open=!fd.open;renderLib();};
    scroll.appendChild(fr);
    if(fd.open)fd.tracks.forEach(t=>{
      const idx=tracks.indexOf(t), tr=document.createElement('div');
      tr.className='trow'+(idx===curIdx?' act':'');
      tr.innerHTML=`<span class="tname">${t.name}</span>`;
      tr.onclick=()=>{loadTrack(idx);playAudio();};
      scroll.appendChild(tr);
    });
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLAYBACK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadTrack(idx){
  curIdx=idx; const t=tracks[idx];
  AUD.src=t.url; AUD.load();
  document.getElementById('npTitle').textContent=t.name;
  document.getElementById('npSub').textContent=t.folder||'';
  updateSrcBadge('LOCAL'); renderLib();
}
function playAudio(){
  if(!inited)initAudio();
  if(ACX.state==='suspended')ACX.resume();
  AUD.play(); document.getElementById('playBtn').textContent='â¸';
}
function pauseAudio(){AUD.pause();document.getElementById('playBtn').textContent='â–¶';}
function togglePlay(){
  if(STATE.activePlatform==='youtube'&&STATE.ytPlayer&&STATE.ytReady){
    STATE.ytPlayer.getPlayerState()===1?STATE.ytPlayer.pauseVideo():STATE.ytPlayer.playVideo(); return;
  }
  if(STATE.activePlatform==='spotify'&&STATE.spotifyPlayer){
    STATE.spotifyPlayer.togglePlay(); return;
  }
  if(STATE.activePlatform==='apple'&&STATE.mkInstance){
    STATE.mkInstance.isPlaying?STATE.mkInstance.pause():STATE.mkInstance.play(); return;
  }
  if(!tracks.length){document.getElementById('fileIn').click();return;}
  if(curIdx<0){loadTrack(0);playAudio();return;}
  if(!inited)initAudio();
  if(ACX.state==='suspended')ACX.resume();
  AUD.paused?playAudio():pauseAudio();
}
function prevTrk(){if(!tracks.length)return;const i=doShuffle?randIdx():Math.max(0,curIdx-1);loadTrack(i);playAudio();}
function nextTrk(){if(!tracks.length)return;let i=doShuffle?randIdx():curIdx+1;if(i>=tracks.length)i=0;loadTrack(i);playAudio();}
function randIdx(){return Math.floor(Math.random()*tracks.length);}
function toggleRepeat(){doRepeat=!doRepeat;document.getElementById('repBtn').classList.toggle('on',doRepeat);AUD.loop=doRepeat;}
function toggleShuffle(){doShuffle=!doShuffle;document.getElementById('shufBtn').classList.toggle('on',doShuffle);}
function seek(v){if(AUD.duration)AUD.currentTime=AUD.duration*(v/100);}
function setVol(v){
  if(masterGain)masterGain.gain.value=+v*(.55+(boostLv/20)*.85); else AUD.volume=+v;
  if(STATE.ytPlayer&&STATE.ytReady)STATE.ytPlayer.setVolume(+v*100);
  if(STATE.spotifyPlayer)STATE.spotifyPlayer.setVolume(+v);
}
function fmtT(s){s=s||0;return Math.floor(s/60)+':'+String(Math.floor(s%60)).padStart(2,'0');}
AUD.addEventListener('timeupdate',()=>{
  const d=AUD.duration||1;
  document.getElementById('seekBar').value=(AUD.currentTime/d)*100;
  document.getElementById('tCur').textContent=fmtT(AUD.currentTime);
  document.getElementById('tDur').textContent=fmtT(AUD.duration);
});
AUD.addEventListener('ended',()=>{if(!doRepeat)nextTrk();});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WAV EXPORT â€” 24-bit / 192kHz
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportInfo(){
  alert('WAV Export Spec:\nâ€¢ Format: 24-bit integer PCM\nâ€¢ Sample Rate: 192,000 Hz\nâ€¢ Channels: 2 (stereo â€” 9.1.4 HRTF binaural mixdown)\nâ€¢ Bitrate: 9,216 kbps\nâ€¢ RIFF header type=1 (PCM)\nâ€¢ Full DSP chain applied offline\n\nLocal files only â€” streaming providers prohibit re-encoding.');
}
async function exportWAV(){
  if(!tracks.length||curIdx<0){alert('Load a local file first.');return;}
  const btn=document.querySelector('.wbtn.p');
  btn.textContent='â³ Renderingâ€¦'; btn.disabled=true;
  document.getElementById('wpr').style.display='block';
  document.getElementById('wavDot').classList.add('act');
  document.getElementById('wavTxt').textContent='Rendering at 192kHzâ€¦';
  try{
    const url=tracks[curIdx].url;
    setProgress(10,'Fetching audioâ€¦');
    const resp=await fetch(url); const ab=await resp.arrayBuffer();
    setProgress(25,'Decodingâ€¦');
    const tmp=new AudioContext(); const tb=await tmp.decodeAudioData(ab.slice(0)); await tmp.close();
    const len=Math.floor(tb.duration*TARGET_SR);
    setProgress(40,'Building offline context at 192kHzâ€¦');
    const OAC=new OfflineAudioContext(TARGET_CH,len,TARGET_SR);
    const sb=await OAC.decodeAudioData(ab.slice(0));
    const src=OAC.createBufferSource(); src.buffer=sb;
    let n=src;
    // NR
    const oNR=OAC.createBiquadFilter(); oNR.type='highpass';
    oNR.frequency.value=nrOn?20+(nrAmt_/20)*200:20; oNR.Q.value=nrOn?.6+(nrAmt_/20)*1.8:.1;
    n.connect(oNR); n=oNR;
    // Style
    (STYLE_EQ[styleKey]||[]).forEach(b=>{const f=OAC.createBiquadFilter();f.type=b.t;f.frequency.value=b.f;f.Q.value=b.q||1.4;f.gain.value=b.g*(styleInt_/10);n.connect(f);n=f;});
    // Tone
    const oB=OAC.createBiquadFilter();oB.type='lowshelf';oB.frequency.value=200;oB.gain.value=toneV.bass*.75;
    const oM=OAC.createBiquadFilter();oM.type='peaking';oM.frequency.value=1000;oM.Q.value=.8;oM.gain.value=toneV.mids*.75;
    const oT=OAC.createBiquadFilter();oT.type='highshelf';oT.frequency.value=5000;oT.gain.value=toneV.treble*.75;
    n.connect(oB);n=oB;n.connect(oM);n=oM;n.connect(oT);n=oT;
    // PEQ
    peqBands.forEach(b=>{const f=OAC.createBiquadFilter();f.type=b.t;f.frequency.value=Math.max(20,Math.min(b.f,TARGET_SR*.499));f.Q.value=b.q;f.gain.value=b.g;n.connect(f);n=f;});
    // Compressor
    const oC=OAC.createDynamicsCompressor();
    const t_=boostLv/20;
    oC.threshold.value=-44+t_*24;oC.ratio.value=3+t_*17;oC.knee.value=30-t_*22;oC.attack.value=.003;oC.release.value=.30-t_*.18;
    n.connect(oC);
    // 9.1.4 â†’ stereo binaural mixdown in offline context
    const oGain=OAC.createGain(); oGain.gain.value=.55+t_*.85;
    if(surMode!=='off'){
      const[wet,dry,,,ws]=SUR_MODES[surMode];
      const oDry=OAC.createGain(); oDry.gain.value=dry;
      const oWet=OAC.createGain(); oWet.gain.value=wet;
      const oConv=OAC.createConvolver();
      // Build impulse for offline context
      const dur=surRoom_*.3+0.5, dec=2.5;
      const il=Math.floor(TARGET_SR*dur);
      const ibuf=OAC.createBuffer(2,il,TARGET_SR);
      for(let c=0;c<2;c++){const dd=ibuf.getChannelData(c);for(let i=0;i<il;i++)dd[i]=(Math.random()*2-1)*Math.pow(1-i/il,dec);}
      oConv.buffer=ibuf;
      oC.connect(oDry); oC.connect(oConv); oConv.connect(oWet);
      const[,,,,widthScale]=SUR_MODES[surMode];
      CH914.forEach((ch,i)=>{
        const p=OAC.createPanner(); p.panningModel='HRTF';
        const effAz=ch.az*widthScale*(surWidth_/12);
        const{x,y,z}=azElToXYZ(effAz,ch.el,1);
        p.positionX.value=x;p.positionY.value=y;p.positionZ.value=z;
        const g=OAC.createGain();
        g.gain.value=ch.t==='ht'?ch.gain*SUR_MODES[surMode][3]:ch.gain;
        oDry.connect(g); if(ch.t==='ht')oWet.connect(g);
        g.connect(p); p.connect(oGain);
      });
    } else { oC.connect(oGain); }
    oGain.connect(OAC.destination);
    src.start(0);
    setProgress(60,'Rendering DSPâ€¦');
    const rendered=await OAC.startRendering();
    setProgress(85,'Encoding 24-bit WAVâ€¦');
    const blob=encodeWAV24(rendered);
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download=(tracks[curIdx].name||'export').replace(/[^a-z0-9]/gi,'_')+'_24bit_192kHz.wav';
    a.click();
    setProgress(100,'Export complete âœ“');
    document.getElementById('wavTxt').textContent='Export Complete âœ“';
  }catch(e){
    document.getElementById('wavTxt').textContent='Error: '+e.message;
    document.getElementById('wavTxt').style.color='var(--red)'; console.error(e);
  }
  btn.textContent='â¬‡ Export WAV (24-bit / 192kHz)'; btn.disabled=false;
  setTimeout(()=>{document.getElementById('wavDot').classList.remove('act');document.getElementById('wavTxt').style.color='var(--sub)';document.getElementById('wavTxt').textContent='Converter Ready';},5000);
}
function setProgress(pct,txt){
  document.getElementById('wprf').style.width=pct+'%';
  document.getElementById('wprtxt').textContent=txt;
}
function encodeWAV24(buf){
  const nc=buf.numberOfChannels,sr=buf.sampleRate,ns=buf.length,bp=3;
  const dl=ns*nc*bp, ab=new ArrayBuffer(44+dl), v=new DataView(ab);
  const ws=(o,s)=>{for(let i=0;i<s.length;i++)v.setUint8(o+i,s.charCodeAt(i));};
  ws(0,'RIFF');v.setUint32(4,36+dl,true);ws(8,'WAVE');ws(12,'fmt ');
  v.setUint32(16,16,true);v.setUint16(20,1,true);v.setUint16(22,nc,true);
  v.setUint32(24,sr,true);v.setUint32(28,sr*nc*bp,true);v.setUint16(32,nc*bp,true);v.setUint16(34,24,true);
  ws(36,'data');v.setUint32(40,dl,true);
  let off=44;
  for(let i=0;i<ns;i++)for(let c=0;c<nc;c++){
    const s=Math.max(-1,Math.min(1,buf.getChannelData(c)[i]));
    const int24=Math.round(s*8388607);
    v.setUint8(off,int24&0xFF);v.setUint8(off+1,(int24>>8)&0xFF);v.setUint8(off+2,(int24>>16)&0xFF);off+=3;
  }
  return new Blob([ab],{type:'audio/wav'});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARAMETRIC EQ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPeqUI(){
  const row=document.getElementById('pbands'); row.innerHTML='';
  peqBands.forEach((b,i)=>{
    const d=document.createElement('div');
    d.className='pb'+(i===selPeq?' sel':'');
    d.innerHTML=`<div class="pbf">${fmtF(b.f)}</div><div class="pbg">${b.g>0?'+':''}${b.g}dB</div><div class="pbt">${b.t}</div>`;
    d.onclick=()=>{selPeq=i;renderPeqUI();};
    row.appendChild(d);
  });
  const b=peqBands[selPeq];
  if(b){document.getElementById('peqType').value=b.t;document.getElementById('peqFreq').value=b.f;document.getElementById('peqGain').value=b.g;document.getElementById('peqQ').value=b.q;}
  drawPeq();
}
function updatePeqBand(){
  if(!peqBands[selPeq])return;
  peqBands[selPeq]={t:document.getElementById('peqType').value,f:Math.max(20,Math.min(96000,+document.getElementById('peqFreq').value)),g:+document.getElementById('peqGain').value,q:+document.getElementById('peqQ').value};
  if(ACX){const n=peqNodes[selPeq];if(n){const b=peqBands[selPeq];n.type=b.t;n.frequency.value=Math.max(20,Math.min(b.f,ACX.sampleRate*.499));n.gain.value=b.g;n.Q.value=b.q;}}
  renderPeqUI();
}
function addPeqBand(){peqBands.push({f:1000,g:0,q:1.4,t:'peaking'});selPeq=peqBands.length-1;if(ACX){rebuildPeqN();connectChain();}renderPeqUI();}
function removePeqBand(){if(peqBands.length<=1)return;peqBands.splice(selPeq,1);selPeq=Math.max(0,selPeq-1);if(ACX){rebuildPeqN();connectChain();}renderPeqUI();}
function resetPeq(){peqBands=[{f:20,g:0,q:.7,t:'lowshelf'},{f:60,g:0,q:1.4,t:'peaking'},{f:200,g:0,q:1.4,t:'peaking'},{f:600,g:0,q:1.4,t:'peaking'},{f:2000,g:0,q:1.4,t:'peaking'},{f:6000,g:0,q:1.4,t:'peaking'},{f:20000,g:0,q:1.4,t:'peaking'},{f:80000,g:0,q:.7,t:'highshelf'}];selPeq=0;if(ACX){rebuildPeqN();connectChain();}renderPeqUI();}
function peqClick(e){
  const c=e.target,r=c.getBoundingClientRect(),x=(e.clientX-r.left)/r.width,y=(e.clientY-r.top)/r.height;
  peqBands[selPeq].f=Math.round(20*Math.pow(96000/20,x));
  peqBands[selPeq].g=Math.max(-24,Math.min(24,Math.round((.5-y)*48)));
  updatePeqBand();
}
function drawPeq(){
  const canvas=document.getElementById('peq'),W=canvas.width,H=canvas.height;
  if(!W||!H)return;
  const ctx=canvas.getContext('2d'); ctx.clearRect(0,0,W,H);
  ctx.strokeStyle='#111120'; ctx.lineWidth=1;
  [20,100,500,2e3,10e3,40e3,96e3].forEach(f=>{
    const x=fToX(f,W); ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();
    ctx.fillStyle='#252540';ctx.font='9px sans-serif';ctx.fillText(fmtF(f),x+2,H-3);
  });
  [-18,-12,-6,0,6,12,18].forEach(g=>{const y=gToY(g,H);ctx.strokeStyle=g===0?'#20203a':'#111120';ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();});
  const SR=ACX?ACX.sampleRate:TARGET_SR;
  const freqs=Array.from({length:W},(_,i)=>20*Math.pow(96000/20,i/W));
  const sum=new Float32Array(W);
  peqBands.forEach(b=>{const mg=biquadMag(b,freqs,SR);for(let i=0;i<W;i++)sum[i]+=mg[i];});
  const gr=ctx.createLinearGradient(0,0,W,0);
  gr.addColorStop(0,'#6344f5');gr.addColorStop(.5,'#a060ff');gr.addColorStop(1,'#ff6b35');
  ctx.beginPath();ctx.strokeStyle=gr;ctx.lineWidth=2;
  for(let i=0;i<W;i++){const y=gToY(sum[i],H);i===0?ctx.moveTo(i,y):ctx.lineTo(i,y);}
  ctx.stroke();
  peqBands.forEach((b,i)=>{const x=fToX(b.f,W),y=gToY(b.g,H);ctx.beginPath();ctx.arc(x,y,i===selPeq?6:4,0,Math.PI*2);ctx.fillStyle=i===selPeq?'#ff6b35':'#6344f5';ctx.fill();});
}
function fmtF(f){return f>=1000?(f/1000).toFixed(f%1000===0?0:1)+'k':f+'Hz';}
function fToX(f,W){return W*Math.log(f/20)/Math.log(96000/20);}
function gToY(g,H){return H*(.5-g/48);}
function biquadMag(band,freqs,SR){
  const out=new Float32Array(freqs.length);
  const f0=band.f,G=band.g,Q=Math.max(band.q,.01),type=band.type||band.t;
  const A=Math.pow(10,G/40),sqA=Math.sqrt(A);
  freqs.forEach((f,i)=>{
    const w0=2*Math.PI*f0/SR,cw=Math.cos(w0),sw=Math.sin(w0),alpha=sw/(2*Q);
    let b0,b1,b2,a0,a1,a2;
    if(type==='peaking'){b0=1+alpha*A;b1=-2*cw;b2=1-alpha*A;a0=1+alpha/A;a1=-2*cw;a2=1-alpha/A;}
    else if(type==='lowshelf'){b0=A*((A+1)-(A-1)*cw+2*sqA*alpha);b1=2*A*((A-1)-(A+1)*cw);b2=A*((A+1)-(A-1)*cw-2*sqA*alpha);a0=(A+1)+(A-1)*cw+2*sqA*alpha;a1=-2*((A-1)+(A+1)*cw);a2=(A+1)+(A-1)*cw-2*sqA*alpha;}
    else if(type==='highshelf'){b0=A*((A+1)+(A-1)*cw+2*sqA*alpha);b1=-2*A*((A-1)+(A+1)*cw);b2=A*((A+1)+(A-1)*cw-2*sqA*alpha);a0=(A+1)-(A-1)*cw+2*sqA*alpha;a1=2*((A-1)-(A+1)*cw);a2=(A+1)-(A-1)*cw-2*sqA*alpha;}
    else if(type==='lowpass'){b0=(1-cw)/2;b1=1-cw;b2=(1-cw)/2;a0=1+alpha;a1=-2*cw;a2=1-alpha;}
    else if(type==='highpass'){b0=(1+cw)/2;b1=-(1+cw);b2=(1+cw)/2;a0=1+alpha;a1=-2*cw;a2=1-alpha;}
    else if(type==='notch'){b0=1;b1=-2*cw;b2=1;a0=1+alpha;a1=-2*cw;a2=1-alpha;}
    else if(type==='bandpass'){b0=alpha;b1=0;b2=-alpha;a0=1+alpha;a1=-2*cw;a2=1-alpha;}
    else{out[i]=0;return;}
    const w=2*Math.PI*f/SR;
    const cr={r:Math.cos(-w),i:Math.sin(-w)},cr2={r:Math.cos(-2*w),i:Math.sin(-2*w)};
    const nR=(b0+b1*cr.r+b2*cr2.r)/a0,nI=(b1*cr.i+b2*cr2.i)/a0;
    const dR=1+(a1*cr.r+a2*cr2.r)/a0,dI=(a1*cr.i+a2*cr2.i)/a0;
    const den=dR*dR+dI*dI;
    const hR=(nR*dR+nI*dI)/den,hI=(nI*dR-nR*dI)/den;
    out[i]=20*Math.log10(Math.max(1e-10,Math.sqrt(hR*hR+hI*hI)));
  });
  return out;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VISUALIZER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const vizC=document.getElementById('viz');
function resizeViz(){vizC.width=vizC.offsetWidth*devicePixelRatio;vizC.height=vizC.offsetHeight*devicePixelRatio;}
resizeViz(); window.addEventListener('resize',()=>{resizeViz();resizePeqC();});
function drawViz(){
  requestAnimationFrame(drawViz);
  const ct=vizC.getContext('2d'),W=vizC.width,H=vizC.height; ct.clearRect(0,0,W,H);
  if(!analyserN)return;
  const data=new Uint8Array(analyserN.frequencyBinCount); analyserN.getByteFrequencyData(data);
  const bw=W/data.length*2.4;
  for(let i=0;i<data.length;i++){
    const p=i/data.length,h=(data[i]/255)*H;
    ct.fillStyle=`rgb(${Math.round(99+p*156)},${Math.round(68+p*39)},${Math.round(245+p*(53-245))})`;
    ct.fillRect(i*bw*1.15,H-h,bw,h);
  }
}
drawViz();

const peqC=document.getElementById('peq');
function resizePeqC(){peqC.width=peqC.offsetWidth;peqC.height=120;drawPeq();}
setTimeout(resizePeqC,100);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRAG & DROP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doDragOver(e){e.preventDefault();document.getElementById('dropZ').classList.add('drag');}
function doDragLeave(){document.getElementById('dropZ').classList.remove('drag');}
function doDrop(e){e.preventDefault();doDragLeave();addFiles(Array.from(e.dataTransfer.files).filter(f=>AUDIO_EXTS.test(f.name)||f.type.startsWith('audio/')));}
document.body.addEventListener('dragover',e=>{if(e.dataTransfer.types.includes('Files'))e.preventDefault();});
document.body.addEventListener('drop',e=>{
  const f=Array.from(e.dataTransfer.files).filter(f=>AUDIO_EXTS.test(f.name)||f.type.startsWith('audio/'));
  if(f.length){e.preventDefault();addFiles(f);}
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function msToTime(ms){const s=Math.floor(ms/1000);return Math.floor(s/60)+':'+String(s%60).padStart(2,'0');}
function secToTime(s){return Math.floor(s/60)+':'+String(s%60).padStart(2,'0');}
function escHtml(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function loadScript(src){return new Promise((res,rej)=>{const s=document.createElement('script');s.src=src;s.onload=res;s.onerror=()=>rej(new Error('Failed: '+src));document.head.appendChild(s);});}
function updateSrcBadge(txt){
  const b=document.getElementById('srcBadge');
  b.textContent=txt;
  const colors={SPOTIFY:'#1db954',DEEZER:'#ef5466',TIDAL:'#00ffff','APPLE MUSIC':'#fc3c44','YOUTUBE':'#ff0000',LOCAL:'var(--border)'};
  const c=colors[txt]||'var(--border)';
  b.style.borderColor=c; b.style.color=txt==='LOCAL'?'var(--sub)':c;
  b.style.background=txt==='LOCAL'?'rgba(255,255,255,.02)':`color-mix(in srgb,${c} 12%,transparent)`;
  document.getElementById('bSrc').textContent=txt;
  document.getElementById('bSrc').className='tbadge '+(txt==='LOCAL'?'off':'on-a');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OAUTH CALLBACK HANDLER â€” runs on every page load
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(async()=>{
  try{
    const p=new URLSearchParams(location.search);
    const state=p.get('state');
    if(state==='spotify_auth') await spotifyOAuthCallback();
    else if(state==='tidal_auth') await tidalOAuthCallback();
    else if(state==='youtube_auth') await youtubeOAuthCallback();
  }catch(e){console.error('OAuth callback error:',e);}
})();

function onBrightness(el){
  const v=+el.value;
  document.getElementById('brightV').textContent=v;
  applyVisualFilters();
}
function onClarity(el){
  const v=+el.value;
  document.getElementById('clarityV').textContent=v;
  applyVisualFilters();
}
function applyVisualFilters(){
  const b=+document.getElementById('brightSl').value;
  const c=+document.getElementById('claritySl').value;
  // Brightness: 0â†’0.3, 10â†’1.0, 20â†’2.0
  const brightness=(0.3+b/20*1.7).toFixed(3);
  // Clarity = midtone contrast punch + saturation crispness + subtle sharpness via drop-shadow
  // contrast: 0â†’0.85, 10â†’1.0, 20â†’1.35  |  saturate: 0â†’0.7, 10â†’1.0, 20â†’1.5
  const contrast=(0.85+c/20*0.5).toFixed(3);
  const saturate=(0.7+c/20*0.8).toFixed(3);
  // drop-shadow with 0 offset = edge definition boost (perceived sharpness)
  const blur=Math.max(0,(10-c)*0.04).toFixed(2); // slight deblur as clarity rises
  document.body.style.filter=
    `brightness(${brightness}) contrast(${contrast}) saturate(${saturate}) blur(${blur}px)`;
}

// Init UI
document.getElementById('styleInt').style.setProperty('--p','50%');
document.getElementById('nrAmt').style.setProperty('--p','50%');
document.getElementById('boostSl').style.setProperty('--p','50%');
document.getElementById('surRoom').style.setProperty('--p',(8/20*100)+'%');
document.getElementById('surWidth').style.setProperty('--p',(12/20*100)+'%');
renderPeqUI();
</script>
</body>
</html>